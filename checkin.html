<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>慧伴管家 - 天天有奖</title>
    
    <script async defer 
        data-website-id="7b5c80e8-218d-4850-a9f3-d3764a059fed" 
        src="https://umami.example.com/script.js" 
        data-do-not-track="true" 
        data-domains="1111gary.github.io"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="慧伴管家">
    <link rel="apple-touch-icon" href="./assets/icon_apple.png">
    
    <style>
        /* Cyber Neon Theme (Checkin) */
        :root {
            --color-bg-dark: #0B1120; 
            --color-card-bg: #1E293B; 
            --color-text-light: #F1F5F9;
            --color-text-muted: #94A3B8;
            --color-primary: #10B981; 
            --color-highlight: #FACC15; 
            --color-success: #10B981; 
            --color-special-note: #F59E0B; 
            --color-premium-border: linear-gradient(135deg, #10B981, #FACC15);

            --grad-checkin-1: linear-gradient(135deg, #10B981, #34D399); 
            --color-checkin-1: #10B981; 
            --grad-checkin-2: linear-gradient(135deg, #EC4899, #F472B6); 
            --color-checkin-2: #EC4899; 
        }

        body { 
            background-color: var(--color-bg-dark); 
            color: var(--color-text-light); 
            padding-bottom: calc(85px + env(safe-area-inset-bottom)); 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        .header-bar-fixed { 
            padding-top: calc(15px + env(safe-area-inset-top)); 
            padding-bottom: 5px; 
            background-color: rgba(11, 17, 32, 0.95);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .header-logo-group { display: flex; align-items: center; }
        .header-logo { width: 32px; height: 32px; margin-right: 10px; }
        .header-title { font-size: 1.2rem; font-weight: 700; color: var(--color-text-light); }
        .back-arrow-link {
            color: var(--color-text-light);
            font-size: 1.2rem;
            padding: 8px 12px;
            border-radius: 12px;
            background-color: rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        
        .main-banner-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 24px;
            padding: 30px 20px;
            text-align: center;
            border: 2px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            border-image: linear-gradient(to right, var(--color-checkin-1), var(--color-highlight));
            border-image-slice: 1;
            box-shadow: 0 10px 30px -10px rgba(16, 185, 129, 0.3);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .main-banner-card h1 {
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(to right, #fff, #d1fae5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .main-banner-card p { color: var(--color-text-muted); font-size: 0.95rem; margin-top: 8px;}
        
        /* 状态筛选器 */
        .status-filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px; 
            margin-top: 1rem; 
            margin-bottom: 2rem; 
            background-color: #1E293B; 
            border-radius: 100px;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255,255,255,0.05);
            position: sticky;
            top: 65px; 
            z-index: 15;
        }
        .status-button {
            flex: 1; 
            text-align: center;
            padding: 10px 0;
            border-radius: 100px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-muted); 
            background-color: transparent; 
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .status-button.active {
            color: white; 
            background: var(--color-primary);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .section-title-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
            padding: 12px 0;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .section-title-card h2 {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--color-text-light);
            padding-left: 15px;
        }
        .section-description { color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem; padding-left: 5px; }

        .task-list-card {
            background-color: #1E293B;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid; 
            position: relative;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .task-checkin-1 { border-left-color: var(--color-checkin-1); } 
        .task-checkin-2 { border-left-color: var(--color-checkin-2); } 
        
        .task-icon {
            width: 44px; height: 44px; border-radius: 12px; color: #fff; 
            font-size: 1.3rem; display: flex; align-items: center; justify-content: center;
            margin-right: 16px; flex-shrink: 0;
        }
        .icon-checkin-1 { background: var(--grad-checkin-1); }
        .icon-checkin-2 { background: var(--grad-checkin-2); }
        
        .task-main-content { display: flex; align-items: center; width: 100%; }
        .task-content { flex-grow: 1; min-width: 0; }
        .task-title {
            font-size: 1.05rem; font-weight: 700; color: var(--color-text-light);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 90px; 
        }
        .task-subtitle {
            font-size: 0.85rem; color: var(--color-text-muted);
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        
        .special-note-badge {
            position: absolute; top: 15px; right: 15px;
            background: linear-gradient(135deg, #F59E0B, #FBBF24);
            color: #000; padding: 4px 10px; border-radius: 8px;
            font-size: 0.75rem; font-weight: 800; z-index: 5;
        }
        .countdown-badge {
            position: absolute; top: 0; right: 0;
            background-color: #334155; color: #94A3B8;
            padding: 4px 12px; border-top-right-radius: 15px; border-bottom-left-radius: 12px;
            font-size: 0.7rem; font-weight: 700; z-index: 4;
        }
        .special-note-badge + .countdown-badge { top: 42px; right: 15px; border-radius: 6px; }
        
        .task-action-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05);
        }
        .share-button {
            background: transparent; color: var(--color-text-muted);
            border: 1px solid rgba(255,255,255,0.1); font-weight: 600;
            padding: 6px 14px; border-radius: 9999px; font-size: 0.8rem;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .action-button {
            background: var(--color-primary); color: #000; font-weight: 700;
            padding: 8px 20px; border-radius: 9999px; font-size: 0.85rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.4);
        }
        .action-button-voice { background: #38BDF8; box-shadow: 0 0 12px rgba(56, 189, 248, 0.4); color: #000; }
        .action-button-voice.speaking { 
            background: #EF4444; color: #fff;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; justify-content: space-around; align-items: center;
            height: 65px;
            background-color: rgba(11, 17, 32, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 20;
        }
        .tab-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: var(--color-text-muted);
            font-size: 0.7rem; font-weight: 500; padding: 5px; flex-grow: 1;
        }
        .tab-item.active { color: var(--color-primary); }
        .tab-icon { font-size: 1.3rem; margin-bottom: 4px; }
        
        .premium-card {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 20px; padding: 25px 20px; text-align: center;
            border: 2px solid transparent; 
            background-clip: padding-box, border-box; background-origin: padding-box, border-box;
            border-image: var(--color-premium-border); border-image-slice: 1;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); margin-top: 3rem; margin-bottom: 1rem;
        }
        .premium-card h2 {
            font-size: 1.3rem; font-weight: 800;
            background: var(--color-premium-border);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0;
        }
        .premium-card p { color: var(--color-text-muted); font-size: 0.9rem; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header-bar-fixed px-4">
        <div class="header-logo-group">
            <img src="./assets/icon_apple.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/00BFFF/ffffff?text=L'" alt="Logo" class="header-logo rounded-md shadow-lg">
            <h1 class="header-title">慧伴管家</h1>
        </div>
        <a href="./index.html" class="back-arrow-link"><i class="fas fa-arrow-left"></i></a>
    </div>

    <main class="container mx-auto px-4 py-4">
        <div class="main-banner-card">
            <h1>天天有奖 (CheckIn)</h1>
            <p>每日签到，领取您的专属奖励</p>
        </div>
        
        <div class="status-filter-container" id="status-filter-container">
            <button class="status-button active" data-status="Active"><i class="fas fa-fire-alt"></i> 正在进行</button>
            <button class="status-button" data-status="Upcoming"><i class="fas fa-hourglass-start"></i> 即将开始</button>
            <button class="status-button" data-status="Expired"><i class="fas fa-history"></i> 已结束</button>
        </div>
        
        <div class="section-title-card">
            <h2><i class="fas fa-calendar-check mr-3 text-xl" style="color: var(--color-checkin-1);"></i> 日常签到 (DailyCheckin)</h2>
        </div>
        <p class="section-description">各大App的每日打卡福利，积少成多，养成好习惯。</p>
        <div id="daily-checkin-list" class="mt-4"></div>

        <div class="section-title-card">
            <h2><i class="fas fa-stopwatch mr-3 text-xl" style="color: var(--color-checkin-2);"></i> 整点抢红包 (Voucher)</h2>
        </div>
        <p class="section-description">限时限量的红包雨和神券，定好闹钟，手慢无！</p>
        <div id="voucher-list" class="mt-4"></div>

        <a href="./premium.html" class="premium-card" onclick="umami.track('click_premium_card', { from: 'checkin' })">
            <h2><i class="fas fa-crown mr-2"></i> 高级会员专区 (敬请期待)</h2>
            <p>AI自动提醒抢红包，成功率提升300%！</p>
        </a>
    </main>
    
    <nav class="tab-bar">
        <a href="./index.html" class="tab-item"><i class="fas fa-home tab-icon"></i><span>首页</span></a>
        <span class="tab-item active"><i class="fas fa-gifts tab-icon"></i><span>天天有奖</span></span>
        <a href="./video.html" class="tab-item"><i class="fas fa-play-circle tab-icon"></i><span>看视频赚</span></a>
        <a href="./bank.html" class="tab-item"><i class="fas fa-hand-holding-usd tab-icon"></i><span>捡钱任务</span></a>
        <a href="./shopping.html" class="tab-item"><i class="fas fa-tags tab-icon"></i><span>省钱秘籍</span></a>
    </nav>
    
    <script>
        let ALL_CHECKIN_ACTIVITIES = [];
        let globalStatus = 'Active'; 
        const CATEGORY_MAP = {
            'DailyCheckin': { borderClass: 'task-checkin-1', iconClass: 'icon-checkin-1', faIcon: 'fa-calendar-check' },
            'Voucher': { borderClass: 'task-checkin-2', iconClass: 'icon-checkin-2', faIcon: 'fa-stopwatch' }
        };
        const synth = window.speechSynthesis;
        let currentUtterance = null; 
        let speakingButton = null; 

        document.addEventListener('DOMContentLoaded', () => {
            try { if(synth && synth.getVoices().length === 0) { synth.onvoiceschanged = () => { synth.getVoices(); }; synth.getVoices(); } } catch(e) {}
            loadAndFetchActivities();
            startCountdownUpdater();
            bindStatusFilters();
        });

        async function loadAndFetchActivities() {
            try {
                const response = await fetch('./activities.json');
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                ALL_CHECKIN_ACTIVITIES = data.filter(act => act.category && (act.category.includes('DailyCheckin') || act.category.includes('Voucher')));
                renderActivities();
            } catch (error) {
                const msg = `<p class="text-red-400 p-4 text-center">加载活动数据失败。请检查 activities.json。</p>`;
                document.getElementById('daily-checkin-list').innerHTML = msg;
                document.getElementById('voucher-list').innerHTML = msg;
            }
        }

        function bindStatusFilters() {
            const container = document.getElementById('status-filter-container');
            container.querySelectorAll('.status-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    globalStatus = btn.getAttribute('data-status');
                    container.querySelectorAll('.status-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    stopSpeech();
                    renderActivities();
                });
            });
        }

        function getActivityStatus(activity) {
            if (!activity.endDate) return 'Active'; 
            const now = new Date().getTime();
            const startDate = activity.startDate ? new Date(activity.startDate).getTime() : now - 1000; 
            const endDate = new Date(activity.endDate).getTime();
            if (now < startDate) return 'Upcoming'; 
            if (now > endDate) return 'Expired'; 
            return 'Active'; 
        }

        function renderActivities() {
            const lists = { 'DailyCheckin': document.getElementById('daily-checkin-list'), 'Voucher': document.getElementById('voucher-list') };
            Object.keys(lists).forEach(category => {
                const listElement = lists[category];
                if (!listElement) return;
                listElement.innerHTML = ''; 
                let hasActivities = false;
                const categoryActivities = ALL_CHECKIN_ACTIVITIES.filter(activity => activity.category && activity.category.includes(category));
                categoryActivities.forEach(activity => {
                    const status = getActivityStatus(activity);
                    if (globalStatus === status) {
                        hasActivities = true;
                        listElement.innerHTML += renderActivityCard(activity, category, status);
                    }
                });
                if (!hasActivities) {
                    const statusText = globalStatus === 'Active' ? '正在进行' : globalStatus === 'Upcoming' ? '即将开始' : '已结束';
                    listElement.innerHTML = `<p class="text-gray-400 text-center p-4 text-sm">该分类下没有 [${statusText}] 的活动。</p>`;
                }
            });
            bindActionButtons();
            updateCountdowns();
        }

        function renderActivityCard(activity, styleKey, status) {
            const styles = CATEGORY_MAP[styleKey];
            let actionButtonHtml = '';
            const isExpired = status === 'Expired';
            
            if (activity.link && activity.link !== '#') {
                actionButtonHtml = `<a href="${activity.link}" target="_blank" class="action-button ${isExpired?'opacity-50 cursor-not-allowed':''}" ${isExpired?'onclick="event.preventDefault()"':''}><i class="fas fa-rocket"></i> 去签到</a>`;
            } else if (activity.StepsText) {
                const steps = activity.StepsText.replace(/"/g, '&quot;');
                actionButtonHtml = `<button class="action-button action-button-voice ${isExpired?'opacity-50 cursor-not-allowed':''}" data-steps="${steps}" data-activity-name="${activity.name}" ${isExpired?'disabled':''}><i class="fas fa-volume-high"></i> 播放语音</button>`;
            } else {
                actionButtonHtml = `<button class="action-button opacity-50" disabled><i class="fas fa-info-circle"></i> 暂无指引</button>`;
            }
            
            let note = activity.specialNote ? `<span class="special-note-badge"><i class="fas fa-bell"></i> ${activity.specialNote}</span>` : '';
            let countdown = '';
            let mod = '';
            if (status === 'Upcoming') {
                mod = 'opacity-80';
                countdown = `<span class="countdown-badge" style="background-color:var(--color-checkin-2);color:white;">${activity.startDate ? `<span id="timer-${activity.id}">计算中...</span>` : '即将开始'}</span>`;
            } else if (status === 'Expired') {
                mod = 'opacity-50 grayscale';
                countdown = `<span class="countdown-badge" style="background-color:#334155;color:#94A3B8;">已结束</span>`;
            } else {
                countdown = `<span class="countdown-badge" data-endtime="${activity.endDate}" id="timer-${activity.id}">${activity.endDate ? '计算中...' : '长期有效'}</span>`;
            }

            return `<div class="task-list-card ${styles.borderClass} ${activity.specialNote?'has-special-note':''} ${mod}">
                ${note} ${countdown}
                <div class="task-main-content">
                    <div class="task-icon ${styles.iconClass}"><i class="fa-solid ${styles.faIcon}"></i></div>
                    <div class="task-content">
                        <div class="task-title">${activity.name}</div>
                        <div class="task-subtitle">${activity.description || '暂无描述'}</div>
                    </div>
                </div>
                <div class="task-action-bar">
                    <button class="share-button" data-activity-id="${activity.id}"><i class="fas fa-share-alt"></i> 分享</button>
                    ${actionButtonHtml}
                </div>
            </div>`;
        }

        function bindActionButtons() {
            document.querySelectorAll('.action-button-voice').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const b = e.currentTarget;
                    if(b.disabled) return;
                    toggleSpeech(b, b.getAttribute('data-steps'), b.getAttribute('data-activity-name'));
                });
            });
            document.querySelectorAll('.share-button').forEach(btn => {
                btn.addEventListener('click', (e) => shareActivity(e.currentTarget.getAttribute('data-activity-id'), e.currentTarget));
            });
        }
        
        // [关键修复] 统一使用 Shopping 页面的强壮语音逻辑
        function stopSpeech() {
            if (synth.speaking) { synth.cancel(); }
            if (speakingButton) {
                speakingButton.innerHTML = `<i class="fas fa-volume-high"></i> 播放语音`;
                speakingButton.classList.remove('speaking');
                speakingButton = null;
            }
            currentUtterance = null;
        }

        function toggleSpeech(button, text, activityName) {
            if (!synth) return;
            if (button.classList.contains('speaking')) {
                stopSpeech();
                return;
            }
            stopSpeech(); 
            const voice = synth.getVoices().find(v => v.lang.startsWith('zh')) || synth.getVoices()[0];
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.voice = voice;
            currentUtterance.rate = 0.75; // [统一配置] 0.75 语速
            
            currentUtterance.onstart = () => {
                speakingButton = button;
                button.classList.add('speaking');
                button.innerHTML = `<i class="fas fa-wave-square"></i> 停止`;
            };
            currentUtterance.onend = () => { stopSpeech(); };
            currentUtterance.onerror = (e) => { console.error("语音错误", e); stopSpeech(); };
            synth.speak(currentUtterance);
        }

        function shareActivity(id, btn) {
            const url = `${window.location.origin}${window.location.pathname.replace('checkin.html', 'go.html')}?id=${id}`;
            try {
                const t = document.createElement('textarea'); t.value = url; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t);
                const old = btn.innerHTML; btn.innerHTML = `<i class="fas fa-check"></i> 已复制`; setTimeout(() => btn.innerHTML = old, 2000);
            } catch (e) { alert(`请手动复制:\n${url}`); }
        }

        function formatTime(ms) {
            if (ms<=0) return '已结束';
            const s=Math.floor(ms/1000), d=Math.floor(s/86400), h=Math.floor((s%86400)/3600), m=Math.floor((s%3600)/60);
            return d>0 ? `${d}天${h}时` : `${h}时${m}分`;
        }

        function updateCountdowns() {
            const now = new Date().getTime();
            document.querySelectorAll('.countdown-badge').forEach(timer => {
                if (timer.parentElement.classList.contains('opacity-80')) { // Upcoming
                    const idMatch = timer.innerHTML.match(/timer-(\d+)/);
                    if (idMatch) {
                        const act = ALL_CHECKIN_ACTIVITIES.find(a => a.id == idMatch[1]);
                        if (act && act.startDate) {
                             const diff = new Date(act.startDate).getTime() - now;
                             const span = document.getElementById(`timer-${act.id}`);
                             if(span) span.innerText = diff > 0 ? formatTime(diff) : "进行中";
                             if(diff <= 0) renderActivities(); 
                        }
                    }
                    return;
                }
                // Active
                const endStr = timer.getAttribute('data-endtime');
                if (!endStr || endStr==='null') { timer.innerText = '长期有效'; return; }
                const diff = new Date(endStr).getTime() - now;
                if (diff <= 0) { timer.innerText = '已结束'; } else { timer.innerText = `剩余 ${formatTime(diff)}`; }
            });
        }
        function startCountdownUpdater() { updateCountdowns(); setInterval(updateCountdowns, 1000); }
    </script>
</body>
</html>
