<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NEX AI - æ¡é’±ä»»åŠ¡</title>
    <script async defer src="https://umami.example.com/script.js" data-website-id="7b5c80e8-218d-4850-a9f3-d3764a059fed" data-do-not-track="true" data-domains="1111gary.github.io"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./assets/icon_apple.svg">
    <style>
        :root {
            --bg-dark: #0B1120; --card-bg: #1E293B; --text-main: #F8FAFC; --text-sub: #94A3B8;
            --primary: #3B82F6; --accent: #FBBF24;
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; padding-top: 110px; padding-bottom: 90px; }

        /* Toast æ ·å¼ (å¼ºåˆ¶è¦†ç›–) */
        #toast-box {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: rgba(0,0,0,0.9); color: white; padding: 20px 30px; border-radius: 16px;
            z-index: 10000; text-align: center; pointer-events: none; opacity: 0; transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.1); min-width: 220px; display: none;
        }
        #toast-box.show { opacity: 1; transform: translate(-50%, -50%) scale(1); display: block; }

        /* é¡¶éƒ¨å¯¼èˆªåŠ¨ç”» */
        #smart-header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(11, 17, 32, 0.95); backdrop-filter: blur(16px); transition: transform 0.3s ease; padding-top: env(safe-area-inset-top); }
        .nav-hidden { transform: translateY(-100%); }

        /* å…¶ä»–åŸæœ‰æ ·å¼ä¿æŒç®€åŒ– */
        .app-logo { width: 32px; height: 32px; border-radius: 8px; margin-right: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .page-title { font-size: 1.2rem; font-weight: 800; color: #fff; }
        .filter-bar { display: flex; gap: 10px; overflow-x: auto; padding: 12px 16px; scrollbar-width: none; }
        .chip { display: inline-flex; align-items: center; height: 34px; padding: 0 16px; border-radius: 999px; font-size: 0.85rem; background: rgba(255,255,255,0.05); color: var(--text-sub); flex-shrink: 0; }
        .chip.active { background: var(--primary); color: #fff; }
        .sidebar-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 90; display: none; }
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: #0f172a; z-index: 100; transform: translateX(-100%); transition: 0.3s; padding-top: env(safe-area-inset-top); }
        .sidebar-open .sidebar-mask { display: block; } .sidebar-open .sidebar { transform: translateX(0); }
        .task-card { background: #1E293B; border-radius: 16px; padding: 16px; margin: 0 1rem 1rem; border: 1px solid rgba(255,255,255,0.05); position: relative; border-left: 4px solid var(--primary); }
        .badges { position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; }
        .badge-timer { background: #EC4899; color: #fff; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; }
        .badge-note { background: linear-gradient(90deg, #F59E0B, #FBBF24); color: #000; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .card-main { display: flex; align-items: center; margin-top: 12px; }
        .card-icon { width: 48px; height: 48px; border-radius: 12px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; margin-right: 14px; flex-shrink: 0; }
        .card-text { flex: 1; min-width: 0; }
        .card-title { font-size: 1.05rem; font-weight: 700; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-desc { font-size: 0.85rem; color: #94A3B8; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 6px 16px; border-radius: 999px; font-size: 0.8rem; font-weight: 700; transition: 0.2s; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #2563EB); color: #fff; }
        .btn-share { background: rgba(59, 130, 246, 0.15); color: #60A5FA; }
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 65px; background: rgba(11,17,32,0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-around; align-items: center; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 3px; color: #64748B; font-size: 0.7rem; }
        .nav-item.active { color: var(--primary); }
        .sidebar-item { padding: 15px 20px; color: white; display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>
    <div class="sidebar-mask" onclick="toggleSidebar()"></div>
    <div class="sidebar">
        <div style="padding:20px;font-size:1.2rem;font-weight:bold;color:white;border-bottom:1px solid #333;">æ…§ä¼´ç®¡å®¶</div>
        <div id="sidebar-content" class="flex-1 overflow-y-auto py-2"></div>
    </div>

    <header id="smart-header">
        <div class="header-top">
            <div class="flex items-center">
                <img src="./assets/icon_apple.svg" onerror="this.src='https://placehold.co/32x32/3B82F6/ffffff?text=B'" class="app-logo">
                <span class="page-title">æ¡é’±ä»»åŠ¡</span>
            </div>
            <a href="./index.html" class="text-gray-300 text-xl px-2"><i class="fas fa-arrow-left"></i></a>
        </div>
        <div class="filter-bar" id="filter-bar"></div>
    </header>

    <main>
        <div class="section-title-card"><h2 class="section-title-h2"><i class="fas fa-calendar-day text-green-400 mr-2"></i> æ—¥å¸¸æ´»åŠ¨</h2></div><div id="routine-tasks-list"></div>
        <div class="section-title-card"><h2 class="section-title-h2"><i class="fas fa-tasks text-pink-400 mr-2"></i> åšä»»åŠ¡é¢†çº¢åŒ…</h2></div><div id="mission-rewards-list"></div>
        <div class="section-title-card"><h2 class="section-title-h2"><i class="fas fa-sack-dollar text-yellow-400 mr-2"></i> å­˜æ¬¾ç†è´¢</h2></div><div id="savings-tasks-list"></div>
        
        <a href="./premium.html" class="premium-card" style="display:block;margin:2rem 1rem;padding:24px;border-radius:20px;background:linear-gradient(135deg,#1e293b,#0f172a);border:1px solid rgba(255,255,255,0.05);text-align:center;">
            <div class="premium-title" style="font-size:1.2rem;font-weight:800;color:#FACC15"><i class="fas fa-crown"></i> é«˜çº§ä¼šå‘˜ä¸“åŒº</div>
            <div class="premium-desc" style="color:#94A3B8;font-size:0.85rem;margin-top:8px">AI è‡ªåŠ¨æé†’ â€¢ æ”¶ç›Šæœ€å¤§åŒ–åŠ©æ‰‹</div>
        </a>
    </main>
    
    <nav class="nav-bar">
        <a href="./index.html" class="nav-item"><i class="fas fa-home"></i>é¦–é¡µ</a>
        <a href="./checkin.html" class="nav-item"><i class="fas fa-gifts"></i>å¤©å¤©æœ‰å¥–</a>
        <a href="./video.html" class="nav-item"><i class="fas fa-play-circle"></i>çœ‹è§†é¢‘èµš</a>
        <span class="nav-item active"><i class="fas fa-hand-holding-usd"></i>æ¡é’±ä»»åŠ¡</span>
        <a href="./shopping.html" class="nav-item"><i class="fas fa-tags"></i>çœé’±ç§˜ç±</a>
    </nav>
    
    <!-- ç‹¬ç«‹çš„ Toast ç»“æ„ -->
    <div id="toast-box">
        <div style="font-size: 2rem; margin-bottom: 10px; color: #4ade80;"><i class="fas fa-check-circle"></i></div>
        <div id="toast-text" style="font-size: 1rem; line-height: 1.5;">æ“ä½œæˆåŠŸ</div>
    </div>

    <script>
        let ALL=[], selBank='All', selStatus='ongoing';
        const CAT_MAP={'DailyTask':{icon:'fa-calendar-day',color:'#10B981'},'MissionReward':{icon:'fa-tasks',color:'#EC4899'},'Deposit':{icon:'fa-sack-dollar',color:'#FBBF24'}};
        
        // æ»šåŠ¨é€»è¾‘
        let lastY=0; const h=document.getElementById('smart-header');
        window.addEventListener('scroll', ()=>{const y=window.scrollY; if(Math.abs(y-lastY)<10)return; if(h.style.transition!=='none')h.classList.toggle('nav-hidden', y>lastY&&y>60); lastY=y; sessionStorage.setItem('pos_bank', y); sessionStorage.setItem('nav_bank', h.classList.contains('nav-hidden'));}, {passive:true});
        if('scrollRestoration' in history) history.scrollRestoration='manual';

        document.addEventListener('DOMContentLoaded', () => {
            fetch('./activities.json').then(r=>r.json()).then(d => {
                ALL=d.filter(a=>a.category&&(a.category.includes('DailyTask')||a.category.includes('Deposit')||a.category.includes('MissionReward')));
                initUI(); render(); setInterval(updTm, 1000);
                const y=sessionStorage.getItem('pos_bank'); if(y) setTimeout(()=>window.scrollTo(0,parseInt(y)),50);
            });
        });

        // ==========================================
        // æ ¸å¿ƒä¿®å¤ï¼šé»‘åå•å¼ºåˆ¶æ‹¦æˆªæ¨¡å¼
        // ==========================================
        function handleSmartJump(link, name) {
            if (!link || link === '#') return;

            // å»é™¤ç©ºæ ¼ï¼Œè½¬å°å†™
            const lower = link.toLowerCase().trim();

            // ã€é»‘åå•åˆ—è¡¨ã€‘åªè¦é“¾æ¥åŒ…å«è¿™äº›å­—ç¬¦ï¼Œå¿…é¡»æ‹¦æˆªï¼
            // è¿™é‡Œä¸“é—¨é’ˆå¯¹ä½ æä¾›çš„ å†œè¡Œ(wx.abchina)ã€å·¥è¡Œ(wbs.icbc)ã€å°ç¨‹åº(#) åšäº†å¼ºåŒ–
            const blockList = [
                '#',                // æ‰€æœ‰ # å¼€å¤´çš„ï¼ˆå°ç¨‹åºï¼‰
                'å°ç¨‹åº',            // ä¸­æ–‡å…³é”®å­—
                'miniprogram',      // è‹±æ–‡å…³é”®å­—
                'micromessenger',   // å¾®ä¿¡
                'weixin://',        // å¾®ä¿¡åè®®
                'wx.abchina.com',   // ğŸ”´ å†œè¡Œå¾®ä¿¡ç«¯
                'abchina',          // å†œè¡Œé€šç”¨
                'wbs.icbc',         // ğŸ”´ å·¥è¡Œ WBS ç«¯
                'icbc.com',         // å·¥è¡Œé€šç”¨
                '95516',            // äº‘é—ªä»˜
                'benefits',         // äº‘é—ªä»˜æ´»åŠ¨
                'cmbchina',         // æ‹›è¡Œ
                'ccb.com',          // å»ºè¡Œ
                'boc.cn',           // ä¸­è¡Œ
                'mbank'             // è®¸å¤šé“¶è¡Œæ‰‹æœºç«¯é€šç”¨å‰ç¼€
            ];

            // æ£€æµ‹æ˜¯å¦å‘½ä¸­é»‘åå•
            // some() æ–¹æ³•ï¼šåªè¦æ»¡è¶³å…¶ä¸­ä¸€ä¸ªæ¡ä»¶ï¼Œå°±è¿”å› true
            const isBlocked = blockList.some(keyword => lower.includes(keyword));

            if (isBlocked) {
                // å‘½ä¸­é»‘åå• -> å¼ºåˆ¶å¤åˆ¶
                doCopy(link, lower);
            } else {
                // æœªå‘½ä¸­ -> å°è¯•ç›´æ¥è·³è½¬ (æ™®é€šç½‘é¡µ)
                window.open(link, '_blank');
            }
            
            if (window.umami) umami.track('click_action', { name: name, type: isBlocked ? 'copy' : 'jump' });
        }

        function doCopy(text, lowerLink) {
            // 1. æ™ºèƒ½è¯†åˆ« App åç§°ï¼Œç”¨äºæç¤ºè¯­
            let appName = 'å¾®ä¿¡'; // é»˜è®¤æç¤ºå¾®ä¿¡
            if (lowerLink.includes('icbc')) appName = 'å·¥è¡ŒApp';
            else if (lowerLink.includes('abchina')) appName = 'å†œè¡ŒApp';
            else if (lowerLink.includes('cmbchina')) appName = 'æ‹›è¡ŒApp';
            else if (lowerLink.includes('ccb')) appName = 'å»ºè¡ŒApp';
            else if (lowerLink.includes('boc')) appName = 'ä¸­è¡ŒApp';
            else if (lowerLink.includes('95516') || lowerLink.includes('benefits')) appName = 'äº‘é—ªä»˜App';

            // 2. æ‰§è¡Œå¤åˆ¶é€»è¾‘ (å…¼å®¹æ—§æµè§ˆå™¨)
            const textArea = document.createElement("textarea");
            textArea.value = text;
            
            // ç¡®ä¿ textarea ä¸å¯è§ä½†å­˜åœ¨äº DOM ä¸­
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            
            textArea.focus();
            textArea.select();
            
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMyToast(`é“¾æ¥å·²å¤åˆ¶ï¼\nè¯·æ‰“å¼€ã€${appName}ã€‘ç²˜è´´è®¿é—®`);
                } else {
                    // æå°‘æ•°æƒ…å†µå¤åˆ¶å¤±è´¥ï¼Œå¼¹çª—è®©ç”¨æˆ·é•¿æŒ‰
                    prompt(`è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·å…¨é€‰å¤åˆ¶ä¸‹æ–¹é“¾æ¥ï¼š`, text);
                }
            } catch (err) {
                prompt(`è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·å…¨é€‰å¤åˆ¶ä¸‹æ–¹é“¾æ¥ï¼š`, text);
            }
            
            // æ¸…ç† DOM
            document.body.removeChild(textArea);
        }

        function handleShare(id, name) {
            const act = ALL.find(a => a.id === id);
            if (!act) return;
            
            const platform = act.sourceApp || 'ç²¾é€‰æ´»åŠ¨';
            const shareText = `ã€${platform}ã€‘${act.name}\n${act.description||'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…'}\nä¼ é€é—¨ï¼š${act.link}`;
            
            // åˆ†äº«å‰å…ˆè‡ªåŠ¨å¤åˆ¶ä¸€éï¼Œé˜²æ­¢å¾®ä¿¡ä¸æ˜¾ç¤ºæè¿°
            doCopy(shareText, '');

            if (navigator.share) {
                navigator.share({ title: 'æ…§ä¼´ç®¡å®¶', text: shareText, url: act.link })
                    .then(()=> showMyToast('æ–‡æ¡ˆå·²å¤åˆ¶\nè¯·é€‰æ‹©å¥½å‹å‘é€'))
                    .catch(()=> showMyToast('æ–‡æ¡ˆå·²å¤åˆ¶\nè¯·å»å¾®ä¿¡ç²˜è´´ç»™å¥½å‹'));
            } else {
                showMyToast('æ–‡æ¡ˆå·²å¤åˆ¶\nè¯·å»å¾®ä¿¡ç²˜è´´ç»™å¥½å‹');
            }
            
            if (window.umami) umami.track('click_share', { name: name });
        }

        // è‡ªå®šä¹‰ Toast (ç¡®ä¿æ ·å¼æ­£ç¡®)
        function showMyToast(msg) {
            const box = document.getElementById('toast-box');
            const txt = document.getElementById('toast-text');
            if(!box || !txt) return; // é˜²æ­¢æŠ¥é”™

            txt.innerText = msg;
            
            box.classList.add('show');
            
            // 3ç§’åéšè—
            setTimeout(() => {
                box.classList.remove('show');
            }, 3000);
        }

        // UI æ¸²æŸ“
        function initUI() {
            const bar=document.getElementById('filter-bar');
            bar.innerHTML = `<button class="chip chip-trigger ${selBank==='All'?'active':''}" onclick="toggleSidebar()"><i class="fas fa-layer-group mr-2"></i> ${selBank==='All'?'å…¨éƒ¨å¹³å°':selBank}</button>`;
            const sts=[{v:'ongoing',t:'è¿›è¡Œä¸­'},{v:'upcoming',t:'å³å°†å¼€å§‹'},{v:'finished',t:'å·²ç»“æŸ'}];
            sts.forEach(s=>bar.innerHTML+=`<button class="chip ${selStatus===s.v?'active':''}" onclick="setSt('${s.v}')">${s.t}</button>`);
            const sb=document.getElementById('sidebar-content'); const ps=new Set(); ALL.forEach(a=>ps.add(a.sourceApp));
            let html = `<div class="sidebar-item" onclick="setBk('All')"><div class="sidebar-icon-box"><i class="fas fa-border-all"></i></div> å…¨éƒ¨å¹³å°</div>`;
            ps.forEach(p=>{if(p)html+=`<div class="sidebar-item" onclick="setBk('${p}')"><div class="sidebar-icon-box"><i class="fas fa-mobile-alt"></i></div> ${p}</div>`});
            sb.innerHTML = html;
        }
        function toggleSidebar(){document.body.classList.toggle('sidebar-open');}
        function setSt(s){selStatus=s; initUI(); render();}
        function setBk(b){selBank=b; toggleSidebar(); initUI(); render();}
        function render() {
            const ls={'DailyTask':document.getElementById('routine-tasks-list'),'MissionReward':document.getElementById('mission-rewards-list'),'Deposit':document.getElementById('savings-tasks-list')};
            Object.values(ls).forEach(e=>e.innerHTML='');
            let hasItem=false;
            ALL.filter(act => {
                const now=Date.now(); const e=act.endDate?new Date(act.endDate).getTime():null, s=act.startDate?new Date(act.startDate).getTime():null;
                if(selStatus==='finished') return e && e<now;
                if(selStatus==='upcoming') return s && s>now;
                return (!s || s<=now) && (!e || e>=now);
            }).filter(a=>selBank==='All'||a.sourceApp===selBank).forEach(a=>{
                const cat=a.category.find(c=>CAT_MAP[c]); if(cat&&ls[cat]) { hasItem=true; ls[cat].innerHTML+=card(a,cat); }
            });
            if(!hasItem) document.getElementById('routine-tasks-list').innerHTML = `<p class="text-center text-gray-500 py-6 w-full">æš‚æ— æ´»åŠ¨</p>`;
            updTm();
        }

        function card(a, cat) {
            const s = CAT_MAP[cat];
            // å®‰å…¨å¤„ç†å•å¼•å·
            const safeLink = a.link ? a.link.replace(/'/g, "\\'") : '';
            const safeName = a.name ? a.name.replace(/'/g, "\\'") : '';
            const safeSteps = a.StepsText ? a.StepsText.replace(/"/g,'&quot;').replace(/'/g, "\\'") : '';

            let btn = a.link && a.link !== '#' 
                ? `<button onclick="handleSmartJump('${safeLink}', '${safeName}')" class="btn btn-primary">å»é¢†å– <i class="fas fa-chevron-right ml-1"></i></button>` 
                : (a.StepsText ? `<button class="btn btn-voice" onclick="spk('${safeSteps}', this)"><i class="fas fa-volume-up mr-1"></i> æ’­æ”¾</button>` : `<button class="btn" style="background:#333;color:#666;cursor:not-allowed">æš‚æ— </button>`);

            return `<div class="task-card" style="border-left-color:${s.color}">
                <div class="badges">
                    ${a.specialNote?`<span class="badge badge-note">${a.specialNote}</span>`:''}
                    <span class="badge badge-timer" data-e="${a.endDate}" data-s="${a.startDate}">...</span>
                </div>
                <div class="card-main">
                    <div class="card-icon" style="color:${s.color}"><i class="fas ${s.icon}"></i></div>
                    <div class="card-text">
                        <div class="card-title">${a.name}</div>
                        <div class="card-desc">${a.description||'æš‚æ— æè¿°'}</div>
                    </div>
                </div>
                <div class="card-actions">
                    <button class="btn btn-share" onclick="handleShare('${a.id}', '${safeName}')"><i class="fas fa-share-alt mr-1"></i> åˆ†äº«</button>
                    ${btn}
                </div>
            </div>`;
        }
        
        const synth=window.speechSynthesis;
        function spk(t, b){if(!synth)return; if(b.classList.contains('speaking')){synth.cancel();b.classList.remove('speaking');b.innerHTML=`<i class="fas fa-volume-up mr-1"></i> æ’­æ”¾`;return;}synth.cancel();const u=new SpeechSynthesisUtterance(t);u.lang='zh-CN';u.rate=0.75;u.onstart=()=>{b.classList.add('speaking');b.innerHTML=`<i class="fas fa-stop mr-1"></i> åœæ­¢`;};u.onend=()=>{b.classList.remove('speaking');b.innerHTML=`<i class="fas fa-volume-up mr-1"></i> æ’­æ”¾`;};synth.speak(u);}
        function updTm(){const n=Date.now();document.querySelectorAll('.badge-timer').forEach(e=>{const s=e.dataset.s?new Date(e.dataset.s).getTime():0, end=e.dataset.e?new Date(e.dataset.e).getTime():0;if(s>n){e.innerText=`å³å°†å¼€å§‹ ${fmt(s-n)}`;e.classList.remove('expired');}else if(end&&end<n){e.innerText='å·²ç»“æŸ';e.classList.add('expired');}else if(end){e.innerText=`å‰©ä½™ ${fmt(end-n)}`;e.classList.remove('expired');}else{e.innerText='é•¿æœŸ';e.classList.remove('expired');}});}
        function fmt(ms){const d=Math.floor(ms/86400000),h=Math.floor((ms%86400000)/3600000),m=Math.floor((ms%3600000)/60000);return d>0?`${d}å¤©${h}æ—¶`:`${h}æ—¶${m}åˆ†`;}
    </script>
</body>
</html>