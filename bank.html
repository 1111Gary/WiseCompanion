<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Bank 活动列表</title>
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
<link href="https://cdn.tailwindcss.com" rel="stylesheet">
<style>
  .task-list-card { display:flex; border-left:4px solid; padding:10px; margin-bottom:10px; border-radius:8px; background:#f9f9f9; }
  .task-icon { width:40px; height:40px; display:flex; align-items:center; justify-content:center; margin-right:10px; font-size:1.5rem; color:#fff; border-radius:50%; }
  .task-content { flex:1; }
  .task-title { font-weight:bold; }
  .task-subtitle { font-size:0.875rem; color:#555; }
  .task-action .action-button { background:#f59e0b; color:#fff; padding:5px 10px; border-radius:5px; text-decoration:none; }
</style>
</head>
<body data-category="Bank" data-subcategory="DailyTask">

<h2 class="text-xl font-bold mb-4">Bank 活动列表</h2>
<div id="data-status-warning" class="mb-2 text-sm text-gray-500"></div>
<div id="daily-tasks-list"></div>

<script>
// ------------------ 配置 ------------------
const CATEGORY_DISPLAY_MAP = {
    'CheckIn': '天天有奖',
    'Video': '看视频赚',
    'Bank': '捡钱任务',
    'Shopping': '省钱秘籍'
};
window.allActivitiesCache = [];

// ------------------ 数据加载 ------------------
async function loadActivities() {
    const filePath = './activities.json';
    const container = document.getElementById('daily-tasks-list');
    container.innerHTML = '正在加载活动数据...';

    try {
        const res = await fetch(filePath, {cache:'no-cache'});
        const data = await res.json();
        window.allActivitiesCache = data;
        return data;
    } catch(e) {
        container.innerHTML = `加载失败: ${e.message}`;
        return [];
    }
}

// ------------------ 图标 ------------------
function getPlatformIcon(name) {
    if(!name) return 'fa-gift';
    if(name.includes('支付宝')) return 'fab fa-alipay';
    if(name.includes('工商')) return 'fa-building-columns';
    if(name.includes('建设')) return 'fa-building-columns';
    if(name.includes('招商')) return 'fa-star';
    if(name.includes('农业')) return 'fa-university';
    return 'fa-gift';
}

// ------------------ 渲染 ------------------
function renderActivityCard(activity) {
    const icon = getPlatformIcon(activity.sourceApp);
    const borderColor = 'var(--color-success)';
    const deepLink = activity.deepLink || '#';
    const countdownText = activity.expireDate ? calculateCountdown(activity.expireDate) : '';

    return `
        <div class="task-list-card" style="border-left-color:${borderColor}">
            <div class="task-icon" style="background-color:${borderColor}"><i class="fa-solid ${icon}"></i></div>
            <div class="task-content">
                <div class="task-title">${activity.name}</div>
                <div class="task-subtitle">奖励：${activity.specialNote||'标准奖励'} | 平台：${activity.sourceApp}</div>
                <div class="text-xs text-gray-500 mt-1">${activity.description}</div>
                ${countdownText ? `<div class="text-xs text-red-500 mt-1">剩余天数: ${countdownText}</div>` : ''}
            </div>
            <div class="task-action">
                <a href="${deepLink}" target="_blank" class="action-button">去参与</a>
            </div>
        </div>
    `;
}

function calculateCountdown(expireDate) {
    const now = new Date();
    const end = new Date(expireDate);
    const diff = Math.ceil((end - now)/ (1000*60*60*24));
    return diff >= 0 ? diff : 0;
}

function renderFilteredActivities(category, subcategory) {
    const container = document.getElementById('daily-tasks-list');
    if(!window.allActivitiesCache.length) {
        container.innerHTML = '无活动';
        return;
    }

    const filtered = window.allActivitiesCache.filter(a => 
        a.category && Array.isArray(a.category) &&
        a.category.includes(category) &&
        a.category.includes(subcategory)
    );

    if(!filtered.length) {
        container.innerHTML = '暂无活动';
        return;
    }

    container.innerHTML = filtered.map(renderActivityCard).join('');
}

// ------------------ 主逻辑 ------------------
document.addEventListener('DOMContentLoaded', async ()=>{
    const body = document.body;
    const category = body.dataset.category;
    const subcategory = body.dataset.subcategory;

    const status = document.getElementById('data-status-warning');
    if(status) status.textContent = `⚠️ 正在显示 [${CATEGORY_DISPLAY_MAP[category]||category}] / ${subcategory} 活动`;

    await loadActivities();
    renderFilteredActivities(category, subcategory);
});
</script>

</body>
</html>
