<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>慧伴管家 - 捡钱任务</title>
    <script async defer src="https://umami.example.com/script.js" data-website-id="7b5c80e8-218d-4850-a9f3-d3764a059fed" data-do-not-track="true" data-domains="1111gary.github.io"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./assets/icon_apple.png">
    <style>
        :root {
            --color-bg-dark: #0f0f0f; --color-card: #1e1e1e; --color-text-main: #ffffff; --color-text-sub: #aaaaaa;
            --color-primary: #3B82F6; /* Bank Blue */
            --color-accent: #FBBF24; 
            --grad-card-border: linear-gradient(135deg, #3B82F6, #FBBF24);
        }
        body { background-color: var(--color-bg-dark); color: var(--color-text-main); padding-bottom: 85px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow-x: hidden; padding-top: 100px; /* 留出 Header 高度 */ }

        /* --- YouTube Style Header --- */
        #smart-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(12px);
            transition: transform 0.3s cubic-bezier(0.2, 0, 0.2, 1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-top: env(safe-area-inset-top);
        }
        .nav-hidden { transform: translateY(-100%); }
        .nav-visible { transform: translateY(0); }

        /* Row 1: Logo & Title */
        .header-row-top { display: flex; align-items: center; justify-content: space-between; height: 48px; padding: 0 16px; }
        .brand-area { display: flex; align-items: center; gap: 10px; }
        .app-logo { width: 28px; height: 28px; border-radius: 6px; }
        .app-title { font-size: 1.1rem; font-weight: 700; letter-spacing: -0.5px; }
        .user-avatar { width: 28px; height: 28px; border-radius: 50%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: #888; border: 1px solid #444; }

        /* Row 2: Scrollable Chips */
        .header-row-filter { display: flex; align-items: center; gap: 8px; overflow-x: auto; padding: 0 16px 12px 16px; scrollbar-width: none; }
        .header-row-filter::-webkit-scrollbar { display: none; }
        
        /* Chips Style */
        .chip {
            display: inline-flex; align-items: center; height: 32px; padding: 0 12px;
            border-radius: 8px; font-size: 0.85rem; font-weight: 500; white-space: nowrap; flex-shrink: 0;
            background: #272727; color: #fff; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s;
        }
        .chip.active { background: var(--color-text-main); color: #000; border-color: #fff; font-weight: 700; }
        .chip-icon { margin-right: 6px; font-size: 0.8rem; }
        .chip-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.15); margin: 0 4px; flex-shrink: 0; }

        /* --- Sidebar (Drawer) --- */
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 90; opacity: 0; pointer-events: none; transition: opacity 0.3s; backdrop-filter: blur(2px); }
        .sidebar-menu { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: #1e1e1e; z-index: 100; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1); box-shadow: 4px 0 24px rgba(0,0,0,0.5); padding-top: env(safe-area-inset-top); display: flex; flex-direction: column; }
        .sidebar-open .sidebar-overlay { opacity: 1; pointer-events: auto; }
        .sidebar-open .sidebar-menu { transform: translateX(0); }
        
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; }
        .sidebar-item { padding: 12px 20px; display: flex; align-items: center; gap: 16px; color: #eee; font-size: 0.95rem; transition: background 0.2s; }
        .sidebar-item:active { background: rgba(255,255,255,0.1); }
        .sidebar-item i { width: 24px; text-align: center; color: #aaa; }
        .sidebar-section-title { padding: 16px 20px 8px; font-size: 0.8rem; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.5px; }

        /* --- Content Cards --- */
        .section-title-card { display: flex; align-items: center; margin: 1.5rem 1rem 1rem 1rem; padding-left: 10px; border-left: 4px solid var(--color-primary); }
        .section-title-card h2 { font-size: 1.1rem; font-weight: 700; color: #fff; }

        .task-list-card {
            background: var(--color-card); border-radius: 12px; overflow: hidden; margin: 0 1rem 1rem 1rem;
            border: 1px solid rgba(255,255,255,0.05); position: relative; display: flex; flex-direction: column;
        }
        /* Image/Header Area */
        .card-header-area { position: relative; height: 70px; background: linear-gradient(to right, rgba(59,130,246,0.1), transparent); display: flex; align-items: center; padding: 0 16px; }
        .task-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; background: #333; color: #fff; margin-right: 12px; z-index: 2; }
        
        /* Badges */
        .badge-group { position: absolute; top: 10px; right: 10px; display: flex; gap: 6px; z-index: 5; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; color: #000; display: flex; align-items: center; }
        .badge-timer { background: #EC4899; color: #fff; } /* 横版倒计时，粉红高亮 */
        .badge-note { background: #FBBF24; }

        .card-body { padding: 12px 16px; }
        .task-title { font-size: 1rem; font-weight: 600; color: #fff; line-height: 1.3; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .task-desc { font-size: 0.8rem; color: #aaa; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }

        .card-footer { padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; }
        .btn-action { background: #fff; color: #000; padding: 6px 16px; border-radius: 99px; font-size: 0.8rem; font-weight: 700; border: none; }
        .btn-share { color: var(--color-primary); font-size: 0.8rem; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        
        /* Bottom Nav */
        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: rgba(15,15,15,0.95); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); z-index: 50; }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: #888; font-size: 0.65rem; }
        .tab-item.active { color: #fff; } .tab-icon { font-size: 1.4rem; margin-bottom: 2px; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    <div class="sidebar-menu">
        <div class="sidebar-header">
            <img src="./assets/icon_apple.png" onerror="this.src='https://placehold.co/32x32/3B82F6/ffffff?text=W'" style="width:32px;height:32px;border-radius:8px;">
            <span style="font-weight:700;font-size:1.1rem;color:#fff;">慧伴管家</span>
        </div>
        <div style="flex:1;overflow-y:auto;padding-bottom:20px;" id="sidebar-content">
            <!-- JS Populated -->
        </div>
        <div style="padding:20px;border-top:1px solid rgba(255,255,255,0.1);font-size:0.75rem;color:#666;">
            &copy; 2024 WiseCompanion
        </div>
    </div>

    <!-- Smart Header -->
    <header id="smart-header" class="nav-visible">
        <!-- Row 1 -->
        <div class="header-row-top">
            <div class="brand-area" onclick="toggleSidebar()">
                <div style="width:32px;height:32px;background:#272727;border-radius:50%;display:flex;align-items:center;justify-content:center;"><i class="fas fa-bars text-white"></i></div>
                <span class="app-title">捡钱任务</span>
            </div>
            <div class="user-avatar"><i class="fas fa-user"></i></div>
        </div>
        <!-- Row 2: Unified Filter -->
        <div class="header-row-filter" id="unified-filter-container">
            <!-- JS Populated -->
        </div>
    </header>

    <main id="main-content">
        <!-- Dynamic Content -->
        <div class="section-title-card"><h2><i class="fas fa-calendar-day text-green-400 mr-2"></i> 日常活动</h2></div><div id="routine-tasks-list"></div>
        <div class="section-title-card"><h2><i class="fas fa-tasks text-pink-400 mr-2"></i> 做任务领红包</h2></div><div id="mission-rewards-list"></div>
        <div class="section-title-card"><h2><i class="fas fa-sack-dollar text-yellow-400 mr-2"></i> 存款理财</h2></div><div id="savings-tasks-list"></div>
        <div style="height:40px"></div>
    </main>
    
    <nav class="tab-bar">
        <a href="./index.html" class="tab-item"><i class="fas fa-home tab-icon"></i><span>首页</span></a>
        <a href="./checkin.html" class="tab-item"><i class="fas fa-gifts tab-icon"></i><span>天天有奖</span></a>
        <a href="./video.html" class="tab-item"><i class="fas fa-play-circle tab-icon"></i><span>看视频赚</span></a>
        <span class="tab-item active"><i class="fas fa-hand-holding-usd tab-icon"></i><span>捡钱任务</span></span>
        <a href="./shopping.html" class="tab-item"><i class="fas fa-tags tab-icon"></i><span>省钱秘籍</span></a>
    </nav>

    <script>
        let ALL_ACTIVITIES=[], selectedBank='All', selectedStatus='ongoing';
        const CATEGORY_MAP={'DailyTask':{icon:'fa-calendar-day',color:'#10B981'},'MissionReward':{icon:'fa-tasks',color:'#EC4899'},'Deposit':{icon:'fa-sack-dollar',color:'#FBBF24'}};
        
        // [核心] Scroll Memory
        if('scrollRestoration' in history) history.scrollRestoration = 'manual';
        window.addEventListener('beforeunload', () => sessionStorage.setItem('scrollY_bank', window.scrollY));
        
        // [核心] YouTube Scroll Logic
        let lastY = 0; const header = document.getElementById('smart-header');
        window.addEventListener('scroll', () => {
            const y = window.scrollY;
            if(Math.abs(y-lastY)<10) return;
            if(y > lastY && y > 60) header.style.transform='translateY(-100%)';
            else header.style.transform='translateY(0)';
            lastY = y;
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetch('./activities.json').then(r=>r.json()).then(data => {
                ALL_ACTIVITIES=data.filter(a=>a.category&&(a.category.includes('DailyTask')||a.category.includes('MissionReward')||a.category.includes('Deposit')));
                initFilters(); render(); renderSidebar();
                setInterval(updateTimers, 1000);
                const savedY = sessionStorage.getItem('scrollY_bank');
                if(savedY) setTimeout(()=>window.scrollTo(0, parseInt(savedY)), 50);
            });
        });

        function toggleSidebar() { document.body.classList.toggle('sidebar-open'); }

        function initFilters() {
            const c = document.getElementById('unified-filter-container');
            // Status Group
            const sts = [{v:'ongoing',t:'进行中'},{v:'upcoming',t:'即将开始'},{v:'finished',t:'已结束'}];
            c.innerHTML = `<button class="chip ${selectedBank==='All'?'active':''}" onclick="toggleSidebar()">全部 ▼</button><div class="chip-divider"></div>`;
            sts.forEach(s => c.innerHTML += `<button class="chip ${selectedStatus===s.v?'active':''}" onclick="setStatus('${s.v}')">${s.t}</button>`);
        }

        function renderSidebar() {
            const c = document.getElementById('sidebar-content');
            const banks = new Set(); ALL_ACTIVITIES.forEach(a=>banks.add(a.sourceApp));
            let html = `<div class="sidebar-section-title">来源平台</div>`;
            banks.forEach(b => {
                if(b) html += `<div class="sidebar-item" onclick="setBank('${b}')"><i class="fas fa-bank"></i> ${b}</div>`;
            });
            html += `<div class="sidebar-item" onclick="setBank('All')"><i class="fas fa-layer-group"></i> 全部显示</div>`;
            c.innerHTML = html;
        }

        function setStatus(s) { selectedStatus=s; render(); initFilters(); window.scrollTo(0,0); }
        function setBank(b) { selectedBank=b; toggleSidebar(); render(); window.scrollTo(0,0); }

        function render() {
            const lists={'DailyTask':document.getElementById('routine-tasks-list'),'MissionReward':document.getElementById('mission-rewards-list'),'Deposit':document.getElementById('savings-tasks-list')};
            Object.values(lists).forEach(l=>l.innerHTML='');
            const now = Date.now();
            
            ALL_ACTIVITIES.filter(act => {
                const e=act.endDate?new Date(act.endDate).getTime():null, s=act.startDate?new Date(act.startDate).getTime():null;
                if(selectedStatus==='finished') return e && e<now;
                if(selectedStatus==='upcoming') return s && s>now;
                return (!s || s<=now) && (!e || e>=now);
            }).filter(act => selectedBank==='All' || act.sourceApp===selectedBank).forEach(act => {
                const cat = act.category.find(c => CATEGORY_MAP[c]);
                if(cat && lists[cat]) lists[cat].innerHTML += createCard(act, cat);
            });
        }

        function createCard(act, cat) {
            const s = CATEGORY_MAP[cat];
            return `<div class="task-list-card">
                <div class="card-header-area">
                    <div class="task-icon" style="color:${s.color}"><i class="fas ${s.icon}"></i></div>
                    <div style="flex:1;min-width:0">
                         <div class="task-title">${act.name}</div>
                         <div class="task-desc">${act.sourceApp}</div>
                    </div>
                    <div class="badge-group">
                        ${act.specialNote ? `<div class="badge badge-note">${act.specialNote}</div>` : ''}
                        <div class="badge badge-timer" data-end="${act.endDate}" data-start="${act.startDate}">计算中...</div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="task-desc">${act.description||'暂无描述'}</div>
                </div>
                <div class="card-footer">
                    <button class="btn-share"><i class="fas fa-share-alt"></i> 分享</button>
                    <a href="${act.link||'#'}" target="_blank" class="btn-action">去领取</a>
                </div>
            </div>`;
        }

        function updateTimers() {
            const now = Date.now();
            document.querySelectorAll('.badge-timer').forEach(el => {
                const s=el.dataset.start?new Date(el.dataset.start).getTime():0, e=el.dataset.end?new Date(el.dataset.end).getTime():0;
                if(s>now) el.innerText = `距开始 ${fmt(s-now)}`;
                else if(e>now || !el.dataset.end || el.dataset.end==='null') el.innerText = (!el.dataset.end) ? '长期' : `剩余 ${fmt(e-now)}`;
                else { el.innerText='已结束'; el.style.background='#333'; }
            });
        }
        function fmt(ms){ const d=Math.floor(ms/86400000), h=Math.floor((ms%86400000)/3600000), m=Math.floor((ms%3600000)/60000); return d>0?`${d}天${h}时`:`${h}时${m}分`; }
    </script>
</body>
</html>
