<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>慧伴管家 - 捡钱任务</title>
    <script async defer src="https://umami.example.com/script.js" data-website-id="7b5c80e8-218d-4850-a9f3-d3764a059fed" data-do-not-track="true" data-domains="1111gary.github.io"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./assets/icon_apple.png">
    <style>
        :root {
            --color-bg-dark: #0B1120; --color-card-bg: #1E293B; --color-text-light: #F1F5F9; --color-text-muted: #94A3B8;
            --color-primary: #00BFFF; --color-highlight: #FFD700; --color-bank-bg: #1F2A40; --color-success: #10B981;
            --color-special-note: #F59E0B; --color-premium-border: linear-gradient(135deg, var(--color-highlight), #FF69B4);
            --color-mission-reward: #EC4899;
            --grad-bank-1: linear-gradient(135deg, #10B981, #34D399);
            --grad-bank-2: linear-gradient(135deg, #EC4899, #F472B6);
            --grad-bank-3: linear-gradient(135deg, #F59E0B, #FCD34D);
        }
        /* 顶部留出空间给 Header (约110px) */
        body { background-color: var(--color-bg-dark); color: var(--color-text-light); padding-bottom: 85px; font-family: 'Inter', sans-serif; overflow-x: hidden; margin: 0; padding-top: 110px; }
        
        /* [核心] YouTube 式智能吸顶容器 */
        #smart-header {
            position: fixed; top: 0; left: 0; right: 0; z-index: 50;
            background: rgba(11, 17, 32, 0.98); backdrop-filter: blur(15px);
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-top: env(safe-area-inset-top); /* 避开刘海 */
        }
        /* 隐藏状态 */
        .nav-hidden { transform: translateY(-100%); }
        .nav-visible { transform: translateY(0); }

        /* 第一行：Logo 和 标题 */
        .header-top-row { display: flex; align-items: center; justify-content: space-between; height: 50px; padding: 0 1rem; }
        .header-logo { width: 28px; height: 28px; margin-right: 8px; border-radius: 6px; }
        .header-title { font-size: 1.1rem; font-weight: 800; color: #fff; }
        
        /* 第二行：合并筛选栏 (Status + Bank) */
        .unified-filter-row {
            display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none;
            padding: 8px 1rem 12px 1rem; align-items: center;
        }
        .unified-filter-row::-webkit-scrollbar { display: none; }

        /* 统一胶囊样式 */
        .chip-btn {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 6px 14px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;
            background: rgba(30,41,59,0.8); color: var(--color-text-muted);
            border: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; transition: all 0.2s; white-space: nowrap;
        }
        .chip-btn i { margin-right: 5px; font-size: 0.8rem; }
        
        /* 激活状态 */
        .chip-btn.active { background: var(--color-primary); color: #fff; border-color: transparent; box-shadow: 0 2px 8px rgba(0,191,255,0.4); }
        /* 状态类激活色 */
        .chip-btn[data-type="status"].active[data-val="ongoing"] { background: #10B981; box-shadow: 0 2px 8px rgba(16,185,129,0.4); }
        .chip-btn[data-type="status"].active[data-val="upcoming"] { background: #EC4899; box-shadow: 0 2px 8px rgba(236,72,153,0.4); }
        .chip-btn[data-type="status"].active[data-val="finished"] { background: #64748B; box-shadow: none; }

        /* 列表样式 */
        .section-title-card { background: linear-gradient(135deg, #0f1627, #1a2233); border-radius: 12px; padding: 12px 16px; margin-top: 1.5rem; margin-bottom: 1rem; border-left: 4px solid var(--color-primary); display: flex; align-items: center; }
        .section-title-card h2 { font-size: 1.1rem; font-weight: 800; color: #fff; }
        
        .task-list-card { background-color: var(--color-bank-bg); border-radius: 15px; padding: 16px; margin-bottom: 15px; border-left: 5px solid; position: relative; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .task-routine { border-color: var(--color-success); } .icon-routine { background: var(--grad-bank-1); }
        .task-mission { border-color: var(--color-mission-reward); } .icon-mission { background: var(--grad-bank-2); }
        .task-savings { border-color: var(--color-highlight); } .icon-savings { background: var(--grad-bank-3); }
        
        /* 倒计时粉红高亮 */
        .countdown-badge { position: absolute; top: 0; right: 0; background: #EC4899; color: #fff; padding: 3px 10px; border-radius: 0 15px 0 10px; font-size: 0.75rem; font-weight: 700; z-index: 4; box-shadow: 0 2px 6px rgba(236,72,153,0.3); }
        .countdown-badge.expired { background-color: #EF4444; color: white; box-shadow: none; }
        .special-note-badge { background-color: var(--color-special-note); color: var(--color-bg-dark); padding: 2px 8px; border-radius: 0 0 8px 8px; font-size: 0.7rem; font-weight: 700; z-index: 5; margin-right: -5px; transform: translateY(-2px); box-shadow: 0 2px 4px rgba(0,0,0,0.3); }

        .task-main-content { display: flex; align-items: center; width: 100%; margin-top: 10px; }
        .task-icon { width: 44px; height: 44px; border-radius: 10px; color: var(--color-bg-dark); font-size: 1.2rem; display: flex; align-items: center; justify-content: center; margin-right: 12px; flex-shrink: 0; }
        .task-content { flex-grow: 1; min-width: 0; }
        .task-title { font-size: 1rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 5px; }
        .task-subtitle { font-size: 0.8rem; color: var(--color-text-muted); margin-top: 2px; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }

        .task-action-bar { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 10px; border-top: 1px solid var(--color-card-bg); }
        .share-button { background-color: var(--color-card-bg); color: #00BFFF; border: 1px solid #00BFFF; font-weight: 600; padding: 6px 12px; border-radius: 99px; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 4px; }
        .action-button { background-color: #00BFFF; color: var(--color-bg-dark); font-weight: 700; padding: 6px 16px; border-radius: 99px; font-size: 0.8rem; min-width: 90px; display: inline-flex; align-items: center; justify-content: center; gap: 4px; }
        .action-button-voice { background-color: var(--color-success); }
        .action-button-voice.speaking { background-color: #EF4444; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }

        .premium-card { background: linear-gradient(135deg, #1e293b, #0f172a); border-radius: 20px; padding: 25px; text-align: center; border: 2px solid transparent; border-image: linear-gradient(135deg, #3B82F6, #FBBF24); border-image-slice: 1; box-shadow: 0 10px 25px rgba(0,0,0,0.3); margin-top: 2rem; text-decoration: none; display: block; transition: all 0.3s; }
        .premium-card h2 { font-size: 1.2rem; font-weight: 800; background: linear-gradient(135deg, #3B82F6, #FBBF24); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        .premium-card p { color: var(--color-text-muted); font-size: 0.85rem; margin-top: 8px; }

        .tab-bar { position: fixed; bottom: 0; width: 100%; display: flex; justify-content: space-around; align-items: center; height: 60px; background-color: var(--color-bg-dark); border-top: 1px solid #1A2233; z-index: 60; padding-bottom: env(safe-area-inset-bottom); }
        .tab-item { display: flex; flex-direction: column; align-items: center; color: var(--color-text-muted); font-size: 0.75rem; font-weight: 500; }
        .tab-item.active { color: #00BFFF; } .tab-icon { font-size: 1.2rem; margin-bottom: 3px; }
    </style>
</head>
<body>
    <!-- [核心] 智能隐显头部 -->
    <div id="smart-header" class="nav-visible">
        <div class="header-top-row">
            <div class="flex items-center">
                <img src="./assets/icon_apple.png" onerror="this.src='https://placehold.co/32x32/00BFFF/ffffff?text=L'" class="header-logo">
                <h1 class="header-title">捡钱任务</h1>
            </div>
            <a href="./index.html" class="text-gray-300 text-xl"><i class="fas fa-arrow-left"></i></a>
        </div>
        <!-- 合并筛选行 -->
        <div class="unified-filter-row" id="unified-filter-row">
            <!-- JS 动态填充：状态 + 银行 -->
        </div>
    </div>

    <main class="container mx-auto px-4">
        <div class="section-title-card"><h2><i class="fas fa-calendar-day mr-3 text-xl" style="color: var(--color-success);"></i> 日常活动</h2></div><div id="routine-tasks-list"></div>
        <div class="section-title-card"><h2><i class="fas fa-tasks mr-3 text-xl" style="color: var(--color-mission-reward);"></i> 做任务领红包</h2></div><div id="mission-rewards-list"></div>
        <div class="section-title-card"><h2><i class="fas fa-sack-dollar mr-3 text-xl" style="color: var(--color-highlight);"></i> 存款理财</h2></div><div id="savings-tasks-list"></div>
        
        <a href="./premium.html" class="premium-card" onclick="umami.track('click_premium_card', { from: 'bank' })">
            <h2><i class="fas fa-crown mr-2"></i> 高级会员专区</h2><p>AI赋能ʕʘ̅͜ʘ̅ʔ 改变生活</p>
        </a>
        <div style="height: 40px;"></div>
    </main>
    
    <nav class="tab-bar">
        <a href="./index.html" class="tab-item"><i class="fas fa-home tab-icon"></i><span>首页</span></a>
        <a href="./checkin.html" class="tab-item"><i class="fas fa-gifts tab-icon"></i><span>天天有奖</span></a>
        <a href="./video.html" class="tab-item"><i class="fas fa-play-circle tab-icon"></i><span>看视频赚</span></a>
        <span class="tab-item active"><i class="fas fa-hand-holding-usd tab-icon"></i><span>捡钱任务</span></span>
        <a href="./shopping.html" class="tab-item"><i class="fas fa-tags tab-icon"></i><span>省钱秘籍</span></a>
    </nav>
    
    <script>
        let ALL_ACTIVITIES=[], selectedBank='All', selectedStatus='ongoing';
        const CATEGORY_MAP={'DailyTask':{border:'task-routine',icon:'icon-routine',fa:'fa-calendar-day'},'MissionReward':{border:'task-mission',icon:'icon-mission',fa:'fa-tasks'},'Deposit':{border:'task-savings',icon:'icon-savings',fa:'fa-sack-dollar'}};
        const synth=window.speechSynthesis; let currentUtterance=null, speakingButton=null;
        
        // [核心] 滚动记忆与隐显逻辑
        let lastScrollY = window.scrollY;
        const header = document.getElementById('smart-header');
        window.addEventListener('scroll', () => {
            const currentScrollY = window.scrollY;
            if (currentScrollY > lastScrollY && currentScrollY > 50) { header.classList.add('nav-hidden'); header.classList.remove('nav-visible'); } 
            else { header.classList.add('nav-visible'); header.classList.remove('nav-hidden'); }
            lastScrollY = currentScrollY;
        });
        
        if('scrollRestoration' in history) history.scrollRestoration = 'manual'; // 强制手动
        function savePos() { sessionStorage.setItem('pos_bank', window.scrollY); }
        function restorePos() { const y = sessionStorage.getItem('pos_bank'); if(y) window.scrollTo(0, parseInt(y)); }
        window.addEventListener('beforeunload', savePos);

        document.addEventListener('DOMContentLoaded', () => {
            fetch('./activities.json').then(r=>r.json()).then(data => {
                ALL_ACTIVITIES = data.filter(a => a.category && (a.category.includes('DailyTask') || a.category.includes('Deposit') || a.category.includes('MissionReward')));
                initUnifiedFilters(); render(); setInterval(updateTimers, 1000);
                setTimeout(restorePos, 100); // 渲染后恢复位置
            });
        });

        // [核心] 合并渲染筛选器
        function initUnifiedFilters() {
            const c = document.getElementById('unified-filter-row');
            // 1. 状态组
            const statuses = [
                {val:'ongoing', icon:'fa-running', txt:'进行中'},
                {val:'upcoming', icon:'fa-clock', txt:'即将开始'},
                {val:'finished', icon:'fa-check', txt:'已结束'}
            ];
            statuses.forEach(s => {
                c.innerHTML += `<button class="chip-btn ${selectedStatus===s.val?'active':''}" data-type="status" data-val="${s.val}" onclick="setStatus('${s.val}', this)"><i class="fas ${s.icon}"></i> ${s.txt}</button>`;
            });
            
            // 分隔符
            c.innerHTML += `<div style="width:1px; height:20px; background:rgba(255,255,255,0.1); margin:0 5px;"></div>`;

            // 2. 银行组
            const banks = new Set(); ALL_ACTIVITIES.forEach(a=>banks.add(a.sourceApp));
            c.innerHTML += `<button class="chip-btn ${selectedBank==='All'?'active':''}" data-type="bank" onclick="setBank('All', this)"><i class="fas fa-layer-group"></i> 全部</button>`;
            banks.forEach(b => {
                if(b) {
                   const icon = b.includes('微信')?'fab fa-weixin':b.includes('支付宝')?'fab fa-alipay':b.includes('招商')?'fa-star':'fa-piggy-bank';
                   c.innerHTML += `<button class="chip-btn" data-type="bank" onclick="setBank('${b}', this)"><i class="${icon}"></i> ${b}</button>`;
                }
            });
        }
        
        function setStatus(val, btn) {
            selectedStatus = val;
            document.querySelectorAll('.chip-btn[data-type="status"]').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active'); render();
        }
        function setBank(val, btn) {
            selectedBank = val;
            document.querySelectorAll('.chip-btn[data-type="bank"]').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active'); render();
        }

        function render() {
            const lists={'DailyTask':document.getElementById('routine-tasks-list'),'MissionReward':document.getElementById('mission-rewards-list'),'Deposit':document.getElementById('savings-tasks-list')};
            Object.values(lists).forEach(l=>l.innerHTML='');
            const now = new Date().setHours(0,0,0,0);
            
            let hasItem = false;
            ALL_ACTIVITIES.filter(act => {
                const e = act.endDate?new Date(act.endDate).setHours(23,59,59,999):null;
                const s = act.startDate?new Date(act.startDate).setHours(0,0,0,0):null;
                if(selectedStatus==='finished') return e && e<now;
                if(selectedStatus==='upcoming') return s && s>now;
                return (!s || s<=now) && (!e || e>=now);
            }).filter(act => selectedBank==='All' || act.sourceApp===selectedBank).forEach(act => {
                const cat = act.category.find(c => CATEGORY_MAP[c]);
                if(cat && lists[cat]) { hasItem=true; lists[cat].innerHTML += createCard(act, cat); }
            });
            
            if(!hasItem) document.getElementById('routine-tasks-list').innerHTML = `<p class="text-center text-gray-500 py-6 text-sm w-full col-span-full">暂无相关活动</p>`;

            document.querySelectorAll('.action-button-voice').forEach(b => b.onclick = e => toggleSpeech(e.currentTarget, e.currentTarget.dataset.steps));
            document.querySelectorAll('.share-button').forEach(b => b.onclick = e => share(e.currentTarget));
            updateTimers();
        }

        function createCard(act, cat) {
            const s = CATEGORY_MAP[cat];
            let btn = act.link&&act.link!=='#' ? `<a href="${act.link}" target="_blank" class="action-button"><i class="fas fa-rocket"></i> 去领取</a>` : (act.StepsText ? `<button class="action-button action-button-voice" data-steps="${act.StepsText.replace(/"/g,'&quot;')}"><i class="fas fa-volume-high"></i> 播放语音</button>` : `<button class="action-button opacity-50" disabled>暂无</button>`);
            
            return `<div class="task-list-card ${s.border}">
                <div class="absolute top-0 right-0 flex items-start">
                     ${act.specialNote ? `<span class="special-note-badge"><i class="fas fa-bell"></i> ${act.specialNote}</span>` : ''}
                    <span class="countdown-badge" data-end="${act.endDate}" data-start="${act.startDate}">计算中...</span>
                </div>
                <div class="task-main-content">
                    <div class="task-icon ${s.icon}"><i class="fa-solid ${s.fa}"></i></div>
                    <div class="task-content"><div class="task-title">${act.name}</div><div class="task-subtitle">${act.description||''}</div></div>
                </div>
                <div class="task-action-bar">
                    <button class="share-button" data-id="${act.id}"><i class="fas fa-share-alt"></i> 分享</button>
                    ${btn}
                </div>
            </div>`;
        }
        
        function toggleSpeech(btn,t){if(!synth)return; if(btn.classList.contains('speaking')){synth.cancel();btn.classList.remove('speaking');btn.innerHTML=`<i class="fas fa-volume-high"></i> 播放语音`;return;} synth.cancel(); const u=new SpeechSynthesisUtterance(t); u.lang='zh-CN'; u.rate=0.75; u.onstart=()=>{speakingButton=btn; btn.classList.add('speaking'); btn.innerHTML=`<i class="fas fa-wave-square"></i> 播放中`;}; u.onend=()=>{btn.classList.remove('speaking'); btn.innerHTML=`<i class="fas fa-volume-high"></i> 播放语音`;}; synth.speak(u);}
        function share(btn){ const url=`${location.origin}${location.pathname.replace('bank.html','go.html')}?id=${btn.dataset.id}`; if (navigator.share) { navigator.share({ title: '慧伴管家', text: 'Check out this activity!', url: url }).catch(console.error); } else { try{const t=document.createElement('textarea'); t.value=`活动分享：${url}`; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); const old=btn.innerHTML; btn.innerHTML=`<i class="fas fa-check"></i> 已复制`; setTimeout(()=>btn.innerHTML=old,2000);}catch(e){alert(url);} } }
        
        function updateTimers(){
            const now=Date.now();
            document.querySelectorAll('.countdown-badge').forEach(el=>{
                const s=el.dataset.start?new Date(el.dataset.start).getTime():0, e=el.dataset.end?new Date(el.dataset.end).getTime():0;
                if(s>now) el.innerText=`距开始 ${fmt(s-now)}`;
                else if(e>now || !el.dataset.end || el.dataset.end==='null') el.innerText = (!el.dataset.end || el.dataset.end==='null') ? '长期' : `剩余 ${fmt(e-now)}`;
                else { el.innerText='已结束'; el.classList.add('expired'); }
            });
        }
        function fmt(ms){ const d=Math.floor(ms/86400000), h=Math.floor((ms%86400000)/3600000), m=Math.floor((ms%3600000)/60000); return d>0?`${d}天${h}时`:`${h}时${m}分`; }
    </script>
</body>
</html>
