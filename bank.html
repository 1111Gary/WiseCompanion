<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <!-- [【 核心 】] 标题已修改 -->
    <title>慧伴管家 - 捡钱任务</title>
    
    <!-- Umami 统计 -->
    <script async defer 
        data-website-id="7b5c80e8-218d-4850-a9f3-d3764a059fed" 
        src="https://umami.example.com/script.js" 
        data-do-not-track="true" 
        data-domains="1111gary.github.io"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- PWA -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="慧伴管家">
    <link rel="apple-touch-icon" href="./assets/icon_apple.png">
    
    <style>
        :root {
            /* ... 颜色变量 ... */
            --color-bg-dark: #0A1322; 
            --color-card-bg: #1A2233; 
            --color-primary: #00BFFF; 
            --color-secondary: #FF69B4; 
            --color-text-light: #E0E7FF;
            --color-text-muted: #9CA3AF;
            --color-highlight: #FFD700; 
            --color-bank-bg: #1F2A40; 
            --color-success: #34D399; 
            --color-special-note: #F59E0B; 
            --color-premium-border: linear-gradient(135deg, var(--color-highlight), #FF69B4);
            
            /* [【 核心 】] 类别颜色 (已更新) */
            --color-bank: #00BFFF; /* 银行 */
            --color-digitalrmb: #34D399; /* 数字人民币 (绿色) */
            --color-card: #FF69B4; /* 信用卡 (粉色) */
            --color-dailytask: #A78BFA; /* 日常任务 (紫色) */
            --color-deposit: #F59E0B; /* 存款 (橙色) */
            --color-other: #9CA3AF; /* 其他/银行标签 */
        }
        body { 
            /* ... 基础样式 ... */
            background-color: var(--color-bg-dark); 
            color: var(--color-text-light); 
            padding-bottom: calc(85px + env(safe-area-inset-bottom)); 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        /* 顶部导航栏 */
        .header-bar-fixed { 
            /* ... 样式 ... */
            padding-top: calc(15px + env(safe-area-inset-top)); 
            padding-bottom: 5px; 
            background-color: var(--color-bg-dark);
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        /* 页面主标题卡片 */
        .main-banner-card {
            /* ... 样式 ... */
            background: linear-gradient(135deg, #0f1627, #1a2233);
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            border: 3px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            border-image: linear-gradient(to right, var(--color-primary), var(--color-secondary));
            border-image-slice: 1;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.5), 0 0 30px rgba(255, 105, 180, 0.3);
            margin-bottom: 1.5rem;
            position: relative;
        }
        .main-banner-card h1 {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--color-text-light);
        }
        
        /* 状态筛选器 */
        .status-filter-bar {
            /* ... 样式 ... */
            display: flex;
            justify-content: space-around;
            background-color: var(--color-card-bg);
            border-radius: 9999px;
            padding: 5px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0,0,0, 0.3);
        }
        .status-filter-btn {
            /* ... 样式 ... */
            flex-grow: 1;
            padding: 8px 12px;
            border-radius: 9999px;
            background-color: transparent;
            color: var(--color-text-muted);
            font-size: 0.85rem;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
        }
        .status-filter-btn:hover { color: var(--color-text-light); }
        .status-filter-btn.active {
            background-color: var(--color-primary);
            color: var(--color-bg-dark);
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.5);
        }

        /* [【 核心 】] 类别筛选器 (样式更新) */
        .category-filter-bar {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 5px 0 15px 0;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .category-filter-bar::-webkit-scrollbar { display: none; }
        .category-filter-btn {
            padding: 8px 16px;
            border-radius: 9999px;
            background-color: var(--color-card-bg);
            color: var(--color-text-muted);
            font-size: 0.9rem;
            font-weight: 600;
            border: 1px solid var(--color-card-bg);
            transition: all 0.3s ease;
            flex-shrink: 0;
            cursor: pointer;
            white-space: nowrap; /* 确保银行名称不换行 */
        }
        .category-filter-btn:hover { border-color: var(--color-primary); }
        .category-filter-btn.active {
            color: var(--color-bg-dark);
            box-shadow: 0 0 10px;
        }
        /* 类别激活颜色 */
        .category-filter-btn.active[data-category="All"] { background-color: var(--color-text-light); color: var(--color-bg-dark); box-shadow-color: rgba(224, 231, 255, 0.5); }
        .category-filter-btn.active[data-category="Bank"] { background-color: var(--color-bank); box-shadow-color: rgba(0, 191, 255, 0.5); }
        .category-filter-btn.active[data-category="DigitalRMB"] { background-color: var(--color-digitalrmb); box-shadow-color: rgba(52, 211, 153, 0.5); }
        .category-filter-btn.active[data-category="Card"] { background-color: var(--color-card); box-shadow-color: rgba(255, 105, 180, 0.5); }
        .category-filter-btn.active[data-category="DailyTask"] { background-color: var(--color-dailytask); box-shadow-color: rgba(167, 139, 250, 0.5); }
        .category-filter-btn.active[data-category="Deposit"] { background-color: var(--color-deposit); box-shadow-color: rgba(245, 158, 11, 0.5); }
        /* 银行标签的动态样式 */
        .category-filter-btn.active.dynamic-bank-tag {
             background-color: var(--color-other);
             color: var(--color-bg-dark);
             box-shadow-color: rgba(156, 163, 175, 0.5);
        }

        .section-description {
            color: var(--color-text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem; 
            padding-left: 5px;
        }
        
        /* 任务活动卡片样式 */
        .task-list-card {
            /* ... 样式 ... */
            background-color: var(--color-bank-bg);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            border-left: 5px solid; 
            position: relative;
        }
        .task-list-card:hover {
            background-color: #25334c;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }

        /* 徽章 */
        .special-note-badge { /* ... 样式 ... */ }
        .countdown-badge { /* ... 样式 ... */ }
        .special-note-badge + .countdown-badge { /* ... 样式 ... */ }
        .expired-badge { /* ... 样式 ... */ }
        .upcoming-badge { /* ... 样式 ... */ }
        /* ... (徽章样式保持不变) ... */
        .special-note-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--color-special-note);
            color: var(--color-bg-dark);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            z-index: 5;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.7);
        }
        .countdown-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--color-secondary);
            color: var(--color-bg-dark);
            padding: 4px 10px;
            border-top-right-radius: 15px;
            border-bottom-left-radius: 15px;
            font-size: 0.75rem;
            font-weight: 700;
            z-index: 4;
        }
        .special-note-badge + .countdown-badge {
            top: 40px;
            right: 15px;
            border-radius: 8px;
        }
        .expired-badge {
            background-color: #EF4444;
            color: white;
        }
        .upcoming-badge {
            background-color: var(--color-highlight);
            color: var(--color-bg-dark);
        }


        /* [【 核心 】] 类别强调色 (已更新) */
        .task-bank { border-left-color: var(--color-bank); }
        .task-digitalrmb { border-left-color: var(--color-digitalrmb); }
        .task-card { border-left-color: var(--color-card); }
        .task-dailytask { border-left-color: var(--color-dailytask); }
        .task-deposit { border-left-color: var(--color-deposit); }
        .task-other { border-left-color: var(--color-other); }

        .task-main-content { display: flex; align-items: center; width: 100%; }

        .task-icon { /* ... 样式 ... */ 
            width: 40px;
            height: 40px;
            border-radius: 8px;
            color: var(--color-bg-dark); 
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        /* [【 核心 】] 类别图标 (已更新) */
        .icon-bank { background-color: var(--color-bank); }
        .icon-digitalrmb { background-color: var(--color-digitalrmb); }
        .icon-card { background-color: var(--color-card); }
        .icon-dailytask { background-color: var(--color-dailytask); }
        .icon-deposit { background-color: var(--color-deposit); }
        .icon-other { background-color: var(--color-other); }


        .task-content { flex-grow: 1; min-width: 0; }
        .task-title { /* ... 样式 ... */ 
            font-size: 1rem;
            font-weight: 700;
            color: var(--color-text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 90px;
        }
        .has-special-note .task-title { padding-right: 120px; }
        .task-subtitle { /* ... 样式 ... */ 
            font-size: 0.8rem;
            color: var(--color-text-muted);
            white-space: normal; 
            line-height: 1.4;
            margin-top: 4px;
        }
        
        /* 动作栏 */
        .task-action-bar { /* ... 样式 ... */ 
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--color-card-bg);
        }
        .share-button { /* ... 样式 ... */ 
            background-color: var(--color-card-bg);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 9999px;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        .share-button:hover {
            background-color: var(--color-primary);
            color: var(--color-bg-dark);
        }

        .action-button { /* ... 样式 ... */
            background-color: var(--color-primary);
            color: var(--color-bg-dark);
            font-weight: 700;
            padding: 8px 18px;
            border-radius: 9999px;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-align: center;
            min-width: 100px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
        }
        .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 191, 255, 0.7);
        }
        /* [【 核心 】] 语音按钮样式 (已修复) */
        .action-button-voice {
            background-color: var(--color-success);
        }
        .action-button-voice:hover {
            box-shadow: 0 0 10px rgba(52, 211, 153, 0.7);
        }
        .action-button-voice.speaking {
            background-color: var(--color-secondary);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* 底部导航栏 */
        .tab-bar { /* ... 样式 ... */ 
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background-color: var(--color-bg-dark);
            border-top: 1px solid #1A2233;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 20;
        }
        .tab-item { /* ... 样式 ... */ 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--color-text-muted);
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s ease;
            padding: 5px;
            flex-grow: 1;
            max-width: 20%;
        }
        .tab-item.active { color: var(--color-primary); }
        .tab-icon {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        /* 顶部 Logo 组 */
        .header-logo-group { display: flex; align-items: center; }
        .header-logo { width: 32px; height: 32px; margin-right: 10px; }
        .header-title { font-size: 1.2rem; font-weight: 700; color: var(--color-text-light); }
        .back-arrow-link { /* ... 样式 ... */ 
            color: var(--color-text-light);
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 50%;
            background-color: var(--color-card-bg);
            transition: background-color 0.2s;
        }
        
        /* 付费会员诱饵卡片 */
        .premium-card { /* ... 样式 ... */ 
            background: var(--color-card-bg);
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            border: 3px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            border-image: var(--color-premium-border);
            border-image-slice: 1;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4), 0 0 30px rgba(255, 105, 180, 0.2);
            margin-top: 2rem;
            margin-bottom: 1rem;
            position: relative;
            text-decoration: none;
            display: block;
            transition: all 0.3s ease;
        }
        .premium-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6), 0 0 40px rgba(255, 105, 180, 0.4);
        }
        .premium-card h2 { /* ... 样式 ... */ 
            font-size: 1.3rem;
            font-weight: 800;
            background: var(--color-premium-border);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .premium-card p {
            color: var(--color-text-muted);
            font-size: 0.9rem;
            margin-top: 10px;
        }

        /* 空状态 */
        .empty-state { /* ... 样式 ... */ 
            text-align: center;
            padding: 40px 20px;
            background-color: var(--color-bank-bg);
            border-radius: 15px;
            margin-top: 1rem;
        }
        .empty-state-icon {
            font-size: 3rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
            opacity: 0.8;
        }
        .empty-state p {
            font-size: 1rem;
            color: var(--color-text-muted);
            font-weight: 500;
        }

    </style>
</head>
<body>

    <!-- 顶部导航栏 -->
    <div class="header-bar-fixed px-4">
        <!-- ... Logo ... -->
        <div class="header-logo-group">
            <img src="./assets/icon_apple.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/00BFFF/ffffff?text=L'" alt="Logo" class="header-logo rounded-md shadow-lg">
            <h1 class="header-title">慧伴管家</h1>
        </div>
        <a href="./index.html" class="back-arrow-link" title="返回首页">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>

    <!-- 页面核心内容容器 -->
    <main class="container mx-auto px-4 py-4">
        
        <!-- **1. 【页面主标题卡片】 ** -->
        <div class="main-banner-card">
            <!-- [【 核心 】] 标题已修复，移除 (Bank) -->
            <h1>捡钱任务</h1>
            <p class="text-sm text-gray-400 mt-2">银行、证券、信用卡等所有相关活动</p>
        </div>
        
        <!-- **2. 【状态筛选器】 ** -->
        <div class="status-filter-bar">
            <button class="status-filter-btn active" data-status="ongoing" onclick="umami.track('filter_status_ongoing', { from: 'bank' })">
                <i class="fas fa-play-circle"></i> 正在进行
            </button>
            <button class="status-filter-btn" data-status="upcoming" onclick="umami.track('filter_status_upcoming', { from: 'bank' })">
                <i class="fas fa-hourglass-start"></i> 即将开始
            </button>
            <button class="status-filter-btn" data-status="ended" onclick="umami.track('filter_status_ended', { from: 'bank' })">
                <i class="fas fa-check-circle"></i> 已结束
            </button>
        </div>

        <!-- **3. 【 [【 核心 】] 类别筛选器】 ** -->
        <p class="section-description">
            按类别筛选：
        </p>
        <div class="category-filter-bar" id="category-filter-container">
            <!-- 类别按钮将由 JS 动态生成 -->
        </div>

        <!-- **4. 【任务列表】 ** -->
        <div id="bank-tasks-list" class="mt-4">
             <!-- 任务加载位置 -->
        </div>

        <!-- **5. 【 付费会员诱饵 】 ** -->
        <a href="./premium.html" class="premium-card" 
            onclick="umami.track('click_premium_card', { from: 'bank' })">
            <h2 class="flex items-center justify-center">
                <i class="fas fa-crown mr-2" style="color: var(--color-highlight);"></i>
                高级会员专区 (敬请期待)
            </h2>
            <p>学习独家“多平台优惠券叠加”神技</p>
        </a>
        
    </main>
    
    <!-- 底部导航栏 -->
    <nav class="tab-bar">
        <!-- ... (tab bar items) ... -->
        <a href="./index.html" class="tab-item">
            <i class="fas fa-home tab-icon"></i>
            <span>首页</span>
        </a>
        <a href="./checkin.html" class="tab-item">
            <i class="fas fa-gifts tab-icon"></i>
            <span>天天有奖</span>
        </a>
        <a href="./video.html" class="tab-item">
            <i class="fas fa-play-circle tab-icon"></i>
            <span>看视频赚</span>
        </a>
        <span class="tab-item active">
            <i class="fas fa-hand-holding-usd tab-icon"></i>
            <span>捡钱任务</span>
        </span>
        <a href="./shopping.html" class="tab-item">
            <i class="fas fa-tags tab-icon"></i>
            <span>省钱秘籍</span>
        </a>
    </nav>
    
    <script>
        // ----------------------------------------------------
        // 全局状态和数据
        // ----------------------------------------------------
        let ALL_ACTIVITIES = []; // L1 过滤后的原始数据
        let CURRENT_CATEGORY_FILTER = 'All';
        let CURRENT_STATUS_FILTER = 'ongoing';
        let DETECTED_CATEGORIES = []; // L2 动态检测到的所有类别

        // [【 核心 】] 基础类别 (L2)
        const BASE_CATEGORIES = ['Bank', 'DigitalRMB', 'Card', 'DailyTask', 'Deposit'];
        
        // [【 核心 】] 已知银行标签 (用于自动检测)
        const KNOWN_BANK_TAGS = [
            'ICBC', 'ABC', 'BOC', 'CCB', 'BOCOM', 'PSBC', // 六大行
            'CMB', 'SPDB', 'CITIC', 'CEB', 'HXB', 'CMBC', 'GDB', 'PAB', 'EBCLIFE' // 股份制
        ];

        // [【 核心 】] L2 类别样式映射
        const CATEGORY_MAP = {
            'Bank': { name: '银行', borderClass: 'task-bank', iconClass: 'icon-bank', faIcon: 'fa-university' },
            'DigitalRMB': { name: '数字人民币', borderClass: 'task-digitalrmb', iconClass: 'icon-digitalrmb', faIcon: 'fa-yen-sign' },
            'Card': { name: '信用卡', borderClass: 'task-card', iconClass: 'icon-card', faIcon: 'fa-credit-card' },
            'DailyTask': { name: '日常任务', borderClass: 'task-dailytask', iconClass: 'icon-dailytask', faIcon: 'fa-calendar-check' },
            'Deposit': { name: '存款', borderClass: 'task-deposit', iconClass: 'icon-deposit', faIcon: 'fa-piggy-bank' },
            'Other': { name: '其他', borderClass: 'task-other', iconClass: 'icon-other', faIcon: 'fa-box' }
        };
        
        // [【 核心 】] L1 页面路由（此页面包含哪些 L1 标签）
        // (旧: ['Bank', 'Stock', 'Card', 'Other'])
        // 我们假设您会把 'Stock' 和 'Other' 替换为 'DigitalRMB' 等
        const PAGE_L1_CATEGORIES = ['Bank', 'DigitalRMB', 'Card', 'Stock', 'Other', 'DailyTask', 'Deposit'];

        // [【 核心 】] 原生语音 API (Web Speech API)
        const synth = window.speechSynthesis;
        let currentUtterance = null; 

        // ----------------------------------------------------
        // 步骤 1: 页面加载主入口
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            // 类别筛选器 *必须* 在加载数据 *之后* 渲染
            loadAndFetchActivities();
            startCountdownUpdater();
            bindStatusFilterButtons();
        });

        // [【 核心BUG修复 】] 移除 primeSpeechEngine

        // ----------------------------------------------------
        // 步骤 2: 加载和获取数据
        // ----------------------------------------------------
        async function loadAndFetchActivities() {
            try {
                const response = await fetch('./activities.json');
                if (!response.ok) {
                    throw new Error('网络响应错误，无法加载 activities.json');
                }
                const rawData = await response.json();
                
                // 1. [L1 过滤] 过滤出所有 "捡钱任务" 相关的活动
                // 只要活动 category 包含 L1 列表中的 *任意一个*，它就属于这个页面
                ALL_ACTIVITIES = rawData.filter(act => 
                    act.category && act.category.some(cat => PAGE_L1_CATEGORIES.includes(cat))
                );

                // 2. [L2 动态检测] 从 L1 过滤后的活动中，检测所有 L2 标签
                const detectedSet = new Set(BASE_CATEGORIES);
                ALL_ACTIVITIES.forEach(act => {
                    act.category.forEach(cat => {
                        // 如果是已知的银行标签，且不在基础类别里
                        if (KNOWN_BANK_TAGS.includes(cat.toUpperCase()) && !BASE_CATEGORIES.includes(cat)) {
                            detectedSet.add(cat);
                        }
                    });
                });
                DETECTED_CATEGORIES = Array.from(detectedSet);
                
                // 3. 渲染
                renderCategoryFilters(); // 现在可以渲染 L2 筛选器了
                renderActivities(); // 渲染活动
                
            } catch (error) {
                console.error("加载活动数据失败:", error);
                document.getElementById('bank-tasks-list').innerHTML = `<p class="text-red-400 p-4 text-center">加载活动数据失败。请检查网络或 activities.json 文件。</p>`;
            }
        }

        // ----------------------------------------------------
        // 步骤 3: 渲染类别筛选器 (L2)
        // ----------------------------------------------------
        function renderCategoryFilters() {
            const container = document.getElementById('category-filter-container');
            let buttonsHtml = `
                <button class="category-filter-btn active" data-category="All" 
                        onclick="umami.track('filter_category_all', { from: 'bank' })">
                    <i class="fas fa-grip-horizontal mr-1"></i> 全部
                </button>`;
            
            DETECTED_CATEGORIES.forEach(catKey => {
                const cat = CATEGORY_MAP[catKey];
                const name = cat ? cat.name : catKey; // 如果是银行标签，直接用 Key (e.g., "ICBC")
                const icon = cat ? cat.faIcon : 'fa-university'; // 银行标签统一用大学图标
                const isDynamicBank = !cat; // 是否是动态银行标签
                
                buttonsHtml += `
                    <button class="category-filter-btn ${isDynamicBank ? 'dynamic-bank-tag' : ''}" data-category="${catKey}"
                            onclick="umami.track('filter_category_${catKey.toLowerCase()}', { from: 'bank' })">
                        <i class="fas ${icon} mr-1"></i> ${name}
                    </button>`;
            });
            
            container.innerHTML = buttonsHtml;
            
            // 绑定事件
            container.querySelectorAll('.category-filter-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    CURRENT_CATEGORY_FILTER = e.currentTarget.getAttribute('data-category');
                    container.querySelectorAll('.category-filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    renderActivities();
                });
            });
        }
        
        // ----------------------------------------------------
        // 步骤 4: 绑定状态筛选器
        // ----------------------------------------------------
        function bindStatusFilterButtons() {
            const container = document.querySelector('.status-filter-bar');
            container.querySelectorAll('.status-filter-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    CURRENT_STATUS_FILTER = e.currentTarget.getAttribute('data-status');
                    container.querySelectorAll('.status-filter-btn').forEach(btn => btn.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    renderActivities();
                });
            });
        }

        // ----------------------------------------------------
        // 步骤 5: 渲染活动列表 (已更新筛选逻辑)
        // ----------------------------------------------------
        function renderActivities() {
            const listContainer = document.getElementById('bank-tasks-list');
            listContainer.innerHTML = '';
            
            // 1. 按状态筛选
            const now = new Date();
            const filteredByStatus = ALL_ACTIVITIES.filter(act => {
                const startDate = act.startDate ? new Date(act.startDate) : null;
                const endDate = act.endDate ? new Date(act.endDate) : null;

                if (CURRENT_STATUS_FILTER === 'ongoing') {
                    const hasStarted = !startDate || startDate <= now;
                    const hasNotEnded = !endDate || endDate >= now;
                    return hasStarted && hasNotEnded;
                }
                if (CURRENT_STATUS_FILTER === 'upcoming') {
                    return startDate && startDate > now;
                }
                if (CURRENT_STATUS_FILTER === 'ended') {
                    return endDate && endDate < now;
                }
                return false;
            });

            // 2. 按 L2 类别筛选
            const filteredActivities = filteredByStatus.filter(act => {
                if (CURRENT_CATEGORY_FILTER === 'All') {
                    return true;
                }
                return act.category && act.category.includes(CURRENT_CATEGORY_FILTER);
            });

            if (filteredActivities.length === 0) {
                listContainer.innerHTML = `
                    <div class="empty-state">
                        <i class="empty-state-icon fas fa-folder-open"></i>
                        <p>这个分类下暂无活动</p>
                    </div>`;
                return;
            }

            filteredActivities.forEach(activity => {
                const cardHtml = renderActivityCard(activity);
                listContainer.innerHTML += cardHtml;
            });
            
            bindActionButtons();
            updateAllCountdowns(); 
        }

        // ----------------------------------------------------
        // 步骤 6: 单个活动卡片的 HTML 生成
        // ----------------------------------------------------
        function renderActivityCard(activity) {
            // 确定主要类别 (L2)
            const primaryCat = BASE_CATEGORIES.find(cat => activity.category.includes(cat)) || 'Other';
            const styles = CATEGORY_MAP[primaryCat];
            
            let actionButtonHtml = '';
            // ... (动作按钮逻辑不变) ...
            if (activity.link && activity.link !== '#') {
                actionButtonHtml = `
                    <a href="${activity.link}" 
                       target="_blank" 
                       class="action-button" 
                       data-umami-event="click_deep_link"
                       data-umami-event-name="${activity.name}">
                        <i class="fas fa-rocket"></i>
                        ${activity.actionText || '立即参与'}
                    </a>`;
            } else if (activity.StepsText) {
                const steps = activity.StepsText.replace(/"/g, '&quot;');
                actionButtonHtml = `
                    <button class="action-button action-button-voice" 
                            data-activity-id="${activity.id}" 
                            data-steps="${steps}"
                            data-activity-name="${activity.name}">
                        <i class="fas fa-volume-high"></i>
                        播放语音
                    </button>`;
            } else {
                actionButtonHtml = `
                    <button class="action-button opacity-50 cursor-not-allowed" disabled>
                        <i class="fas fa-info-circle"></i>
                        暂无指引
                    </button>`;
            }
            
            let specialNoteBadge = '';
            if (activity.specialNote) {
                specialNoteBadge = `
                    <span class="special-note-badge"
                          data-umami-event="view_special_note"
                          data-umami-event-name="${activity.name}">
                        <i class="fas fa-bell"></i>
                        ${activity.specialNote}
                    </span>`;
            }

            return `
                <div class="task-list-card ${styles.borderClass} ${activity.specialNote ? 'has-special-note' : ''}">
                    
                    ${specialNoteBadge}

                    <span class="countdown-badge" 
                          data-endtime="${activity.endDate}" 
                          data-starttime="${activity.startDate}" 
                          id="timer-${activity.id}">
                        计算中...
                    </span>

                    <div class="task-main-content">
                        <div class="task-icon ${styles.iconClass}">
                            <i class="fa-solid ${styles.faIcon}"></i>
                        </div>
                        <div class="task-content">
                            <div class="task-title">${activity.name || '活动名称缺失'}</div>
                            <div class="task-subtitle">${activity.description || '暂无详细描述。'}</div>
                        </div>
                    </div>

                    <div class="task-action-bar">
                        <button class="share-button" 
                                data-activity-id="${activity.id}" 
                                data-activity-name="${activity.name}">
                            <i class="fas fa-share-alt"></i>
                            分享
                        </button>
                        
                        ${actionButtonHtml}
                    </div>
                </div>
            `;
        }

        // ----------------------------------------------------
        // 步骤 7: 绑定事件
        // ----------------------------------------------------
        function bindActionButtons() {
            // 绑定语音按钮
            document.querySelectorAll('.action-button-voice').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const steps = btn.getAttribute('data-steps');
                    const name = btn.getAttribute('data-activity-name');
                    
                    umami.track('play_voice_guide', { name: name });
                    playSpeech(steps, btn);
                });
            });

            // 绑定分享按钮
            document.querySelectorAll('.share-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const id = btn.getAttribute('data-activity-id');
                    const name = btn.getAttribute('data-activity-name');
                    
                    umami.track('click_share', { name: name });
                    shareActivity(id, btn);
                });
            });
        }
        
        // ----------------------------------------------------
        // 步骤 8: [【 核心BUG修复 】] 语音播放 (已修复)
        // ----------------------------------------------------
        function playSpeech(text, buttonElement) {
            const isCurrentlySpeaking = synth.speaking;
            const isSameText = currentUtterance && currentUtterance.text === text;

            // 1. 停止任何当前语音
            if (isCurrentlySpeaking) {
                synth.cancel();
            }

            // 2. 如果用户点击了正在播放的同一个按钮，目的就是“停止”
            if (isCurrentlySpeaking && isSameText) {
                // cancel() 会自动触发 onend，那里会清理按钮
                return;
            }
            
            // 3. 播放新语音
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'zh-CN';
            currentUtterance.rate = 0.8; // 慢速
            
            // 清理所有“播放中”的按钮
            document.querySelectorAll('.action-button-voice.speaking').forEach(btn => {
                btn.classList.remove('speaking');
                btn.innerHTML = `<i class="fas fa-volume-high"></i> 播放语音`;
            });

            // 设置当前按钮为“播放中”
            if (buttonElement) {
                buttonElement.classList.add('speaking');
                buttonElement.innerHTML = `<i class="fas fa-wave-square"></i> 播放中...`;
            }

            currentUtterance.onend = () => {
                if (buttonElement) {
                    buttonElement.classList.remove('speaking');
                    buttonElement.innerHTML = `<i class="fas fa-volume-high"></i> 播放语音`;
                }
                currentUtterance = null;
            };
            
            currentUtterance.onerror = (event) => {
                console.error('SpeechSynthesis 错误:', event);
                if (buttonElement) {
                    buttonElement.classList.remove('speaking');
                    buttonElement.innerHTML = `<i class="fas fa-volume-high"></i> 播放语音`;
                }
                currentUtterance = null;
            };

            synth.speak(currentUtterance);
        }

        function stopSpeech() {
            // 这是一个辅助函数，以防万一
            if (synth.speaking) {
                synth.cancel();
            }
            // onend 事件会处理按钮状态
            document.querySelectorAll('.action-button-voice.speaking').forEach(btn => {
                btn.classList.remove('speaking');
                btn.innerHTML = `<i class="fas fa-volume-high"></i> 播放语音`;
            });
            currentUtterance = null;
        }

        // ----------------------------------------------------
        // 步骤 9: 分享功能
        // ----------------------------------------------------
        function shareActivity(activityId, buttonElement) {
            // ... (分享逻辑不变) ...
            const shareUrl = `${window.location.origin}${window.location.pathname.replace('bank.html', 'go.html')}?id=${activityId}`;
            
            try {
                const tempInput = document.createElement('textarea');
                tempInput.value = `快来看看这个活动！\n${shareUrl}`;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = `<i class="fas fa-check"></i> 已复制!`;
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                }, 2000);

            } catch (err) {
                console.error('复制失败:', err);
                alert(`请手动复制链接：\n${shareUrl}`);
            }
        }

        // ----------------------------------------------------
        // 步骤 10: 倒计时功能
        // ----------------------------------------------------
        function getRemainingTime(activity, badgeElement) {
            // ... (倒计时逻辑不变) ...
            const now = new Date().getTime();
            const startDate = activity.startDate ? new Date(activity.startDate).getTime() : null;
            const endDate = activity.endDate ? new Date(activity.endDate).getTime() : null;

            badgeElement.classList.remove('expired-badge', 'upcoming-badge');

            if (endDate && endDate < now) {
                badgeElement.textContent = '已过期';
                badgeElement.classList.add('expired-badge');
                return;
            }
            if (startDate && startDate > now) {
                const distance = startDate - now;
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                let timeString = '';
                if (days > 1) timeString = `${days} 天后`;
                else if (days === 1 || hours > 1) timeString = `${days * 24 + hours} 小时后`;
                else timeString = `即将开始`;

                badgeElement.textContent = `${timeString}`;
                badgeElement.classList.add('upcoming-badge');
                return;
            }
            if (endDate) {
                const distance = endDate - now;
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));

                let timeString = '';
                if (days > 1) timeString = `${days} 天`;
                else if (days === 1 || hours > 0) timeString = `${days * 24 + hours} 时`;
                else timeString = `${minutes} 分`;

                badgeElement.textContent = `剩余 ${timeString}`;
                return;
            }
            badgeElement.textContent = '长期';
        }

        function startCountdownUpdater() {
            setInterval(updateAllCountdowns, 60000); 
        }

        function updateAllCountdowns() {
            const timerElements = document.querySelectorAll('.countdown-badge');
            timerElements.forEach(badge => {
                const activity = {
                    endDate: badge.getAttribute('data-endtime'),
                    startDate: badge.getAttribute('data-starttime')
                };
                getRemainingTime(activity, badge);
            });
        }
    </script>

</body>
</html>
