<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¡é’±ä»»åŠ¡ä¸­å¿ƒ</title>
    <!-- å¼•å…¥ Tailwind CSS (é€šè¿‡ CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Font Awesome å›¾æ ‡åº“ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="./manifest.json">
    <style>
        /* ç¡®ä¿é¡µé¢å­—ä½“å’ŒåŸºç¡€æ ·å¼ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
            color: #333;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ å›ºå®šæ ·å¼ */
        .top-bar {
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }

        /* ä»»åŠ¡å¡ç‰‡æ ·å¼ */
        .task-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        /* åº•éƒ¨å¯¼èˆªæ å›ºå®šæ ·å¼ */
        .bottom-nav {
            box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
            z-index: 20;
        }
        .nav-item {
            transition: color 0.2s, transform 0.2s;
        }
        .nav-item.active {
            color: #4f46e5; /* indigo-600 */
            font-weight: 600;
        }

        /* é“¶è¡Œç­›é€‰æŒ‰é’®æ ·å¼ */
        .bank-filter-btn {
            white-space: nowrap;
            padding: 0.5rem 1.25rem;
            border: 1px solid #e5e7eb;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .bank-filter-btn.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }

        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .custom-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .custom-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        /* å¤´éƒ¨Logoå’Œè¿”å›æŒ‰é’®åŒºåŸŸçš„æ ·å¼ä¿®æ­£ */
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .logo-area {
            display: flex;
            align-items: center;
        }
    </style>
</head>
<body class="min-h-screen pb-20">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  (å·²ä¿®å¤Logoå’Œè¿”å›æŒ‰é’®) -->
    <header class="top-bar sticky top-0 bg-white p-4 shadow-md">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="header-content">
                <div class="logo-area">
                    <img src="./assets/app_logo.png" onerror="this.src='https://placehold.co/40x40/4f46e5/ffffff?text=GB'" alt="æ…§ä¼´ç®¡å®¶ Logo" class="w-10 h-10 rounded-full mr-2">
                    <h1 class="text-xl font-bold text-gray-800">æ…§ä¼´ç®¡å®¶ - æ¡é’±ä»»åŠ¡ä¸­å¿ƒ</h1>
                </div>
                <a href="./index.html" class="text-gray-500 hover:text-indigo-600 transition duration-150">
                    <i class="fas fa-arrow-left text-xl"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <!-- é“¶è¡Œç­›é€‰å™¨ -->
        <section class="mb-6">
            <div class="bg-white p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold mb-3 text-gray-700">ç­›é€‰é“¶è¡Œ</h2>
                <!-- é“¶è¡Œç­›é€‰æŒ‰é’®å®¹å™¨ -->
                <div id="bank-filters" class="flex overflow-x-auto space-x-3 pb-2 custom-scrollbar">
                    <!-- æŒ‰é’®å°†ç”± JS åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </section>

        <!-- ä»»åŠ¡åˆ†ç±»åŒºåŸŸ -->
        <div class="space-y-8">
            <!-- æ—¥å¸¸æ´»åŠ¨åŒºåŸŸ -->
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-indigo-500 pb-1">ğŸ“… æ—¥å¸¸æ´»åŠ¨</h2>
                <div id="routine-tasks-list" class="space-y-4">
                    <!-- æ—¥å¸¸æ´»åŠ¨ä»»åŠ¡å°†åœ¨æ­¤å¤„åŠ è½½ -->
                    <p class="text-center text-gray-500">æ­£åœ¨åŠ è½½ä»»åŠ¡...</p>
                </div>
            </section>

            <!-- ç¼´è´¹æ´»åŠ¨åŒºåŸŸ -->
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-green-500 pb-1">ğŸ’³ ç¼´è´¹æ´»åŠ¨</h2>
                <div id="payment-tasks-list" class="space-y-4">
                    <!-- ç¼´è´¹æ´»åŠ¨ä»»åŠ¡å°†åœ¨æ­¤å¤„åŠ è½½ -->
                </div>
            </section>

            <!-- å­˜æ¬¾ç†è´¢æ´»åŠ¨åŒºåŸŸ -->
            <section>
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-yellow-500 pb-1">ğŸ’° å­˜æ¬¾ç†è´¢æ´»åŠ¨</h2>
                <div id="savings-tasks-list" class="space-y-4">
                    <!-- å­˜æ¬¾ç†è´¢æ´»åŠ¨ä»»åŠ¡å°†åœ¨æ­¤å¤„åŠ è½½ -->
                </div>
            </section>
        </div>
    </main>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <nav class="bottom-nav fixed bottom-0 left-0 right-0 bg-white p-3 border-t">
        <div class="max-w-7xl mx-auto flex justify-around">
            <a href="./index.html" class="nav-item flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs mt-1">é¦–é¡µ</span>
            </a>
            <a href="./checkin.html" class="nav-item flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <i class="fas fa-check-square text-xl"></i>
                <span class="text-xs mt-1">ç­¾åˆ°</span>
            </a>
            <a href="./video.html" class="nav-item flex flex-col items-center text-gray-500 hover:text-indigo-600">
                <i class="fas fa-video text-xl"></i>
                <span class="text-xs mt-1">çœ‹è§†é¢‘èµš</span>
            </a>
            <a href="./bank.html" class="nav-item flex flex-col items-center text-indigo-600 active">
                <i class="fas fa-university text-xl"></i>
                <span class="text-xs mt-1">æ¡é’±ä»»åŠ¡</span>
            </a>
        </div>
    </nav>

    <!-- JavaScript æ•°æ®å¤„ç†å’Œæ¸²æŸ“é€»è¾‘ -->
    <script>
        // å£°æ˜å…¨å±€å˜é‡ç”¨äºå­˜å‚¨æ‰€æœ‰æ´»åŠ¨æ•°æ®
        let ALL_ACTIVITIES = [];
        // è·Ÿè¸ªå½“å‰é€‰ä¸­çš„é“¶è¡Œ
        let SELECTED_BANK = 'å…¨éƒ¨é“¶è¡Œ';

        /**
         * è¾…åŠ©å‡½æ•°ï¼šåˆ›å»ºä»»åŠ¡å¡ç‰‡çš„ HTML ç»“æ„
         * @param {Object} activity - æ´»åŠ¨å¯¹è±¡
         * @returns {string} - HTML å­—ç¬¦ä¸²
         */
        function createTaskCard(activity) {
            // ä½¿ç”¨å°å†™å­—æ®µåï¼Œä¸ activities.json ä¿æŒä¸€è‡´
            const name = activity.name || 'æœªçŸ¥ä»»åŠ¡';
            const points = activity.points || '??';
            const sourceApp = activity.sourceApp || 'æœªçŸ¥æ¥æº';
            const link = activity.link || '#';
            const isCompleted = activity.isCompleted || false; // å‡è®¾æ•°æ®ä¸­å¯èƒ½æœ‰å®ŒæˆçŠ¶æ€

            const buttonClass = isCompleted
                ? 'bg-gray-400 cursor-not-allowed'
                : 'bg-indigo-500 hover:bg-indigo-600';
            const buttonText = isCompleted ? 'å·²å®Œæˆ' : 'å»å®Œæˆ';

            return `
                <div class="task-card bg-white p-4 rounded-xl flex items-center justify-between border-l-4 border-indigo-500">
                    <div class="flex-grow">
                        <h3 class="text-lg font-semibold text-gray-800">${name}</h3>
                        <p class="text-sm text-gray-500 mt-1">
                            æ¥æº: <span class="font-medium text-gray-600">${sourceApp}</span>
                        </p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-lg font-bold text-red-500">${points} ç§¯åˆ†</span>
                        <a href="${link}" target="_blank" class="w-20 py-2 text-sm text-white rounded-lg transition duration-200 text-center ${buttonClass}">
                            ${buttonText}
                        </a>
                    </div>
                </div>
            `;
        }

        /**
         * æ¸²æŸ“ç­›é€‰åçš„æ´»åŠ¨åˆ°å„è‡ªçš„åˆ†ç±»å®¹å™¨ä¸­
         */
        function renderActivities() {
            // æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡åˆ—è¡¨
            document.getElementById('routine-tasks-list').innerHTML = '<p class="text-center text-gray-500">è¯¥åˆ†ç±»æš‚æ— ä»»åŠ¡</p>';
            document.getElementById('payment-tasks-list').innerHTML = '<p class="text-center text-gray-500">è¯¥åˆ†ç±»æš‚æ— ä»»åŠ¡</p>';
            document.getElementById('savings-tasks-list').innerHTML = '<p class="text-center text-gray-500">è¯¥åˆ†ç±»æš‚æ— ä»»åŠ¡</p>';

            const routineTasks = [];
            const paymentTasks = [];
            const savingsTasks = [];

            // 1. ç­›é€‰é“¶è¡Œ
            const filteredByBank = ALL_ACTIVITIES.filter(activity =>
                (SELECTED_BANK === 'å…¨éƒ¨é“¶è¡Œ' || activity.sourceApp === SELECTED_BANK) &&
                activity.category && activity.category.includes('Bank') // å¿…é¡»æ˜¯é“¶è¡Œä»»åŠ¡
            );

            // 2. æŒ‰å­åˆ†ç±»åˆ†é…ä»»åŠ¡
            filteredByBank.forEach(activity => {
                const category = activity.category || [];

                if (category.includes('æ—¥å¸¸æ´»åŠ¨')) {
                    routineTasks.push(createTaskCard(activity));
                }
                if (category.includes('ç¼´è´¹æ´»åŠ¨')) {
                    paymentTasks.push(createTaskCard(activity));
                }
                if (category.includes('å­˜æ¬¾ç†è´¢æ´»åŠ¨')) {
                    savingsTasks.push(createTaskCard(activity));
                }
            });

            // 3. æ¸²æŸ“åˆ° DOM
            const renderTasks = (taskList, containerId) => {
                const container = document.getElementById(containerId);
                if (taskList.length > 0) {
                    container.innerHTML = taskList.join('');
                } else {
                     // ä¿æŒé»˜è®¤çš„â€œæš‚æ— ä»»åŠ¡â€æç¤º
                }
            };

            renderTasks(routineTasks, 'routine-tasks-list');
            renderTasks(paymentTasks, 'payment-tasks-list');
            renderTasks(savingsTasks, 'savings-tasks-list');
        }

        /**
         * åŠ¨æ€åˆå§‹åŒ–é“¶è¡Œç­›é€‰æŒ‰é’®
         */
        function initBankFilters() {
            const filtersContainer = document.getElementById('bank-filters');
            filtersContainer.innerHTML = ''; // æ¸…ç©ºç°æœ‰æŒ‰é’®

            // æ”¶é›†æ‰€æœ‰é“¶è¡Œåç§° (SourceApp)
            const bankNames = new Set();
            ALL_ACTIVITIES.forEach(activity => {
                // åªè€ƒè™‘ä¸»åˆ†ç±»æ˜¯ 'Bank' çš„æ´»åŠ¨
                if (activity.category && activity.category.includes('Bank') && activity.sourceApp) {
                    bankNames.add(activity.sourceApp);
                }
            });

            // æ€»æ˜¯æ·»åŠ  'å…¨éƒ¨é“¶è¡Œ' æŒ‰é’®
            const allBankBtn = document.createElement('button');
            allBankBtn.textContent = 'å…¨éƒ¨é“¶è¡Œ';
            allBankBtn.className = 'bank-filter-btn rounded-full active';
            allBankBtn.addEventListener('click', () => handleFilterClick('å…¨éƒ¨é“¶è¡Œ', allBankBtn));
            filtersContainer.appendChild(allBankBtn);

            // æ·»åŠ å…¶ä»–é“¶è¡ŒæŒ‰é’®
            bankNames.forEach(bankName => {
                const button = document.createElement('button');
                button.textContent = bankName;
                button.className = 'bank-filter-btn rounded-full';
                button.addEventListener('click', () => handleFilterClick(bankName, button));
                filtersContainer.appendChild(button);
            });
        }

        /**
         * å¤„ç†é“¶è¡Œç­›é€‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶
         * @param {string} bankName - è¢«é€‰ä¸­çš„é“¶è¡Œåç§°
         * @param {HTMLElement} clickedButton - è¢«ç‚¹å‡»çš„æŒ‰é’®å…ƒç´ 
         */
        function handleFilterClick(bankName, clickedButton) {
            SELECTED_BANK = bankName;

            // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„ active çŠ¶æ€
            document.querySelectorAll('.bank-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // ç»™å½“å‰ç‚¹å‡»çš„æŒ‰é’®æ·»åŠ  active çŠ¶æ€
            clickedButton.classList.add('active');

            // é‡æ–°æ¸²æŸ“ä»»åŠ¡
            renderActivities();
        }


        /**
         * åˆå§‹åŒ–å‡½æ•°ï¼šæ‹‰å–æ•°æ®å¹¶å¯åŠ¨åº”ç”¨
         */
        async function initializeBankPage() {
            try {
                // 1. æ‹‰å– activities.json æ•°æ®
                const response = await fetch('./activities.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                ALL_ACTIVITIES = data.activities || []; // å‡è®¾æ•°æ®ç»“æ„ä¸º { activities: [...] }

                // 2. åˆå§‹åŒ–é“¶è¡Œç­›é€‰å™¨
                initBankFilters();

                // 3. é¦–æ¬¡æ¸²æŸ“ï¼ˆé»˜è®¤æ˜¾ç¤ºæ‰€æœ‰é“¶è¡Œçš„æ´»åŠ¨ï¼‰
                renderActivities();

            } catch (error) {
                console.error("æ— æ³•åŠ è½½æˆ–å¤„ç†æ´»åŠ¨æ•°æ®:", error);
                document.getElementById('routine-tasks-list').innerHTML = '<p class="text-center text-red-500">æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ activities.json æ–‡ä»¶ã€‚</p>';
                document.getElementById('payment-tasks-list').innerHTML = '';
                document.getElementById('savings-tasks-list').innerHTML = '';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initializeBankPage);
    </script>
</body>
</html>
