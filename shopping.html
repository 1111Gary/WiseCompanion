<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>慧伴管家 - 省钱秘籍</title>
    
    <script async defer 
        data-website-id="7b5c80e8-218d-4850-a9f3-d3764a059fed" 
        src="https://umami.example.com/script.js" 
        data-do-not-track="true" 
        data-domains="1111gary.github.io"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="慧伴管家">
    <link rel="apple-touch-icon" href="./assets/icon_apple.png">
    
    <style>
        /* ---------------------------------------------------- */
        /* 核心主题变量 */
        /* ---------------------------------------------------- */
        :root {
            --color-bg-dark: #0A1322; 
            --color-card-bg: #1A2233; 
            --color-primary: #00BFFF; 
            --color-secondary: #FF69B4; 
            --color-text-light: #E0E7FF;
            --color-text-muted: #9CA3AF;
            --color-highlight: #FFD700; 
            --color-bank-bg: #1F2A40; 
            --color-success: #34D399; 
            --color-special-note: #F59E0B; 
            --color-premium-border: linear-gradient(135deg, var(--color-highlight), #FF69B4);
            
            /* Shopping 页面的主题色（已优化配色） */
            --color-shopping-1: #A78BFA; /* PaymentDiscount - 购物有优惠 (紫色/保留) */
            --color-shopping-2: #F59E0B; /* PaymentBill - 缴费有优惠 (活力橙/新) */
            --color-shopping-3: #2DD4BF; /* TravelDiscount - 出行有优惠 (海洋青/新) */
        }
        
        /* ---------------------------------------------------- */
        /* 基础布局和头部/底部导航 (与 bank.html 一致) */
        /* ---------------------------------------------------- */
        body { 
            background-color: var(--color-bg-dark); 
            color: var(--color-text-light); 
            padding-bottom: calc(85px + env(safe-area-inset-bottom)); 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        .header-bar-fixed { 
            padding-top: calc(15px + env(safe-area-inset-top)); 
            padding-bottom: 5px; 
            background-color: var(--color-bg-dark);
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }
        .header-logo-group {
            display: flex;
            align-items: center;
        }
        .header-logo {
            width: 32px;
            height: 32px;
            margin-right: 10px;
        }
        .header-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--color-text-light);
        }
        .back-arrow-link {
            color: var(--color-text-light);
            font-size: 1.2rem;
            padding: 5px 10px;
            border-radius: 50%;
            background-color: var(--color-card-bg);
            transition: background-color 0.2s;
        }
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background-color: var(--color-bg-dark);
            border-top: 1px solid #1A2233;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 20;
        }
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--color-text-muted);
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s ease;
            padding: 5px;
            flex-grow: 1;
            max-width: 20%;
        }
        .tab-item.active { color: var(--color-primary); }
        .tab-icon {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }

        /* ---------------------------------------------------- */
        /* 内容卡片和筛选器样式 */
        /* ---------------------------------------------------- */
        .main-banner-card {
            background: linear-gradient(135deg, #0f1627, #1a2233);
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            border: 3px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            border-image: linear-gradient(to right, var(--color-primary), var(--color-highlight));
            border-image-slice: 1;
            box-shadow: 0 0 15px rgba(0, 191, 255, 0.5), 0 0 30px rgba(255, 215, 0, 0.3);
            margin-bottom: 1.5rem;
            position: relative;
        }
        .main-banner-card h1 {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--color-text-light);
            text-shadow: 0 0 5px var(--color-highlight);
        }
        
        /* 平台筛选器容器 - Sticky 样式 */
        .filter-container {
            margin-bottom: 2rem;
            padding: 10px 0;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .filter-container::-webkit-scrollbar { display: none; }
        .filter-container.sticky-top-16 {
            position: sticky;
            top: 60px; /* 固定在头部下方 */
            z-index: 5; 
            background-color: var(--color-bg-dark); 
            border-bottom: 1px solid var(--color-card-bg); 
            margin-left: -1rem; 
            margin-right: -1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .filter-button {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: var(--color-card-bg);
            color: var(--color-text-muted);
            border: 2px solid var(--color-card-bg);
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .filter-button.active {
            background-color: var(--color-primary);
            color: var(--color-bg-dark);
            border-color: var(--color-primary);
            box-shadow: 0 0 8px rgba(0, 191, 255, 0.8);
        }
        .filter-button i { margin-right: 6px; }

        /* 状态筛选器样式 (新增) */
        .status-filter-container {
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            margin-top: 10px;
            background-color: var(--color-bg-dark); 
            border-radius: 10px;
        }
        .status-button {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-text-muted);
            background-color: transparent;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .status-button.active {
            color: var(--color-text-light);
            background-color: var(--color-card-bg);
            border-color: var(--color-primary);
            box-shadow: 0 0 5px rgba(0, 191, 255, 0.5);
        }

        /* 分区标题卡片 */
        .section-title-card {
            background: linear-gradient(135deg, #0f1627, #1a2233);
            border-radius: 12px;
            padding: 15px 20px;
            text-align: left;
            border: 2px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            border-image: linear-gradient(to right, var(--color-primary), var(--color-highlight));
            border-image-slice: 1;
            box-shadow: 0 0 8px rgba(0, 191, 255, 0.3);
            margin-top: 2rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .section-title-card h2 {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--color-text-light);
        }
        .section-description {
            color: var(--color-text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem; 
            padding-left: 5px;
        }
        
        /* 活动卡片样式 */
        .task-list-card {
            background-color: var(--color-bank-bg);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            border-left: 5px solid; 
            position: relative;
        }
        .task-list-card:hover {
            background-color: #25334c;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        
        /* 核心分类配色 */
        .task-shopping-1 { border-left-color: var(--color-shopping-1); } /* 购物有优惠 (紫色) */
        .task-shopping-2 { border-left-color: var(--color-shopping-2); } /* 缴费有优惠 (活力橙) */
        .task-shopping-3 { border-left-color: var(--color-shopping-3); } /* 出行有优惠 (海洋青) */

        .icon-shopping-1 { background-color: var(--color-shopping-1); }
        .icon-shopping-2 { background-color: var(--color-shopping-2); }
        .icon-shopping-3 { background-color: var(--color-shopping-3); }

        .task-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            color: var(--color-bg-dark); 
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .special-note-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background-color: var(--color-special-note);
            color: var(--color-bg-dark);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            z-index: 5;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.7);
        }
        .countdown-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--color-secondary);
            color: var(--color-bg-dark);
            padding: 4px 10px;
            border-top-right-radius: 15px;
            border-bottom-left-radius: 15px;
            font-size: 0.75rem;
            font-weight: 700;
            z-index: 4;
        }
        .special-note-badge + .countdown-badge {
            top: 40px;
            right: 15px;
            border-radius: 8px;
        }
        .task-main-content {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .task-content {
            flex-grow: 1;
            min-width: 0;
        }
        .task-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--color-text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 90px; 
        }
        .has-special-note .task-title {
            padding-right: 120px;
        }
        .task-subtitle {
            font-size: 0.8rem;
            color: var(--color-text-muted);
            white-space: normal; 
            line-height: 1.4;
            margin-top: 4px;
        }
        .task-action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid var(--color-card-bg);
        }
        .share-button {
            background-color: var(--color-card-bg);
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 9999px;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .action-button {
            background-color: var(--color-primary);
            color: var(--color-bg-dark);
            font-weight: 700;
            padding: 8px 18px;
            border-radius: 9999px;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-align: center;
            min-width: 100px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .action-button-voice {
            background-color: var(--color-success);
        }
        .action-button-voice.speaking {
            background-color: var(--color-secondary);
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .premium-card {
            background: var(--color-card-bg);
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            border: 3px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            border-image: var(--color-premium-border);
            border-image-slice: 1;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4), 0 0 30px rgba(255, 105, 180, 0.2);
            margin-top: 2rem;
            margin-bottom: 1rem;
            position: relative;
            text-decoration: none;
            display: block;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>

    <div class="header-bar-fixed px-4">
        <div class="header-logo-group">
            <img src="./assets/icon_apple.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/00BFFF/ffffff?text=L'" alt="Logo" class="header-logo rounded-md shadow-lg">
            <h1 class="header-title">慧伴管家</h1>
        </div>
        <a href="./index.html" class="back-arrow-link" title="返回首页">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>

    <main class="container mx-auto px-4 py-4">
        
        <div class="main-banner-card">
            <h1>省钱秘籍</h1>
            <p class="text-sm text-gray-400 mt-2">点击下方按钮，仅显示您关注的平台活动</p>
        </div>
        
        <div class="filter-container sticky-top-16" id="platform-filter-container">
            <button class="filter-button active" data-platform="All">
                <i class="fas fa-layer-group"></i>
                全部平台
            </button>
            </div>

        <div class="section-title-card">
            <h2 class="flex items-center">
                <i class="fas fa-credit-card mr-3 text-xl" style="color: var(--color-shopping-1);"></i>
                购物有优惠 (PaymentDiscount)
            </h2>
        </div>
        <p class="section-description">
            使用特定支付方式（如XX卡、XXPay）在商店购物时可享受的折扣或优惠。
        </p>
        <div class="status-filter-container" data-category="PaymentDiscount">
            <button class="status-button active" data-status="All">全部</button>
            <button class="status-button" data-status="Active">正在进行</button>
            <button class="status-button" data-status="Upcoming">即将开始</button>
            <button class="status-button" data-status="Expired">已结束</button>
        </div>
        <div id="paymentdiscount-list" class="mt-4">
            </div>
        
        <div class="section-title-card">
            <h2 class="flex items-center">
                <i class="fas fa-receipt mr-3 text-xl" style="color: var(--color-shopping-2);"></i>
                缴费有优惠 (PaymentBill)
            </h2>
        </div>
        <p class="section-description">
            缴纳生活费用（如水电煤、电话费）时可享受的折扣或立减优惠。
        </p>
        <div class="status-filter-container" data-category="PaymentBill">
            <button class="status-button active" data-status="All">全部</button>
            <button class="status-button" data-status="Active">正在进行</button>
            <button class="status-button" data-status="Upcoming">即将开始</button>
            <button class="status-button" data-status="Expired">已结束</button>
        </div>
        <div id="paymentbill-list" class="mt-4">
            </div>
        
        <div class="section-title-card">
            <h2 class="flex items-center">
                <i class="fas fa-plane-departure mr-3 text-xl" style="color: var(--color-shopping-3);"></i>
                出行有优惠 (TravelDiscount)
            </h2>
        </div>
        <p class="section-description">
            乘坐交通工具（如打车、公交、火车、飞机）或预订酒店时的优惠。
        </p>
        <div class="status-filter-container" data-category="TravelDiscount">
            <button class="status-button active" data-status="All">全部</button>
            <button class="status-button" data-status="Active">正在进行</button>
            <button class="status-button" data-status="Upcoming">即将开始</button>
            <button class="status-button" data-status="Expired">已结束</button>
        </div>
        <div id="traveldiscount-list" class="mt-4">
            </div>

        <a href="./premium.html" class="premium-card" 
            onclick="umami.track('click_premium_card', { from: 'shopping' })">
            <h2 class="flex items-center justify-center">
                <i class="fas fa-crown mr-2" style="color: var(--color-highlight);"></i>
                高级会员专区 (敬请期待)
            </h2>
            <p>【独家】AI自动生成省钱秘籍演示视频，长辈也能轻松学会！</p>
        </a>
        
    </main>
    
    <nav class="tab-bar">
        <a href="./index.html" class="tab-item">
            <i class="fas fa-home tab-icon"></i>
            <span>首页</span>
        </a>
        <a href="./checkin.html" class="tab-item">
            <i class="fas fa-gifts tab-icon"></i>
            <span>天天有奖</span>
        </a>
        <a href="./video.html" class="tab-item">
            <i class="fas fa-play-circle tab-icon"></i>
            <span>看视频赚</span>
        </a>
        <a href="./bank.html" class="tab-item">
            <i class="fas fa-hand-holding-usd tab-icon"></i>
            <span>捡钱任务</span>
        </a>
        <span class="tab-item active">
            <i class="fas fa-tags tab-icon"></i>
            <span>省钱秘籍</span>
        </span>
    </nav>
    
    <script>
        // ----------------------------------------------------
        // 全局状态和数据
        // ----------------------------------------------------
        let ALL_ACTIVITIES = [];
        let selectedPlatform = 'All'; 

        // 新增：记录每个分类当前选中的活动状态
        let categoryStatus = {
            'PaymentDiscount': 'All',
            'PaymentBill': 'All',
            'TravelDiscount': 'All',
        };

        // [【 核心 】] 分类与样式的映射 (已更新)
        const CATEGORY_MAP = {
            'PaymentDiscount': { // 购物有优惠
                borderClass: 'task-shopping-1',
                iconClass: 'icon-shopping-1',
                faIcon: 'fa-credit-card'
            },
            'PaymentBill': { // 缴费有优惠 (新)
                borderClass: 'task-shopping-2',
                iconClass: 'icon-shopping-2',
                faIcon: 'fa-receipt'
            },
            'TravelDiscount': { // 出行有优惠 (新)
                borderClass: 'task-shopping-3',
                iconClass: 'icon-shopping-3',
                faIcon: 'fa-plane-departure'
            }
        };

        // 语音 API 健壮性
        const synth = window.speechSynthesis;
        let currentUtterance = null; 
        if (!synth) {
            console.error("【慧伴管家】: 您的浏览器不支持 Web Speech API 语音播放。");
        }
        
        // ----------------------------------------------------
        // 步骤 1: 页面加载主入口
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            // 预热语音
            try {
                if(synth && synth.getVoices().length === 0) {
                    synth.onvoiceschanged = () => {
                        console.log("【慧伴管家】: 语音包已加载。");
                    };
                    synth.getVoices(); 
                }
            } catch(e) {
                console.error("【慧伴管家】: 预热语音引擎失败:", e);
            }
            
            loadAndFetchActivities();
            startCountdownUpdater(); // 启动倒计时更新器
        });

        async function loadAndFetchActivities() {
            try {
                // 注意：请确保您项目根目录下有 activities.json 文件
                const response = await fetch('./activities.json');
                if (!response.ok) {
                    throw new Error('网络响应错误，无法加载 activities.json');
                }
                const data = await response.json();
                
                // 过滤出所有 Shopping 相关的活动
                ALL_ACTIVITIES = data.filter(act => 
                    act.category && (
                        act.category.includes('PaymentDiscount') || 
                        act.category.includes('PaymentBill') || 
                        act.category.includes('TravelDiscount')
                    )
                );

                initPlatformFilters();
                bindStatusFilters(); // 绑定状态筛选器事件
                renderActivities();
                
            } catch (error) {
                console.error("加载活动数据失败:", error);
                const lists = ['paymentdiscount-list', 'paymentbill-list', 'traveldiscount-list'];
                lists.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.innerHTML = `<p class="text-red-400 p-4 text-center">加载活动数据失败。请检查网络或 activities.json 文件。</p>`;
                });
            }
        }

        // ----------------------------------------------------
        // 步骤 2: 初始化平台筛选器按钮
        // ----------------------------------------------------
        function getPlatformIcon(platformName) {
            if (platformName.includes('淘宝') || platformName.includes('天猫')) return 'fab fa-taobao';
            if (platformName.includes('京东')) return 'fa-shield-dog';
            if (platformName.includes('拼多多')) return 'fa-users';
            if (platformName.includes('美团')) return 'fa-hamburger';
            if (platformName.includes('饿了么')) return 'fa-bowl-food';
            if (platformName.includes('微信')) return 'fab fa-weixin';
            if (platformName.includes('支付宝')) return 'fab fa-alipay';
            return 'fa-store'; // 默认图标
        }

        function initPlatformFilters() {
            const container = document.getElementById('platform-filter-container');
            const platforms = new Set();
            
            ALL_ACTIVITIES.forEach(activity => activity.sourceApp && platforms.add(activity.sourceApp));

            // 清空并重新添加 '全部平台' 按钮
            container.innerHTML = `
                <button class="filter-button active" data-platform="All">
                    <i class="fas fa-layer-group"></i>
                    全部平台
                </button>`;
            
            platforms.forEach(platform => {
                const icon = getPlatformIcon(platform); 
                const button = document.createElement('button');
                button.className = 'filter-button';
                button.setAttribute('data-platform', platform);
                button.innerHTML = `<i class="fa-solid ${icon}"></i> ${platform}`;
                
                button.addEventListener('click', (e) => {
                    handleFilterClick(e.currentTarget, platform);
                });
                container.appendChild(button);
            });
            
            container.querySelector('[data-platform="All"]').addEventListener('click', (e) => {
                handleFilterClick(e.currentTarget, 'All');
            });
        }
        
        function handleFilterClick(clickedButton, platformName) {
            if (window.umami) {
                umami.track('filter_platform', { platform: platformName });
            }
            
            selectedPlatform = platformName;
            
            document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            
            stopSpeech();
            renderActivities();
        }

        // 绑定状态筛选器事件 (新增)
        function bindStatusFilters() {
            document.querySelectorAll('.status-filter-container').forEach(container => {
                const category = container.getAttribute('data-category');
                
                container.querySelectorAll('.status-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const btn = e.currentTarget;
                        const status = btn.getAttribute('data-status');

                        // 更新全局状态
                        categoryStatus[category] = status;

                        // 激活样式
                        container.querySelectorAll('.status-button').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');

                        // 重新渲染特定分类
                        renderActivities(category);
                    });
                });
            });
        }
        
        // ----------------------------------------------------
        // 步骤 3: 活动状态判断 (新增)
        // ----------------------------------------------------
        function getActivityStatus(activity) {
            if (!activity.endDate) return 'Active'; // 默认长期活动为正在进行

            const now = new Date().getTime();
            // 确保有 startDate，否则假设为当前时间开始
            const startDate = activity.startDate ? new Date(activity.startDate).getTime() : now - 1; 
            const endDate = new Date(activity.endDate).getTime();

            if (now < startDate) return 'Upcoming'; // 即将开始
            if (now > endDate) return 'Expired'; // 已结束
            return 'Active'; // 正在进行
        }


        // ----------------------------------------------------
        // 步骤 4: 渲染活动
        // ----------------------------------------------------
        function renderActivities(categoryToRender = 'All') {
            const filteredActivities = ALL_ACTIVITIES.filter(activity => 
                selectedPlatform === 'All' || activity.sourceApp === selectedPlatform
            );
            
            // 列表 ID 映射
            const lists = {
                'PaymentDiscount': document.getElementById('paymentdiscount-list'), 
                'PaymentBill': document.getElementById('paymentbill-list'),       
                'TravelDiscount': document.getElementById('traveldiscount-list')   
            };

            // 确定要渲染的分类
            const categories = categoryToRender === 'All' ? Object.keys(lists) : [categoryToRender];

            categories.forEach(category => {
                const listElement = lists[category];
                if (!listElement) return;

                listElement.innerHTML = ''; // 清空列表
                const currentStatus = categoryStatus[category]; // 获取该分类的当前状态

                // 筛选出当前分类的所有活动
                const categoryActivities = filteredActivities.filter(activity => 
                    activity.category && activity.category.includes(category)
                );

                let hasActivities = false;

                categoryActivities.forEach(activity => {
                    const status = getActivityStatus(activity);
                    
                    if (currentStatus === 'All' || currentStatus === status) {
                        hasActivities = true;
                        const cardHtml = renderActivityCard(activity, category, status);
                        listElement.innerHTML += cardHtml;
                    }
                });
                
                // 空数据处理
                if (!hasActivities) {
                    let message = '';
                    if (selectedPlatform !== 'All') {
                        message += `平台 ${selectedPlatform} 下，`;
                    }
                    if (currentStatus !== 'All') {
                        const statusText = currentStatus === 'Active' ? '正在进行' : currentStatus === 'Upcoming' ? '即将开始' : '已结束';
                        message += `没有处于 [${statusText}] 状态的活动。`;
                    } else {
                        message = `该分类下暂无活动。`;
                    }
                    listElement.innerHTML = `<p class="text-gray-400 text-center p-4">在当前筛选条件下，${message}</p>`;
                }
            });
            
            bindActionButtons();
        }

        // ----------------------------------------------------
        // 步骤 5: 单个活动卡片的 HTML 生成
        // ----------------------------------------------------
        // renderActivityCard 函数签名添加 status 参数 (已修改)
        function renderActivityCard(activity, subCategory, status) {
            const styles = CATEGORY_MAP[subCategory] || CATEGORY_MAP['PaymentDiscount'];
            
            let actionButtonHtml = '';
            
            if (activity.link && activity.link !== '#') {
                actionButtonHtml = `
                    <a href="${activity.link}" 
                        target="_blank" 
                        class="action-button ${status === 'Expired' ? 'opacity-50 cursor-not-allowed' : ''}" 
                        data-umami-event="click_deep_link"
                        data-umami-event-name="${activity.name}"
                        ${status === 'Expired' ? 'onclick="event.preventDefault()"' : ''}>
                        <i class="fas fa-rocket"></i>
                        去领取
                    </a>`;
            } else if (activity.StepsText) {
                const steps = activity.StepsText.replace(/"/g, '&quot;');
                actionButtonHtml = `
                    <button class="action-button action-button-voice ${status === 'Expired' ? 'opacity-50 cursor-not-allowed' : ''}" 
                            data-activity-id="${activity.id}" 
                            data-steps="${steps}"
                            data-activity-name="${activity.name}"
                            ${status === 'Expired' ? 'disabled' : ''}>
                        <i class="fas fa-volume-high"></i>
                        播放语音
                    </button>`;
            } else {
                actionButtonHtml = `
                    <button class="action-button opacity-50 cursor-not-allowed" disabled>
                        <i class="fas fa-info-circle"></i>
                        暂无指引
                    </button>`;
            }
            
            let specialNoteBadge = '';
            if (activity.specialNote) {
                specialNoteBadge = `
                    <span class="special-note-badge"
                            data-umami-event="view_special_note"
                            data-umami-event-name="${activity.name}">
                        <i class="fas fa-bell"></i>
                        ${activity.specialNote}
                    </span>`;
            }

            // 修改倒计时标签逻辑 (已修改)
            let countdownBadge = '';
            let cardClassModifier = '';
            
            if (status === 'Upcoming') {
                cardClassModifier = 'opacity-70';
                countdownBadge = `
                    <span class="countdown-badge" style="background-color: var(--color-special-note);">
                        ${activity.startDate ? `距开始 <span id="timer-${activity.id}">计算中...</span>` : '即将开始'}
                    </span>`;
            } else if (status === 'Expired') {
                cardClassModifier = 'opacity-40';
                countdownBadge = `
                    <span class="countdown-badge" style="background-color: #EF4444;">
                        已结束 <i class="fas fa-history"></i>
                    </span>`;
            } else { // Active
                // 只有正在进行的活动才显示倒计时或“长期”
                countdownBadge = `
                    <span class="countdown-badge" data-endtime="${activity.endDate}" id="timer-${activity.id}">
                        ${activity.endDate ? '计算中...' : '长期'} 
                    </span>`;
            }


            return `
                <div class="task-list-card ${styles.borderClass} ${activity.specialNote ? 'has-special-note' : ''} ${cardClassModifier}">
                    ${specialNoteBadge}
                    ${countdownBadge}
                    <div class="task-main-content">
                        <div class="task-icon ${styles.iconClass}">
                            <i class="fa-solid ${styles.faIcon}"></i>
                        </div>
                        <div class="task-content">
                            <div class="task-title">${activity.name || '活动名称缺失'}</div>
                            <div class="task-subtitle">${activity.description || '暂无详细描述。'}</div>
                        </div>
                    </div>
                    <div class="task-action-bar">
                        <button class="share-button" 
                                data-activity-id="${activity.id}" 
                                data-activity-name="${activity.name}">
                            <i class="fas fa-share-alt"></i>
                            分享
                        </button>
                        ${actionButtonHtml}
                    </div>
                </div>
            `;
        }


        // ----------------------------------------------------
        // 步骤 6: 绑定事件 (播放语音、分享)
        // ----------------------------------------------------
        function bindActionButtons() {
            document.querySelectorAll('.action-button-voice').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    if(btn.disabled) return;
                    const steps = btn.getAttribute('data-steps');
                    const name = btn.getAttribute('data-activity-name');
                    
                    if (window.umami) {
                        umami.track('play_voice_guide', { name: name });
                    }
                    playSpeech(steps, btn);
                });
            });

            document.querySelectorAll('.share-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const id = btn.getAttribute('data-activity-id');
                    const name = btn.getAttribute('data-activity-name');
                    
                    if (window.umami) {
                        umami.track('click_share', { name: name });
                    }
                    shareActivity(id, btn);
                });
            });
        }
        
        // ----------------------------------------------------
        // 步骤 7: 语音播放和停止 (与 bank.html 一致)
        // ----------------------------------------------------
        function playSpeech(text, buttonElement) {
            if (!synth || buttonElement.disabled) { return; }
            if (synth.speaking && currentUtterance && currentUtterance.text === text) {
                stopSpeech();
                return;
            }
            stopSpeech();
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'zh-CN'; 
            currentUtterance.onerror = (event) => {
                console.error('【慧伴管家】: 语音播放错误:', event.error);
            };
            if (buttonElement) {
                buttonElement.classList.add('speaking');
                buttonElement.innerHTML = `<i class="fas fa-wave-square"></i> 播放中...`;
            }
            currentUtterance.onend = () => {
                if (buttonElement) {
                    buttonElement.classList.remove('speaking');
                    buttonElement.innerHTML = `<i class="fas fa-volume-high"></i> 播放语音`;
                }
                currentUtterance = null;
            };
            synth.speak(currentUtterance);
        }

        function stopSpeech() {
            if (synth && synth.speaking) {
                synth.cancel();
            }
            document.querySelectorAll('.action-button-voice.speaking').forEach(btn => {
                btn.classList.remove('speaking');
                btn.innerHTML = `<i class="fas fa-volume-high"></i> 播放语音`;
            });
            currentUtterance = null;
        }

        // ----------------------------------------------------
        // 步骤 8: 分享功能 (与 bank.html 一致)
        // ----------------------------------------------------
        function shareActivity(activityId, buttonElement) {
            const shareUrl = `${window.location.origin}${window.location.pathname.replace('shopping.html', 'go.html')}?id=${activityId}`;
            try {
                const tempInput = document.createElement('textarea');
                tempInput.value = `快来看看这个活动！\n${shareUrl}`;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                const originalText = buttonElement.innerHTML;
                buttonElement.innerHTML = `<i class="fas fa-check"></i> 已复制!`;
                setTimeout(() => {
                    buttonElement.innerHTML = originalText;
                }, 2000);
            } catch (err) {
                console.error('复制失败:', err);
                alert(`请手动复制链接：\n${shareUrl}`);
            }
        }

        // ----------------------------------------------------
        // 步骤 9: 倒计时功能 (针对 Active 和 Upcoming)
        // ----------------------------------------------------
        function formatTime(ms) {
            if (ms <= 0) return '已结束';
            const seconds = Math.floor(ms / 1000);
            const days = Math.floor(seconds / (3600 * 24));
            const hours = Math.floor((seconds % (3600 * 24)) / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            
            if (days > 0) return `${days}天${hours}时`;
            if (hours > 0) return `${hours}时${minutes}分`;
            return `${minutes}分${remainingSeconds}秒`;
        }
        
        function updateCountdowns() {
            const timers = document.querySelectorAll('.countdown-badge');
            timers.forEach(timer => {
                const endTimeString = timer.getAttribute('data-endtime');
                
                // 处理 Upcoming
                if (timer.closest('.opacity-70') && timer.parentElement.querySelector('span:first-child').innerText.includes('距开始')) {
                    // 尝试从活动数据中获取 startDate (这里依赖 activity.json 包含 startDate)
                    const activityIdMatch = timer.id.match(/timer-(\d+)/);
                    if (!activityIdMatch) return;
                    const activityId = activityIdMatch[1];
                    const activity = ALL_ACTIVITIES.find(a => a.id == activityId);

                    if (activity && activity.startDate) {
                        const startTime = new Date(activity.startDate).getTime();
                        const now = new Date().getTime();
                        const distance = startTime - now;

                        if (distance > 0) {
                            timer.innerHTML = formatTime(distance);
                        } else {
                            // 活动已开始，重新渲染列表 (理论上状态会自动变为 Active)
                            renderActivities(); 
                        }
                    }
                    return;
                }

                // 处理 Active (有 endDate 的活动)
                if (!endTimeString || endTimeString.toLowerCase() === '长期') {
                    if (!endTimeString) return;
                    timer.innerHTML = `长期`;
                    return;
                }

                const endTime = new Date(endTimeString).getTime();
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    timer.innerHTML = `已结束`;
                    // 触发重新渲染，将活动移入 "已结束" 列表
                    renderActivities(); 
                } else {
                    timer.innerHTML = formatTime(distance);
                }
            });
        }
        
        function startCountdownUpdater() {
            updateCountdowns(); // 立即运行一次
            // 每秒更新一次所有计时器
            setInterval(updateCountdowns, 1000); 
        }
    </script>
</body>
</html>
