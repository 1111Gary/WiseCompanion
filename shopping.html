<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>æ…§ä¼´ç®¡å®¶ - çœé’±ç§˜ç±</title>
    
    <script async defer 
        data-website-id="7b5c80e8-218d-4850-a9f3-d3764a059fed" 
        src="https://umami.example.com/script.js" 
        data-do-not-track="true" 
        data-domains="1111gary.github.io"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="æ…§ä¼´ç®¡å®¶">
    <link rel="apple-touch-icon" href="./assets/icon_apple.png">
    
    <style>
        :root {
            --color-bg-dark: #0A1322; 
            --color-card-bg: #1A2233; 
            /* æ›´æ”¹ Secondary é¢œè‰²ä»¥åŒ¹é…è´­ç‰©ä¸»é¢˜ï¼Œä½¿ç”¨æ›´äº®çš„æ©™è‰²/çº¢è‰²ç³» */
            --color-secondary: #FF69B4; 
            --color-text-light: #E0E7FF;
            --color-text-muted: #9CA3AF;
            --color-highlight: #FFD700; 
            --color-shopping-bg: #1F2A40; 
            --color-success: #34D399; 
            --color-special-note: #F59E0B; 
            --color-premium-border: linear-gradient(135deg, var(--color-highlight), #FF69B4);
            /* å®šä¹‰è´­ç‰©é¡µé¢çš„ä¸»é¢˜è‰²ï¼Œä¾‹å¦‚å“çº¢è‰²/ç”µå•†çº¢ */
            --color-shopping-main: #EC4899; 
        }
        body { 
            background-color: var(--color-bg-dark); 
            color: var(--color-text-light); 
            padding-bottom: calc(85px + env(safe-area-inset-bottom)); 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        /* é¡¶éƒ¨å›ºå®šæ  */
        .header-bar-fixed { 
            padding-top: calc(15px + env(safe-area-inset-top)); 
            padding-bottom: 5px; 
            background-color: var(--color-bg-dark);
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        /* å¹³å°ç­›é€‰æ¡çš„å›ºå®šåŒ…è£…å™¨ */
        .platform-filter-wrapper {
            position: sticky;
            top: 60px; /* ç´§è·Ÿåœ¨ header åé¢ */
            z-index: 9; 
            background-color: var(--color-bg-dark);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.4); 
            padding-top: 5px;
            padding-bottom: 5px;
        }
        
        /* å¹³å°ç­›é€‰æ¡ (Platform Filter) */
        .filter-container {
            margin: 0 0; 
            padding: 0 0;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; 
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .filter-container::-webkit-scrollbar { display: none; }
        
        /* çŠ¶æ€ç­›é€‰æ¡ (Type Filter) - ç¡®ä¿æ¤­åœ†æ ·å¼ */
        .status-filter-container {
            margin-top: 1.5rem; 
            margin-bottom: 2rem;
            display: flex;
            background-color: var(--color-card-bg);
            border-radius: 9999px; 
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        .status-filter-button {
            flex: 1;
            text-align: center;
            padding: 8px 10px;
            border-radius: 9999px; 
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--color-text-muted);
            border: none;
            background-color: transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        /* æ›´æ”¹æ´»åŠ¨é¢œè‰²ä¸ºè´­ç‰©ä¸»é¢˜è‰² */
        .status-filter-button.active {
            background-color: var(--color-shopping-main); 
            color: var(--color-bg-dark);
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.7);
        }

        /* ------------------ å…¶ä»–æ ·å¼ä¿æŒä¸å˜æˆ–å¾®è°ƒ ------------------ */
        .main-banner-card {
            background: linear-gradient(135deg, #0f1627, #1a2233);
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            border: 3px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            /* æ›´æ”¹æ¸å˜è‰²ä»¥åŒ¹é…è´­ç‰©ä¸»é¢˜ */
            border-image: linear-gradient(to right, var(--color-shopping-main), var(--color-highlight));
            border-image-slice: 1;
            box-shadow: 0 0 15px rgba(236, 72, 153, 0.5), 0 0 30px rgba(255, 215, 0, 0.3);
            margin-bottom: 1.5rem;
            position: relative;
        }
        .main-banner-card h1 {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--color-text-light);
            text-shadow: 0 0 5px var(--color-highlight);
        }
        
        .filter-button {
            display: inline-flex;
            align-items: center;
            padding: 8px 15px;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: var(--color-card-bg);
            color: var(--color-text-muted);
            border: 2px solid var(--color-card-bg);
            transition: all 0.2s ease;
            flex-shrink: 0;
        }
        .filter-button.active {
            background-color: var(--color-shopping-main); 
            color: var(--color-bg-dark);
            border-color: var(--color-shopping-main);
            box-shadow: 0 0 8px rgba(236, 72, 153, 0.8);
        }
        .filter-button i { margin-right: 6px; }
        
        .section-title-card {
            background: linear-gradient(135deg, #0f1627, #1a2233);
            border-radius: 12px;
            padding: 15px 20px;
            text-align: left;
            border: 2px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            /* æ›´æ”¹æ¸å˜è‰² */
            border-image: linear-gradient(to right, var(--color-shopping-main), var(--color-highlight));
            border-image-slice: 1;
            box-shadow: 0 0 8px rgba(236, 72, 153, 0.3);
            margin-top: 2rem;
            margin-bottom: 1rem;
            position: relative;
        }
        .section-title-card h2 {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--color-text-light);
        }
        .section-description {
            color: var(--color-text-muted);
            font-size: 0.9rem;
            margin-bottom: 1rem; 
            padding-left: 5px;
        }
        .task-list-card {
            background-color: var(--color-shopping-bg);
            border-radius: 15px;
            padding: 15px 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
            border-left: 5px solid; 
            position: relative;
        }
        /* ä»»åŠ¡å¡ç‰‡æ ·å¼ï¼šä¸è´­ç‰©ä¼˜æƒ ç±»å‹å¯¹åº” */
        .task-deals { border-left-color: var(--color-success); } /* æ—¥å¸¸ç‰¹æƒ  - ç»¿è‰² */
        .task-coupons { border-left-color: var(--color-shopping-main); } /* ä¼˜æƒ ç  - å“çº¢è‰² */
        .task-cashback { border-left-color: var(--color-highlight); } /* è¿”åˆ©æ´»åŠ¨ - é‡‘è‰² */
        
        /* ä»»åŠ¡å›¾æ ‡æ ·å¼ */
        .icon-deals { background-color: var(--color-success); }
        .icon-coupons { background-color: var(--color-shopping-main); } 
        .icon-cashback { background-color: var(--color-highlight); }
        
        /* åŠ¨ä½œæŒ‰é’® */
        .action-button {
            background-color: var(--color-shopping-main);
            color: var(--color-bg-dark);
            font-weight: 700;
            padding: 8px 18px;
            border-radius: 9999px;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-align: center;
            min-width: 100px; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(236, 72, 153, 0.7);
        }
        
        /* å…¶ä»–é€šç”¨æ ·å¼ï¼ˆå€’è®¡æ—¶ã€å¾½ç« ã€åº•éƒ¨å¯¼èˆªæ ç­‰ï¼‰ä¿æŒä¸ bank.html ä¸€è‡´ */
        .countdown-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: var(--color-secondary);
            color: var(--color-bg-dark);
            padding: 4px 10px;
            border-top-right-radius: 15px;
            border-bottom-left-radius: 15px;
            font-size: 0.75rem;
            font-weight: 700;
            z-index: 4;
        }
        .expired-badge { background-color: #EF4444; color: white; }
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 60px;
            background-color: var(--color-bg-dark);
            border-top: 1px solid #1A2233;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 20;
        }
        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--color-text-muted);
            font-size: 0.75rem;
            font-weight: 500;
            transition: color 0.2s ease;
            padding: 5px;
            flex-grow: 1;
            max-width: 20%;
        }
        .tab-item.active { color: var(--color-shopping-main); } 
        .tab-icon { font-size: 1.2rem; margin-bottom: 3px; }
        .header-logo-group { display: flex; align-items: center; }
        .header-logo { width: 32px; height: 32px; margin-right: 10px; }
        .header-title { font-size: 1.2rem; font-weight: 700; color: var(--color-text-light); }
        .back-arrow-link { color: var(--color-text-light); font-size: 1.2rem; padding: 5px 10px; border-radius: 50%; background-color: var(--color-card-bg); transition: background-color 0.2s; }
        
        /* ä»»åŠ¡å¡ç‰‡å†…éƒ¨å¸ƒå±€å’Œæ–‡æœ¬æ ·å¼ */
        .task-main-content { display: flex; align-items: center; width: 100%; }
        .task-icon { width: 40px; height: 40px; border-radius: 8px; color: var(--color-bg-dark); font-size: 1.2rem; display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0; }
        .task-content { flex-grow: 1; min-width: 0; }
        .task-title { font-size: 1rem; font-weight: 700; color: var(--color-text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 90px; }
        .task-subtitle { font-size: 0.8rem; color: var(--color-text-muted); white-space: normal; line-height: 1.4; margin-top: 4px; }
        .task-action-bar { display: flex; justify-content: flex-end; align-items: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid var(--color-card-bg); }
        .share-button { background-color: var(--color-card-bg); color: var(--color-shopping-main); border: 1px solid var(--color-shopping-main); font-weight: 600; padding: 8px 15px; border-radius: 9999px; font-size: 0.8rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; margin-right: 10px;}
        .share-button:hover { background-color: var(--color-shopping-main); color: var(--color-bg-dark); }
        
        .action-button-voice { background-color: var(--color-success); }
        .action-button-voice:hover { box-shadow: 0 0 10px rgba(52, 211, 153, 0.7); }
        .action-button-voice.speaking { background-color: var(--color-secondary); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        
    </style>
</head>
<body>

    <div class="header-bar-fixed px-4">
        <div class="header-logo-group">
            <img src="./assets/icon_apple.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/EC4899/ffffff?text=S'" alt="Logo" class="header-logo rounded-md shadow-lg">
            <h1 class="header-title">æ…§ä¼´ç®¡å®¶</h1>
        </div>
        <a href="./index.html" class="back-arrow-link" title="è¿”å›é¦–é¡µ">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>

    <div id="platform-filter-wrapper" class="platform-filter-wrapper px-4">
        <div class="filter-container" id="platform-filter-container">
            <button class="filter-button active" data-platform="All">
                <i class="fas fa-store-alt"></i>
                å…¨éƒ¨å¹³å°
            </button>
        </div>
    </div>
    
    <main class="container mx-auto px-4 py-4" style="padding-top: 0;">
        
        <div class="main-banner-card">
            <h1>ğŸ›ï¸ çœé’±ç§˜ç±ä»»åŠ¡ä¸­å¿ƒ</h1>
            <p class="text-sm text-gray-400 mt-2">æ±‡é›†å„ç±»ç”µå•†å¹³å°çš„ä¼˜æƒ åˆ¸ã€ä¿ƒé”€å’Œè¿”åˆ©æ´»åŠ¨</p>
        </div>
        
        <div class="status-filter-container">
            <button class="status-filter-button active" data-status="Active">
                <i class="fas fa-percent"></i> æ­£åœ¨ä¼˜æƒ 
            </button>
            <button class="status-filter-button" data-status="Upcoming">
                <i class="fas fa-calendar-alt"></i> å³å°†é¢„å”®
            </button>
            <button class="status-filter-button" data-status="Expired">
                <i class="fas fa-hourglass-end"></i> å·²è¿‡æœŸ
            </button>
        </div>

        
        <div class="section-title-card">
            <h2 class="flex items-center">
                <i class="fas fa-bolt mr-3 text-xl" style="color: var(--color-success);"></i>
                æ—¥å¸¸ç‰¹æƒ  (DailyDeals)
            </h2>
        </div>
        <p class="section-description">
            æ¯æ—¥æˆ–æ¯å‘¨æ›´æ–°çš„é™æ—¶æŠ˜æ‰£ã€ç‰¹ä»·å•†å“å’Œç«‹å‡é‡‘ã€‚
        </p>
        <div id="deals-list">
            </div>
        
        <div class="section-title-card">
            <h2 class="flex items-center">
                <i class="fas fa-ticket-alt mr-3 text-xl" style="color: var(--color-shopping-main);"></i>
                ç‹¬å®¶ä¼˜æƒ ç  (CouponCodes)
            </h2>
        </div>
        <p class="section-description">
            éœ€è¦é¢†å–æˆ–è¾“å…¥ä¼˜æƒ ç æ‰èƒ½ä½¿ç”¨çš„ç‹¬å®¶æŠ˜æ‰£ã€æ»¡å‡åˆ¸ã€‚
        </p>
        <div id="coupon-list">
            </div>
        
        <div class="section-title-card">
            <h2 class="flex items-center">
                <i class="fas fa-wallet mr-3 text-xl" style="color: var(--color-highlight);"></i>
                è¿”åˆ©/é«˜ä»·å€¼æ´»åŠ¨ (Cashback)
            </h2>
        </div>
        <p class="section-description">
            é€šè¿‡è¿”åˆ©å¹³å°æˆ–æŒ‡å®šé“¾æ¥è´­ä¹°ï¼Œè·å¾—é«˜é¢è¿”ç°æˆ–ç§¯åˆ†å¥–åŠ±ã€‚
        </p>
        <div id="cashback-list">
            </div>

        
    </main>
    
    <nav class="tab-bar">
        <a href="./index.html" class="tab-item">
            <i class="fas fa-home tab-icon"></i>
            <span>é¦–é¡µ</span>
        </a>
        <a href="./checkin.html" class="tab-item">
            <i class="fas fa-gifts tab-icon"></i>
            <span>å¤©å¤©æœ‰å¥–</span>
        </a>
        <a href="./video.html" class="tab-item">
            <i class="fas fa-play-circle tab-icon"></i>
            <span>çœ‹è§†é¢‘èµš</span>
        </a>
        <a href="./bank.html" class="tab-item">
            <i class="fas fa-hand-holding-usd tab-icon"></i>
            <span>æ¡é’±ä»»åŠ¡</span>
        </a>
        <span class="tab-item active">
            <i class="fas fa-tags tab-icon"></i>
            <span>çœé’±ç§˜ç±</span>
        </span>
    </nav>
    
    <script>
// ====================================================
// JavaScript æ ¸å¿ƒé€»è¾‘ - ç”¨äºè´­ç‰©ä¼˜æƒ ç­›é€‰å’Œæ¸²æŸ“
// ====================================================

// ----------------------------------------------------
// å…¨å±€çŠ¶æ€å’Œæ•°æ®
// ----------------------------------------------------
let ALL_ACTIVITIES = [];
let selectedPlatform = 'All'; 
let selectedStatus = 'Active'; 

// è´­ç‰©åˆ†ç±»ä¸æ ·å¼çš„æ˜ å°„ (å¯¹åº” HTML ä¸­çš„ Deals, Coupons, Cashback)
const CATEGORY_MAP = {
    'DailyDeals': {
        borderClass: 'task-deals',
        iconClass: 'icon-deals',
        faIcon: 'fa-bolt'
    },
    'CouponCodes': { 
        borderClass: 'task-coupons',
        iconClass: 'icon-coupons',
        faIcon: 'fa-ticket-alt'
    },
    'Cashback': {
        borderClass: 'task-cashback',
        iconClass: 'icon-cashback',
        faIcon: 'fa-wallet'
    }
};

const synth = window.speechSynthesis;
let currentUtterance = null; 
let speakingButton = null; 
if (!synth) {
    console.error("ã€æ…§ä¼´ç®¡å®¶ã€‘: æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ Web Speech API è¯­éŸ³æ’­æ”¾ã€‚");
}

// ----------------------------------------------------
// å®ç”¨å‡½æ•°ï¼šè·å–æ´»åŠ¨çŠ¶æ€ (ä¸ bank.html é€»è¾‘ç›¸åŒ)
// ----------------------------------------------------
function getActivityStatus(activity) {
    const now = new Date();
    const endDate = (activity.endDate && activity.endDate !== 'null') ? new Date(activity.endDate) : null;
    const startDate = (activity.startDate && activity.startDate !== 'null') ? new Date(activity.startDate) : null;

    if (endDate && endDate < now) {
        return 'Expired'; // å·²è¿‡æœŸ
    }
    if (startDate && startDate > now) {
        return 'Upcoming'; // å³å°†é¢„å”®
    }
    return 'Active'; // æ­£åœ¨ä¼˜æƒ 
}

// ----------------------------------------------------
// æ­¥éª¤ 1: é¡µé¢åŠ è½½ä¸»å…¥å£
// ----------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    // é¢„çƒ­è¯­éŸ³å¼•æ“
    try {
        if(synth && synth.getVoices().length === 0) {
            synth.onvoiceschanged = () => {
                console.log("ã€æ…§ä¼´ç®¡å®¶ã€‘: è¯­éŸ³åŒ…å·²åŠ è½½ã€‚");
            };
            synth.getVoices(); 
        }
    } catch(e) {
        console.error("ã€æ…§ä¼´ç®¡å®¶ã€‘: é¢„çƒ­è¯­éŸ³å¼•æ“å¤±è´¥:", e);
    }
    
    loadAndFetchActivities();
    bindStatusFilters();
});

async function loadAndFetchActivities() {
    try {
        // å‡è®¾è´­ç‰©é¡µé¢çš„æ•°æ®ä»ç„¶æ¥è‡ª activities.jsonï¼Œä½†æˆ‘ä»¬åªç­›é€‰å‡ºè´­ç‰©ç›¸å…³çš„
        const response = await fetch('./activities.json');
        if (!response.ok) {
            throw new Error('ç½‘ç»œå“åº”é”™è¯¯ï¼Œæ— æ³•åŠ è½½ activities.json');
        }
        const data = await response.json();
        
        // ç­›é€‰å‡ºå±äº DailyDeals, CouponCodes, Cashback çš„æ´»åŠ¨ (Shopping é¡µé¢ä¸“å±)
        ALL_ACTIVITIES = data.filter(act => 
            act.category && (
                act.category.includes('DailyDeals') ||
                act.category.includes('CouponCodes') ||
                act.category.includes('Cashback')
            )
        );
        
        console.log(`ã€æ…§ä¼´ç®¡å®¶ã€‘: åŠ è½½æˆåŠŸï¼Œæ‰¾åˆ° ${ALL_ACTIVITIES.length} æ¡è´­ç‰©/ä¼˜æƒ æ´»åŠ¨ã€‚`);

        initPlatformFilters();
        renderActivities();
        startCountdownUpdater();
        
    } catch (error) {
        console.error("åŠ è½½æ´»åŠ¨æ•°æ®å¤±è´¥:", error);
        document.getElementById('deals-list').innerHTML = `<p class="text-red-400 p-4 text-center">åŠ è½½æ´»åŠ¨æ•°æ®å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œæˆ– activities.json æ–‡ä»¶ã€‚</p>`;
    }
}

// ----------------------------------------------------
// æ­¥éª¤ 2: å¹³å°ç­›é€‰å™¨é€»è¾‘ (Platform Filter)
// ----------------------------------------------------
function initPlatformFilters() {
    const container = document.getElementById('platform-filter-container');
    
    // ä»æ´»åŠ¨ä¸­æå–å”¯ä¸€çš„å¹³å°åç§°
    const platforms = new Set();
    ALL_ACTIVITIES.forEach(act => {
        if (act.platform) {
            act.platform.split(',').map(p => p.trim()).forEach(p => platforms.add(p));
        }
    });
    
    // æ’åºå¹³å°ï¼Œå¹¶ç”ŸæˆæŒ‰é’®
    const sortedPlatforms = Array.from(platforms).sort();

    sortedPlatforms.forEach(platform => {
        if (platform) {
            const button = document.createElement('button');
            button.className = 'filter-button';
            button.setAttribute('data-platform', platform);
            
            let iconClass;
            switch(platform.toLowerCase()) {
                case 'taobao': iconClass = 'fa-taobaofull'; break; // å‡è®¾æ·˜å®æœ‰è‡ªå®šä¹‰å›¾æ ‡
                case 'jd': iconClass = 'fa-jd'; break; // å‡è®¾äº¬ä¸œæœ‰è‡ªå®šä¹‰å›¾æ ‡
                case 'pdd': iconClass = 'fa-pinduoduo'; break; // å‡è®¾æ‹¼å¤šå¤šæœ‰è‡ªå®šä¹‰å›¾æ ‡
                case 'vipshop': iconClass = 'fa-gem'; break;
                case 'amazon': iconClass = 'fa-amazon'; break;
                default: iconClass = 'fa-shopping-bag';
            }
            // æ³¨æ„ï¼šfa-taobaofull, fa-jd, fa-pinduoduo å¯èƒ½éœ€è¦æ‚¨ä½¿ç”¨è‡ªå®šä¹‰å›¾æ ‡åº“
            button.innerHTML = `<i class="fas ${iconClass}"></i>${platform}`;
            container.appendChild(button);
        }
    });

    // ç»‘å®šç‚¹å‡»äº‹ä»¶
    container.querySelectorAll('.filter-button').forEach(button => {
        button.addEventListener('click', function() {
            container.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            selectedPlatform = this.getAttribute('data-platform');
            renderActivities();
            umami.track('filter_platform', { platform: selectedPlatform });
        });
    });
}

// ----------------------------------------------------
// æ­¥éª¤ 3: çŠ¶æ€ç­›é€‰å™¨é€»è¾‘ (Type Filter)
// ----------------------------------------------------
function bindStatusFilters() {
    document.querySelectorAll('.status-filter-button').forEach(button => {
        button.addEventListener('click', function() {
            document.querySelectorAll('.status-filter-button').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            selectedStatus = this.getAttribute('data-status');
            renderActivities();
            umami.track('filter_status', { status: selectedStatus });
        });
    });
}

// ----------------------------------------------------
// æ­¥éª¤ 4: æ´»åŠ¨æ¸²æŸ“
// ----------------------------------------------------
function renderActivities() {
    // è¿‡æ»¤æ´»åŠ¨
    const filteredActivities = ALL_ACTIVITIES.filter(activity => {
        const platformMatch = selectedPlatform === 'All' || 
                              (activity.platform && activity.platform.includes(selectedPlatform));
        const statusMatch = getActivityStatus(activity) === selectedStatus;
        return platformMatch && statusMatch;
    });

    // æ¸…ç©ºåˆ—è¡¨
    document.getElementById('deals-list').innerHTML = '';
    document.getElementById('coupon-list').innerHTML = '';
    document.getElementById('cashback-list').innerHTML = '';

    // åˆ†ç»„æ¸²æŸ“
    const lists = {
        'DailyDeals': document.getElementById('deals-list'),
        'CouponCodes': document.getElementById('coupon-list'),
        'Cashback': document.getElementById('cashback-list')
    };

    if (filteredActivities.length === 0) {
         Object.values(lists).forEach(list => {
            list.innerHTML = `<p class="text-center text-gray-400 p-8">
                                ğŸ˜­ åœ¨å½“å‰ç­›é€‰æ¡ä»¶ä¸‹ï¼Œæ²¡æœ‰æ‰¾åˆ°ä»»ä½•è´­ç‰©ä¼˜æƒ æ´»åŠ¨ã€‚
                                <br>è¯·å°è¯•æ›´æ¢å¹³å°æˆ–ä¼˜æƒ çŠ¶æ€ã€‚
                              </p>`;
        });
        return;
    }
    
    // æ¸²æŸ“æ´»åŠ¨å¡ç‰‡
    filteredActivities.forEach(activity => {
        const categoryKey = activity.category.find(cat => CATEGORY_MAP[cat]);
        if (!categoryKey) return; 

        const cardHTML = createActivityCard(activity, categoryKey);
        lists[categoryKey].insertAdjacentHTML('beforeend', cardHTML);
    });
    
    // é‡æ–°ç»‘å®šè¯­éŸ³äº‹ä»¶ï¼ˆå› ä¸ºå†…å®¹æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼‰
    bindVoiceEvents();
}

// ----------------------------------------------------
// æ­¥éª¤ 5: åˆ›å»ºæ´»åŠ¨å¡ç‰‡ HTML
// ----------------------------------------------------
function createActivityCard(activity, categoryKey) {
    const { borderClass, iconClass, faIcon } = CATEGORY_MAP[categoryKey];
    const status = getActivityStatus(activity);
    
    let badgeHTML = '';
    let actionButtonHTML = '';
    let specialNoteClass = '';
    
    // å€’è®¡æ—¶å¾½ç« 
    if (status === 'Active' && activity.endDate && activity.endDate !== 'null') {
        badgeHTML = `<span class="countdown-badge" data-end-date="${activity.endDate}">
                         å€’è®¡æ—¶: è®¡ç®—ä¸­...
                     </span>`;
    } else if (status === 'Upcoming' && activity.startDate && activity.startDate !== 'null') {
        badgeHTML = `<span class="countdown-badge" data-start-date="${activity.startDate}">
                         é¢„å”®å€’è®¡æ—¶: è®¡ç®—ä¸­...
                     </span>`;
    } else if (status === 'Expired') {
        badgeHTML = `<span class="countdown-badge expired-badge">å·²è¿‡æœŸ</span>`;
    }
    
    // ç‰¹åˆ«è¯´æ˜å¾½ç«  (é€‚ç”¨äºè´­ç‰©é¡µé¢çš„â€œç‹¬å®¶â€æˆ–â€œé«˜è¿”åˆ©â€)
    if (activity.specialNote) {
        specialNoteClass = 'has-special-note';
        badgeHTML += `<span class="special-note-badge">
                        <i class="fas fa-magic mr-1"></i>${activity.specialNote}
                      </span>`;
    }

    // åŠ¨ä½œæŒ‰é’®
    let actionText = 'æŸ¥çœ‹ä¼˜æƒ ';
    let actionIcon = 'fa-external-link-alt';

    if (categoryKey === 'CouponCodes' && activity.couponCode) {
        actionText = 'å¤åˆ¶å¹¶å‰å¾€';
        actionIcon = 'fa-copy';
    } else if (activity.link) {
        actionText = 'ç«‹å³è´­ä¹°/å‰å¾€';
    }


    actionButtonHTML = `
        <a href="${activity.link || '#'}" target="_blank" class="action-button" 
           onclick="umami.track('click_shopping_action', { id: '${activity.id}', title: '${activity.title}' })">
            <i class="fas ${actionIcon}"></i> ${actionText}
        </a>
    `;

    // å®Œæ•´çš„å¡ç‰‡ç»“æ„
    return `
        <div class="task-list-card ${borderClass} ${specialNoteClass}" data-id="${activity.id}" data-status="${status}">
            ${badgeHTML}
            <div class="task-main-content">
                <div class="task-icon ${iconClass}">
                    <i class="fas ${faIcon}"></i>
                </div>
                <div class="task-content">
                    <div class="task-title">${activity.title}</div>
                    <div class="task-subtitle">${activity.description}</div>
                </div>
            </div>
            <div class="task-action-bar">
                <button class="share-button" onclick="shareActivity('${activity.title}', '${activity.link}')">
                    <i class="fas fa-share-alt"></i>åˆ†äº«
                </button>
                <button class="action-button action-button-voice" 
                        data-text="${activity.title}ã€‚${activity.description}"
                        data-id="${activity.id}">
                    <i class="fas fa-volume-up"></i> æœ—è¯»
                </button>
                ${actionButtonHTML}
            </div>
        </div>
    `;
}

// ----------------------------------------------------
// æ­¥éª¤ 6: å€’è®¡æ—¶æ›´æ–° (ä¸ bank.html é€»è¾‘ç›¸åŒ)
// ----------------------------------------------------
function formatTime(ms) {
    const totalSeconds = Math.floor(ms / 1000);
    if (totalSeconds < 0) return "å·²ç»“æŸ";

    const days = Math.floor(totalSeconds / (3600 * 24));
    const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;

    let parts = [];
    if (days > 0) parts.push(`${days}å¤©`);
    parts.push(`${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`);
    
    return parts.join(' ');
}

function updateCountdowns() {
    document.querySelectorAll('.countdown-badge[data-end-date]').forEach(badge => {
        const endDate = new Date(badge.getAttribute('data-end-date'));
        const remaining = endDate.getTime() - new Date().getTime();
        
        if (remaining > 0) {
            badge.innerHTML = `å€’è®¡æ—¶: ${formatTime(remaining)}`;
        } else {
            badge.innerHTML = `å·²ç»“æŸ`;
            badge.classList.add('expired-badge');
            badge.removeAttribute('data-end-date'); // åœæ­¢æ›´æ–°
            // æç¤ºï¼šå¯ä»¥åœ¨è¿™é‡Œè§¦å‘é‡æ–°æ¸²æŸ“æ¥ç§»é™¤å·²ç»“æŸçš„æ´»åŠ¨
            if (selectedStatus === 'Active') {
                renderActivities();
            }
        }
    });

    document.querySelectorAll('.countdown-badge[data-start-date]').forEach(badge => {
        const startDate = new Date(badge.getAttribute('data-start-date'));
        const remaining = startDate.getTime() - new Date().getTime();
        
        if (remaining > 0) {
            badge.innerHTML = `é¢„å”®å€’è®¡æ—¶: ${formatTime(remaining)}`;
        } else {
            // æ´»åŠ¨å·²å¼€å§‹ï¼Œé‡æ–°æ¸²æŸ“ä»¥ç§»åŠ¨åˆ° Active çŠ¶æ€åˆ—è¡¨ï¼ˆå¦‚æœé€‚ç”¨ï¼‰
            badge.innerHTML = `å·²å¼€å§‹`;
            badge.removeAttribute('data-start-date'); 
            if (selectedStatus === 'Upcoming') {
                renderActivities();
            }
        }
    });
}

let countdownInterval = null;
function startCountdownUpdater() {
    if (countdownInterval) clearInterval(countdownInterval); 
    countdownInterval = setInterval(updateCountdowns, 1000);
}


// ----------------------------------------------------
// æ­¥éª¤ 7: è¯­éŸ³æœ—è¯»å’Œåˆ†äº« (ä¸ bank.html é€»è¾‘ç›¸åŒ)
// ----------------------------------------------------

function getSelectedVoice() {
    // å°è¯•è·å–ä¸­æ–‡å¥³å£°ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤
    const voices = synth.getVoices();
    return voices.find(voice => voice.lang === 'zh-CN' && voice.name.includes('Tingting')) ||
           voices.find(voice => voice.lang === 'zh-CN') ||
           voices[0]; // å®åœ¨æ²¡æœ‰å°±ç”¨ç¬¬ä¸€ä¸ª
}

function bindVoiceEvents() {
    document.querySelectorAll('.action-button-voice').forEach(button => {
        // å…ˆç§»é™¤æ—§äº‹ä»¶ç›‘å¬å™¨ï¼Œé¿å…é‡å¤ç»‘å®š
        const newButton = button.cloneNode(true);
        button.parentNode.replaceChild(newButton, button);

        newButton.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const textToSpeak = this.getAttribute('data-text');
            
            // åœæ­¢å½“å‰æœ—è¯»
            if (synth.speaking) {
                synth.cancel();
            }

            // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ­£åœ¨æœ—è¯»çš„æŒ‰é’®ï¼Œåˆ™åªåœæ­¢ï¼Œä¸å¼€å§‹æ–°çš„æœ—è¯»
            if (speakingButton === this) {
                speakingButton.classList.remove('speaking');
                speakingButton = null;
                return;
            }
            
            // æ¸…é™¤æ‰€æœ‰æŒ‰é’®çš„ 'speaking' çŠ¶æ€
            document.querySelectorAll('.action-button-voice').forEach(btn => {
                btn.classList.remove('speaking');
            });
            
            // å¼€å§‹æ–°çš„æœ—è¯»
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            utterance.voice = getSelectedVoice();
            utterance.rate = 1.0; 
            utterance.pitch = 1.0; 
            utterance.lang = 'zh-CN'; 
            
            this.classList.add('speaking');
            speakingButton = this;

            utterance.onend = () => {
                this.classList.remove('speaking');
                speakingButton = null;
                umami.track('voice_read_complete', { id: this.getAttribute('data-id') });
            };
            utterance.onerror = (e) => {
                console.error("è¯­éŸ³æœ—è¯»å‡ºé”™:", e);
                this.classList.remove('speaking');
                speakingButton = null;
            };

            synth.speak(utterance);
            umami.track('voice_read_start', { id: this.getAttribute('data-id') });
        });
    });
}

// åˆ†äº«åŠŸèƒ½
function shareActivity(title, link) {
    const text = `ã€æ…§ä¼´ç®¡å®¶çœé’±ç§˜ç±ã€‘æˆ‘å‘ç°äº†ä¸€ä¸ªè¶…æ£’çš„è´­ç‰©ä¼˜æƒ ï¼š${title}ï¼å¿«å»çœ‹çœ‹å§ï¼é“¾æ¥ï¼š${link}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'æ…§ä¼´ç®¡å®¶çœé’±ç§˜ç±',
            text: text,
            url: link || window.location.href,
        }).then(() => {
            umami.track('share_success', { type: 'shopping' });
        }).catch((error) => {
            console.log('åˆ†äº«å¤±è´¥', error);
        });
    } else {
        // å¤åˆ¶åˆ°å‰ªè´´æ¿ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
        navigator.clipboard.writeText(text).then(() => {
            alert("æ´»åŠ¨è¯¦æƒ…å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼è¯·ç²˜è´´åˆ†äº«ç»™æœ‹å‹ã€‚\n" + text);
            umami.track('share_copy', { type: 'shopping' });
        }).catch(err => {
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ã€‚');
        });
    }
}
    </script>
</body>
</html>
