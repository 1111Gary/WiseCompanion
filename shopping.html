<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>NEX AI - 省钱秘籍</title>
    <script async defer src="https://umami.example.com/script.js" data-website-id="7b5c80e8-218d-4850-a9f3-d3764a059fed" data-do-not-track="true" data-domains="1111gary.github.io"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./assets/icon_apple.svg">
    <style>
        :root {
            --bg-dark: #0B1120; --card-bg: #1E293B; --text-main: #FFFFFF;
            --text-sub: #94A3B8; --primary: #8B5CF6; --accent: #FACC15; /* Purple Theme */
        }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; padding-top: 110px; padding-bottom: 90px; }

        /* Toast 强制样式 */
        #toast-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999 !important; pointer-events: none; display: flex; align-items: center; justify-content: center; }
        #toast-box { background: rgba(0, 0, 0, 0.9) !important; color: #fff !important; padding: 20px 30px !important; border-radius: 12px !important; text-align: center !important; max-width: 80%; border: 1px solid rgba(255,255,255,0.2) !important; box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important; opacity: 0; transform: scale(0.9); transition: all 0.2s ease-out; pointer-events: auto; display: none; }
        #toast-box.active { opacity: 1; transform: scale(1); display: block; }
        .toast-icon { font-size: 36px !important; margin-bottom: 10px !important; display: block; }
        .toast-text { font-size: 16px !important; line-height: 1.5 !important; font-weight: bold !important; }

        /* Header */
        @keyframes borderFlow { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        #smart-header { position: fixed; top: 0; left: 0; right: 0; z-index: 50; background: rgba(11, 17, 32, 0.98); backdrop-filter: blur(20px); transition: transform 0.3s ease; padding-top: env(safe-area-inset-top); }
        .nav-hidden { transform: translateY(-100%); }
        .header-top { display: flex; align-items: center; justify-content: space-between; height: 50px; padding: 0 16px; position: relative; }
        .header-top::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--primary), var(--accent), var(--primary), transparent); background-size: 200% 100%; animation: borderFlow 3s linear infinite; z-index: 20; box-shadow: 0 1px 8px rgba(139, 92, 246, 0.5); }
        .app-logo { width: 32px; height: 32px; border-radius: 8px; margin-right: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .page-title { font-size: 1.2rem; font-weight: 800; color: #fff; text-shadow: 0 0 10px rgba(139, 92, 246, 0.4); }

        /* Chips & Sidebar */
        .filter-bar { display: flex; gap: 10px; overflow-x: auto; padding: 12px 16px; scrollbar-width: none; align-items: center; }
        .chip { display: inline-flex; align-items: center; justify-content: center; height: 34px; padding: 0 16px; border-radius: 999px; font-size: 0.85rem; font-weight: 600; background: rgba(255,255,255,0.05); color: var(--text-sub); flex-shrink: 0; white-space: nowrap; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s; }
        .chip.active { background: var(--primary); color: #fff; border-color: transparent; box-shadow: 0 0 10px rgba(139, 92, 246, 0.3); }
        .chip i { font-size: 1.1rem; }
        .sidebar-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 90; display: none; }
        .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: #0f172a; z-index: 100; transform: translateX(-100%); transition: 0.3s; padding-top: env(safe-area-inset-top); border-right: 1px solid rgba(255,255,255,0.05); }
        .sidebar-open .sidebar-mask { display: block; } .sidebar-open .sidebar { transform: translateX(0); }
        .sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 12px; font-size: 1.2rem; font-weight: 700; color: #fff; background: linear-gradient(to right, rgba(139, 92, 246, 0.1), transparent); }
        .sidebar-item { padding: 16px 20px; display: flex; align-items: center; gap: 16px; color: #ffffff; font-weight: 500; transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.03); cursor: pointer; text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .sidebar-item:active { background: rgba(255,255,255,0.05); }
        .sidebar-icon-box { width: 36px; height: 36px; border-radius: 8px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--primary); }

        /* Content */
        .section-container { display: block; }
        .section-title-card { margin: 1.5rem 1rem 1rem; padding: 12px 16px; border-radius: 12px; background: linear-gradient(135deg, rgba(30,41,59,0.8), rgba(15,23,42,0.8)); border: 1px solid rgba(255,255,255,0.08); display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .section-title-h2 { font-size: 1.1rem; font-weight: 800; color: #fff; text-shadow: 0 0 5px rgba(255,255,255,0.3); }
        .task-card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin: 0 1rem 1rem; border: 1px solid rgba(255,255,255,0.05); position: relative; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .task-card::before { content: ''; position: absolute; top: 0; bottom: 0; left: 0; width: 4px; background: currentColor; border-radius: 16px 0 0 16px; }
        .badges { position: absolute; top: 12px; right: 12px; display: flex; gap: 6px; }
        .badge-timer { background: #EC4899; color: #fff; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .badge-note { background: linear-gradient(90deg, #F59E0B, #FBBF24); color: #000; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 700; }
        .card-main { display: flex; align-items: center; margin-top: 12px; }
        .card-icon { width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #1e293b, #0f172a); border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; font-size: 1.4rem; color: #fff; margin-right: 14px; flex-shrink: 0; }
        .card-text { flex: 1; min-width: 0; }
        .card-title { font-size: 1.05rem; font-weight: 700; color: #fff; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-desc { font-size: 0.85rem; color: #94A3B8; display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        .card-actions { display: flex; justify-content: space-between; align-items: center; margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.05); }
        
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 6px 16px; border-radius: 999px; font-size: 0.8rem; font-weight: 700; transition: 0.2s; border: 1px solid transparent; cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #7C3AED); color: #fff; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4); }
        .btn-share { background: rgba(139, 92, 246, 0.15); color: #A78BFA; border: 1px solid rgba(139, 92, 246, 0.3); }
        .btn-voice { background: #10B981; color: #fff; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4); }
        .btn-voice.speaking { background: #EF4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }

        /* Nav Bar */
        .nav-bar { position: fixed; bottom: 0; width: 100%; height: 65px; background: rgba(11,17,32,0.95); backdrop-filter: blur(12px); border-top: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-around; align-items: center; z-index: 50; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 3px; color: #64748B; font-size: 0.7rem; font-weight: 500; }
        .nav-item.active { color: var(--primary); } .nav-item i { font-size: 1.3rem; }
    </style>
</head>
<body>
    <div class="sidebar-mask" onclick="toggleSidebar()"></div>
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="./assets/icon_apple.svg" onerror="this.src='https://placehold.co/32x32/8B5CF6/ffffff?text=W'" class="w-8 h-8 rounded-lg border border-white/10">
            <span class="text-lg font-bold text-white">NEX AI 助手</span>
        </div>
        <div id="sidebar-content" class="flex-1 overflow-y-auto py-2"></div>
    </div>

    <header id="smart-header">
        <div class="header-top">
            <div class="flex items-center">
                <img src="./assets/icon_apple.svg" onerror="this.src='https://placehold.co/32x32/8B5CF6/ffffff?text=S'" class="app-logo">
                <span class="page-title">省钱秘籍</span>
            </div>
            <a href="./index.html" class="text-gray-300 text-xl px-2"><i class="fas fa-arrow-left"></i></a>
        </div>
        <div class="filter-bar" id="filter-bar"></div>
    </header>

    <main>
        <div id="sec-PaymentDiscount" class="section-container">
            <div class="section-title-card"><h2 class="section-title-h2"><i class="fas fa-shopping-bag text-purple-400 mr-2"></i> 购物优惠</h2></div>
            <div id="paymentdiscount-list"></div>
        </div>
        <div id="sec-PaymentBill" class="section-container">
            <div class="section-title-card"><h2 class="section-title-h2"><i class="fas fa-bolt text-yellow-400 mr-2"></i> 缴费优惠</h2></div>
            <div id="paymentbill-list"></div>
        </div>
        <div id="sec-TravelDiscount" class="section-container">
            <div class="section-title-card"><h2 class="section-title-h2"><i class="fas fa-plane text-blue-400 mr-2"></i> 出行优惠</h2></div>
            <div id="traveldiscount-list"></div>
        </div>

        <a href="./premium.html" class="premium-card" onclick="umami.track('click_premium_card', { from: 'shopping' })" style="display:block;margin:2rem 1rem;padding:24px;border-radius:20px;background:linear-gradient(135deg,#1e293b,#0f172a);border:1px solid rgba(255,255,255,0.05);text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.3);">
            <div class="premium-title" style="font-size:1.2rem;font-weight:800;background:linear-gradient(to right, #FACC15, #8B5CF6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:inline-flex;align-items:center;gap:8px;"><i class="fas fa-crown" style="color:#FACC15"></i> 高级会员专区</div>
            <div class="premium-desc" style="color:#94A3B8;font-size:0.85rem;margin-top:8px">AI 自动提醒 • 收益最大化助手</div>
        </a>
    </main>
    
    <nav class="nav-bar">
        <a href="./index.html" class="nav-item"><i class="fas fa-home"></i>首页</a>
        <a href="./checkin.html" class="nav-item"><i class="fas fa-gifts"></i>天天有奖</a>
        <a href="./video.html" class="nav-item"><i class="fas fa-play-circle"></i>看视频赚</a>
        <!-- 指向 rewards.html -->
        <a href="./rewards.html" class="nav-item"><i class="fas fa-hand-holding-usd"></i>捡钱任务</a>
        <span class="nav-item active"><i class="fas fa-tags"></i>省钱秘籍</span>
    </nav>
    
    <div id="toast-overlay">
        <div id="toast-box">
            <i class="fas fa-check-circle text-green-400 toast-icon"></i>
            <div id="toast-text" class="toast-text">操作成功</div>
        </div>
    </div>

    <script>
        let ALL=[], selPlat='All', selCategory='All';
        const CAT_MAP={'PaymentDiscount':{icon:'fa-shopping-bag',color:'#8B5CF6'},'PaymentBill':{icon:'fa-bolt',color:'#FBBF24'},'TravelDiscount':{icon:'fa-plane',color:'#3B82F6'}};
        const CAT_FILTERS = [
            {v:'All', t:'全部'},
            {v:'PaymentDiscount', t:'购物优惠'},
            {v:'PaymentBill', t:'缴费优惠'},
            {v:'TravelDiscount', t:'出行优惠'}
        ];
        let toastTimer = null;
        const synth=window.speechSynthesis; 

        let lastY=0; const h=document.getElementById('smart-header');
        window.addEventListener('scroll', ()=>{const y=window.scrollY; if(Math.abs(y-lastY)<10)return; if(h.style.transition!=='none')h.classList.toggle('nav-hidden', y>lastY&&y>60); lastY=y; sessionStorage.setItem('pos_shopping', y); sessionStorage.setItem('nav_shopping', h.classList.contains('nav-hidden'));}, {passive: true});
        if('scrollRestoration' in history) history.scrollRestoration='manual';

        document.addEventListener('DOMContentLoaded', () => {
            fetch('./activities.json').then(r=>r.json()).then(d => {
                const now = Date.now();
                ALL = d.filter(a => {
                    const isCat = a.category && (a.category.includes('PaymentDiscount')||a.category.includes('PaymentBill')||a.category.includes('TravelDiscount'));
                    const e = a.endDate ? new Date(a.endDate).getTime() : null;
                    return isCat && (!e || e >= now);
                });

                // [排序] 按开始时间倒序
                ALL.sort((a, b) => {
                    const dateA = a.startDate ? new Date(a.startDate).getTime() : 0;
                    const dateB = b.startDate ? new Date(b.startDate).getTime() : 0;
                    return dateB - dateA; 
                });

                initUI(); render(); setInterval(updTm, 1000);
                const y=sessionStorage.getItem('pos_shopping'); if(y) setTimeout(()=>window.scrollTo(0,parseInt(y)),50);
            });
        });

        function handleBtnClick(el) {
            const link = el.getAttribute('data-link');
            const name = el.getAttribute('data-name');
            if (!link || link === '#') return;
            const lower = link.toLowerCase().trim();
            const blockList = ['#', '小程序', 'miniprogram', 'micromessenger', 'weixin://', 'wx.abchina', 'wbs.icbc'];
            const isBlocked = blockList.some(k => lower.includes(k));
            if (isBlocked) doCopy(link, lower); else window.open(link, '_blank');
            if (window.umami) umami.track('click_action', { name: name || 'unknown', type: isBlocked ? 'copy' : 'jump' });
        }

        function doCopy(text, lowerLink) {
            let appName = '微信';
            if (lowerLink && lowerLink.includes('icbc')) appName = '工行App';
            else if (lowerLink && lowerLink.includes('abchina')) appName = '农行App';
            if (navigator.clipboard && window.isSecureContext) navigator.clipboard.writeText(text).then(() => showMyToast(`链接已复制！\n请打开【${appName}】粘贴访问`)).catch(() => fallbackCopy(text, appName));
            else fallbackCopy(text, appName);
        }

        function fallbackCopy(text, appName) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.readOnly = true; 
            textArea.style.cssText = "position:fixed;top:0;left:0;opacity:0;pointer-events:none;";
            document.body.appendChild(textArea);
            textArea.focus({preventScroll:true}); textArea.select();
            try { document.execCommand('copy'); showMyToast(`链接已复制！\n请打开【${appName}】粘贴访问`); } catch (err) { prompt("请全选复制：", text); }
            document.body.removeChild(textArea);
        }

        function handleShareBtn(el) {
            const id = el.getAttribute('data-id');
            const act = ALL.find(a => a.id === id);
            if (!act) return;
            let shareText = `【NEX AI | ${act.sourceApp||'福利'}】${act.name}\n${act.description||'点击查看'}`;
            if (act.link && act.link !== '#') shareText += `\n传送门：${act.link}`;
            doCopy(shareText, '');
            if (navigator.share) navigator.share({ title: 'NEX AI', text: shareText, url: (act.link && act.link!=='#') ? act.link : window.location.href }).catch(e=>console.log(e));
            showMyToast('文案已复制\n请去微信粘贴');
        }

        function showMyToast(msg) {
            const box = document.getElementById('toast-box');
            const txt = document.getElementById('toast-text');
            if(!box || !txt) return;
            txt.innerText = msg; txt.style.whiteSpace = 'pre-line';
            box.classList.add('active');
            if(toastTimer) clearTimeout(toastTimer);
            toastTimer = setTimeout(() => box.classList.remove('active'), 2500);
        }

        function initUI() {
            const bar=document.getElementById('filter-bar');
            let html = `<button class="chip chip-trigger ${selPlat==='All'?'active':''}" onclick="toggleSidebar()"><i class="fas fa-compass text-lg"></i></button>`;
            CAT_FILTERS.forEach(f => { html += `<button class="chip ${selCategory===f.v?'active':''}" onclick="setCat('${f.v}')">${f.t}</button>`; });
            bar.innerHTML = html;
            const sb=document.getElementById('sidebar-content'); const ps=new Set(); ALL.forEach(a=>ps.add(a.sourceApp));
            let sideHtml = `<div class="sidebar-item" onclick="setPl('All')"><div class="sidebar-icon-box"><i class="fas fa-border-all"></i></div> 全部平台</div>`;
            ps.forEach(p=>{if(p)sideHtml+=`<div class="sidebar-item" onclick="setPl('${p}')"><div class="sidebar-icon-box"><i class="fas fa-mobile-alt"></i></div> ${p}</div>`});
            sb.innerHTML = sideHtml;
        }

        function toggleSidebar(){document.body.classList.toggle('sidebar-open');}
        function setCat(c){ selCategory=c; initUI(); render(); }
        function setPl(p){ selPlat=p; toggleSidebar(); initUI(); render(); }

        function render() {
            const containers = {'PaymentDiscount': document.getElementById('paymentdiscount-list'), 'PaymentBill': document.getElementById('paymentbill-list'), 'TravelDiscount': document.getElementById('traveldiscount-list')};
            const sections = {'PaymentDiscount': document.getElementById('sec-PaymentDiscount'), 'PaymentBill': document.getElementById('sec-PaymentBill'), 'TravelDiscount': document.getElementById('sec-TravelDiscount')};
            Object.values(containers).forEach(e => e.innerHTML='');
            ALL.filter(a => selPlat==='All' || a.sourceApp===selPlat).forEach(a => {
                const cat = a.category.find(c => CAT_MAP[c]); 
                if (cat && containers[cat] && (selCategory === 'All' || selCategory === cat)) { containers[cat].innerHTML += card(a, CAT_MAP[cat]); }
            });
            Object.keys(sections).forEach(key => {
                const hasContent = containers[key].children.length > 0;
                if (hasContent && (selCategory === 'All' || selCategory === key)) sections[key].style.display = 'block'; else sections[key].style.display = 'none';
            });
            updTm();
        }

        function card(a, s) {
            let btnHtml = '';
            if (a.link && a.link !== '#') {
                btnHtml = `<button class="btn btn-primary" data-link="${a.link.replace(/"/g, '&quot;')}" data-name="${a.name.replace(/"/g, '&quot;')}" onclick="handleBtnClick(this)">去领取 <i class="fas fa-chevron-right ml-1"></i></button>`;
            } else if (a.StepsText) {
                btnHtml = `<button class="btn btn-voice" onclick="spk('${a.StepsText.replace(/"/g,'&quot;').replace(/'/g, "\\'")}', this)"><i class="fas fa-volume-up mr-1"></i> 播放</button>`;
            } else {
                btnHtml = `<button class="btn" style="background:#333;color:#666;cursor:not-allowed">暂无</button>`;
            }

            // [新增] NEW 标记
            const now = Date.now();
            const start = a.startDate ? new Date(a.startDate).getTime() : 0;
            const isNew = (now - start) < (3 * 24 * 60 * 60 * 1000);
            const newBadge = isNew ? '<span class="ml-2 text-xs bg-red-500 text-white px-1.5 py-0.5 rounded animate-pulse shadow-red-500/50 shadow-sm">NEW</span>' : '';
            
            return `<div class="task-card" style="color:${s.color}; border-left-color:${s.color}">
                <div class="badges">${a.specialNote?`<span class="badge badge-note">${a.specialNote}</span>`:''}<span class="badge badge-timer" data-e="${a.endDate}" data-s="${a.startDate}">...</span></div>
                <div class="card-main"><div class="card-icon" style="color:${s.color}"><i class="fas ${s.icon}"></i></div><div class="card-text"><div class="card-title" style="color:#fff">${a.name}${newBadge}</div><div class="card-desc">${a.description||'暂无描述'}</div></div></div>
                <div class="card-actions"><button class="btn btn-share" data-id="${a.id}" onclick="handleShareBtn(this)"><i class="fas fa-share-alt mr-1"></i> 分享</button>${btnHtml}</div>
            </div>`;
        }

        function spk(t, b){if(!synth)return; if(b.classList.contains('speaking')){synth.cancel();b.classList.remove('speaking');b.innerHTML=`<i class="fas fa-volume-up mr-1"></i> 播放`;return;}synth.cancel();const u=new SpeechSynthesisUtterance(t);u.lang='zh-CN';u.rate=0.75;u.onstart=()=>{b.classList.add('speaking');b.innerHTML=`<i class="fas fa-stop mr-1"></i> 停止`;};u.onend=()=>{b.classList.remove('speaking');b.innerHTML=`<i class="fas fa-volume-up mr-1"></i> 播放`;};synth.speak(u);}
        function updTm(){const n=Date.now();document.querySelectorAll('.badge-timer').forEach(e=>{const s=e.dataset.s?new Date(e.dataset.s).getTime():0, end=e.dataset.e?new Date(e.dataset.e).getTime():0;if(s>n){e.innerText=`即将开始 ${fmt(s-n)}`;e.classList.remove('expired');}else if(end&&end<n){e.innerText='已结束';e.classList.add('expired');}else if(end){e.innerText=`剩余 ${fmt(end-n)}`;e.classList.remove('expired');}else{e.innerText='长期';e.classList.remove('expired');}});}
        function fmt(ms){const d=Math.floor(ms/86400000),h=Math.floor((ms%86400000)/3600000),m=Math.floor((ms%3600000)/60000);return d>0?`${d}天${h}时`:`${h}时${m}分`;}
    </script>
</body>
</html>