<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>慧伴管家 - 省钱秘籍</title>
    
    <!-- Umami 统计 -->
    <script async defer 
        data-website-id="7b5c80e8-218d-4850-a9f3-d3764a059fed" 
        src="https://umami.example.com/script.js" 
        data-do-not-track="true" 
        data-domains="1111gary.github.io"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="慧伴管家">
    <link rel="apple-touch-icon" href="./assets/icon_apple.png">
    
    <style>
        /* ---------------------------------------------------- */
        /* 【 核心 】 顶级设计师配色系统：Neon Consumer */
        /* ---------------------------------------------------- */
        :root {
            --color-bg-dark: #0B1120; /* 更深邃的蓝黑底色 */
            --color-card-bg: #1E293B; /* 稍微提亮的卡片背景 */
            --color-text-light: #F1F5F9;
            --color-text-muted: #94A3B8;
            
            /* 品牌色 */
            --color-primary: #38BDF8; /* 天空蓝 */
            --color-highlight: #FACC15; /* 亮金色 */
            
            /* 辅助色 */
            --color-bank-bg: #1E293B; 
            --color-success: #10B981; 
            --color-special-note: #F59E0B; 
            --color-premium-border: linear-gradient(135deg, #FACC15, #F472B6);

            /* [设计升级] 业务渐变色系统 */
            /* 1. 购物 (PaymentDiscount) - 幻影紫渐变 */
            --grad-shopping-1: linear-gradient(135deg, #8B5CF6, #C084FC); 
            --color-shopping-1: #8B5CF6; 

            /* 2. 缴费 (PaymentBill) - 活力橙渐变 */
            --grad-shopping-2: linear-gradient(135deg, #F59E0B, #FBBF24); 
            --color-shopping-2: #F59E0B; 

            /* 3. 出行 (TravelDiscount) - 极光青渐变 */
            --grad-shopping-3: linear-gradient(135deg, #06B6D4, #2DD4BF); 
            --color-shopping-3: #06B6D4; 

            /* 状态栏激活背景 (使用全局渐变) */
            --grad-status-active: linear-gradient(to right, #3B82F6, #06B6D4); 
        }

        body { 
            background-color: var(--color-bg-dark); 
            color: var(--color-text-light); 
            padding-bottom: calc(85px + env(safe-area-inset-bottom)); 
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }
        
        /* 顶部导航栏 */
        .header-bar-fixed { 
            padding-top: calc(15px + env(safe-area-inset-top)); 
            padding-bottom: 5px; 
            background-color: rgba(11, 17, 32, 0.95); /* 增加透明度 */
            backdrop-filter: blur(10px); /* 毛玻璃效果 */
            position: sticky;
            top: 0;
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .header-logo-group { display: flex; align-items: center; }
        .header-logo { width: 32px; height: 32px; margin-right: 10px; }
        .header-title { font-size: 1.2rem; font-weight: 700; color: var(--color-text-light); }
        .back-arrow-link {
            color: var(--color-text-light);
            font-size: 1.2rem;
            padding: 8px 12px;
            border-radius: 12px;
            background-color: rgba(255,255,255,0.1);
            transition: all 0.2s;
        }
        
        /* 主横幅 */
        .main-banner-card {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border-radius: 24px;
            padding: 30px 20px;
            text-align: center;
            border: 2px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            /* 使用极光青作为边框主色调 */
            border-image: linear-gradient(to right, var(--color-shopping-3), var(--color-shopping-1));
            border-image-slice: 1;
            box-shadow: 0 10px 30px -10px rgba(6, 182, 212, 0.3);
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        /* 增加横幅的光泽感 */
        .main-banner-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 60%);
            pointer-events: none;
        }

        .main-banner-card h1 {
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(to right, #fff, #cbd5e1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
        }
        .main-banner-card p { color: var(--color-text-muted); font-size: 0.95rem; margin-top: 8px;}
        
        /* ---------------------------------------------------- */
        /* 筛选器样式 (吸顶 + 玻璃质感) */
        /* ---------------------------------------------------- */
        .filter-container {
            padding: 12px 0;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .filter-container::-webkit-scrollbar { display: none; }
        
        .filter-container.sticky-top-16 {
            position: sticky;
            top: 60px;
            z-index: 15;
            background-color: rgba(11, 17, 32, 0.9); /* 半透明背景 */
            backdrop-filter: blur(12px); /* 强力毛玻璃 */
            border-bottom: 1px solid rgba(255,255,255,0.05);
            margin-left: -1rem; 
            margin-right: -1rem;
            padding-left: 1rem;
            padding-right: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .filter-button {
            display: inline-flex;
            align-items: center;
            padding: 8px 16px;
            border-radius: 100px;
            font-size: 0.85rem;
            font-weight: 600;
            background-color: rgba(30, 41, 59, 0.8);
            color: var(--color-text-muted);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .filter-button.active {
            background: var(--color-primary);
            color: #000;
            border-color: transparent;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.4); /* 蓝色微光 */
            font-weight: 700;
        }
        .filter-button i { margin-right: 6px; }

        /* 状态筛选器 (Status Filter) */
        .status-filter-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px; 
            margin-top: 1rem; 
            margin-bottom: 2rem; 
            background-color: #1E293B; 
            border-radius: 100px;
            box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3); /* 内阴影，增加凹陷感 */
            border: 1px solid rgba(255,255,255,0.05);
        }

        .status-button {
            flex: 1; 
            text-align: center;
            padding: 10px 0;
            border-radius: 100px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--color-text-muted); 
            background-color: transparent; 
            border: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative;
            overflow: hidden;
        }

        .status-button.active {
            color: white; 
            background: var(--color-shopping-2); /* 默认使用活力橙 */
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        /* 为不同状态定制颜色 */
        .status-button[data-status="Active"].active { background: var(--color-success); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4); }
        .status-button[data-status="Upcoming"].active { background: var(--color-shopping-1); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); }
        .status-button[data-status="Expired"].active { background: #64748B; box-shadow: none; }
        
        /* 分区标题 */
        .section-title-card {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 16px;
            padding: 12px 0;
            margin-top: 2.5rem;
            margin-bottom: 1rem;
            position: relative;
            display: flex;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .section-title-card h2 {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--color-text-light);
            padding-left: 15px;
            display: flex;
            align-items: center;
        }
        .section-description { color: var(--color-text-muted); font-size: 0.9rem; margin-bottom: 1rem; padding-left: 5px; line-height: 1.5; }

        /* 任务列表卡片 */
        .task-list-card {
            background-color: #1E293B;
            border-radius: 16px;
            padding: 18px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-left: 4px solid; 
            position: relative;
            border-top: 1px solid rgba(255,255,255,0.05);
            border-right: 1px solid rgba(255,255,255,0.05);
            border-bottom: 1px solid rgba(0,0,0,0.2);
        }
        .task-list-card:hover {
            background-color: #27354F;
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* [配色应用] 卡片边框与图标 */
        .task-shopping-1 { border-left-color: var(--color-shopping-1); } 
        .task-shopping-2 { border-left-color: var(--color-shopping-2); } 
        .task-shopping-3 { border-left-color: var(--color-shopping-3); } 
        
        .task-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            color: #fff; 
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            flex-shrink: 0;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        /* 使用渐变背景的图标 */
        .icon-shopping-1 { background: var(--grad-shopping-1); }
        .icon-shopping-2 { background: var(--grad-shopping-2); }
        .icon-shopping-3 { background: var(--grad-shopping-3); }
        
        .task-main-content { display: flex; align-items: center; width: 100%; }
        .task-content { flex-grow: 1; min-width: 0; }
        
        .task-title {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--color-text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 90px; 
            margin-bottom: 4px;
        }
        .has-special-note .task-title { padding-right: 120px; }
        .task-subtitle {
            font-size: 0.85rem;
            color: var(--color-text-muted);
            white-space: normal; 
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* 限制两行 */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* 徽章样式优化 */
        .special-note-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: var(--grad-shopping-2); /* 统一用橙色渐变做Note */
            color: #000;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 800;
            z-index: 5;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }
        .countdown-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #334155; /* 默认灰色底 */
            color: #94A3B8;
            padding: 4px 12px;
            border-top-right-radius: 15px;
            border-bottom-left-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            z-index: 4;
            letter-spacing: 0.5px;
        }
        .special-note-badge + .countdown-badge { top: 42px; right: 15px; border-radius: 6px; }
        
        /* 按钮组优化 */
        .task-action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }
        .share-button {
            background-color: transparent;
            color: var(--color-text-muted);
            border: 1px solid rgba(255,255,255,0.1);
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 9999px;
            font-size: 0.8rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .share-button:hover { background-color: rgba(255,255,255,0.1); color: #fff; }

        .action-button {
            background: var(--color-primary);
            color: #000;
            font-weight: 700;
            padding: 8px 20px;
            border-radius: 9999px;
            font-size: 0.85rem;
            transition: all 0.2s;
            text-align: center;
            min-width: 100px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            box-shadow: 0 0 12px rgba(56, 189, 248, 0.4); /* 蓝色光晕 */
        }
        .action-button:hover { transform: scale(1.05); filter: brightness(1.1); }
        
        .action-button-voice { background: var(--color-success); box-shadow: 0 0 12px rgba(16, 185, 129, 0.4); color: #000; }
        .action-button-voice.speaking { 
            background: #EF4444; 
            color: #fff;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
            animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        /* 底部导航栏 (保持一致) */
        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            display: flex; justify-content: space-around; align-items: center;
            height: 65px;
            background-color: rgba(11, 17, 32, 0.95);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-bottom: env(safe-area-inset-bottom);
            z-index: 20;
        }
        .tab-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-decoration: none; color: var(--color-text-muted);
            font-size: 0.7rem; font-weight: 500; transition: color 0.2s ease;
            padding: 5px; flex-grow: 1;
        }
        .tab-item.active { color: var(--color-primary); }
        .tab-icon { font-size: 1.3rem; margin-bottom: 4px; }
        
        /* Premium Card */
        .premium-card {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 20px;
            padding: 25px 20px;
            text-align: center;
            border: 2px solid transparent; 
            background-clip: padding-box, border-box;
            background-origin: padding-box, border-box;
            border-image: var(--color-premium-border);
            border-image-slice: 1;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            margin-top: 3rem;
            margin-bottom: 1rem;
            position: relative;
            text-decoration: none;
            display: block;
            transition: all 0.3s ease;
        }
        .premium-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); }
        .premium-card h2 {
            font-size: 1.3rem; font-weight: 800;
            background: var(--color-premium-border);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin: 0;
        }
        .premium-card p { color: var(--color-text-muted); font-size: 0.9rem; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header-bar-fixed px-4">
        <div class="header-logo-group">
            <img src="./assets/icon_apple.png" onerror="this.onerror=null;this.src='https://placehold.co/32x32/00BFFF/ffffff?text=L'" alt="Logo" class="header-logo rounded-md shadow-lg">
            <h1 class="header-title">慧伴管家</h1>
        </div>
        <a href="./index.html" class="back-arrow-link" title="返回首页">
            <i class="fas fa-arrow-left"></i>
        </a>
    </div>

    <main class="container mx-auto px-4 py-4">
        
        <div class="main-banner-card">
            <h1>省钱秘籍中心</h1>
            <p class="text-sm text-gray-400 mt-2">点击下方按钮，仅显示您关注的平台活动</p>
        </div>
        
        <!-- 平台筛选 (Sticky) -->
        <div class="filter-container sticky-top-16" id="platform-filter-container">
            <button class="filter-button active" data-platform="All">
                <i class="fas fa-layer-group"></i>
                全部平台
            </button>
        </div>

        <!-- 状态筛选 -->
        <div class="status-filter-container" id="status-filter-container">
            <button class="status-button active" data-status="Active">
                <i class="fas fa-fire-alt"></i> 正在进行
            </button>
            <button class="status-button" data-status="Upcoming">
                <i class="fas fa-hourglass-start"></i> 即将开始
            </button>
            <button class="status-button" data-status="Expired">
                <i class="fas fa-history"></i> 已结束
            </button>
        </div>


        <!-- 1. 购物有优惠 -->
        <div class="section-title-card">
            <h2 class="flex items-center">
                <i class="fas fa-shopping-bag mr-3 text-xl" style="color: var(--color-shopping-1);"></i>
                购物有优惠 (PaymentDiscount)
            </h2>
        </div>
        <p class="section-description">
            使用特定支付方式（如XX卡、XXPay）在商店购物时可享受的折扣或优惠。
        </p>
        <div id="paymentdiscount-list" class="mt-4">
            <!-- JS 加载内容 -->
        </div>
        
        <!-- 2. 缴费有优惠 -->
        <div class="section-title-card">
            <h2 class="flex items-center">
                <i class="fas fa-bolt mr-3 text-xl" style="color: var(--color-shopping-2);"></i>
                缴费有优惠 (PaymentBill)
            </h2>
        </div>
        <p class="section-description">
            缴纳生活费用（如水电煤、电话费）时可享受的折扣或立减优惠。
        </p>
        <div id="paymentbill-list" class="mt-4">
             <!-- JS 加载内容 -->
        </div>
        
        <!-- 3. 出行有优惠 -->
        <div class="section-title-card">
            <h2 class="flex items-center">
                <i class="fas fa-plane-departure mr-3 text-xl" style="color: var(--color-shopping-3);"></i>
                出行有优惠 (TravelDiscount)
            </h2>
        </div>
        <p class="section-description">
            乘坐交通工具（如打车、公交、火车、飞机）或预订酒店时的优惠。
        </p>
        <div id="traveldiscount-list" class="mt-4">
             <!-- JS 加载内容 -->
        </div>

        <!-- 付费诱饵 -->
        <a href="./premium.html" class="premium-card" 
            onclick="umami.track('click_premium_card', { from: 'shopping' })">
            <h2 class="flex items-center justify-center">
                <i class="fas fa-crown mr-2" style="color: var(--color-highlight);"></i>
                高级会员专区 (敬请期待)
            </h2>
            <p>【独家】AI自动生成省钱秘籍演示视频，长辈也能轻松学会！</p>
        </a>
        
    </main>
    
    <nav class="tab-bar">
        <a href="./index.html" class="tab-item">
            <i class="fas fa-home tab-icon"></i>
            <span>首页</span>
        </a>
        <a href="./checkin.html" class="tab-item">
            <i class="fas fa-gifts tab-icon"></i>
            <span>天天有奖</span>
        </a>
        <a href="./video.html" class="tab-item">
            <i class="fas fa-play-circle tab-icon"></i>
            <span>看视频赚</span>
        </a>
        <a href="./bank.html" class="tab-item">
            <i class="fas fa-hand-holding-usd tab-icon"></i>
            <span>捡钱任务</span>
        </a>
        <span class="tab-item active">
            <i class="fas fa-tags tab-icon"></i>
            <span>省钱秘籍</span>
        </span>
    </nav>
    
    <script>
        // ----------------------------------------------------
        // 全局状态和数据
        // ----------------------------------------------------
        let ALL_ACTIVITIES = [];
        let selectedPlatform = 'All'; 
        let globalStatus = 'Active'; 

        // [【 核心 】] 分类与样式的映射 (配合新 CSS)
        const CATEGORY_MAP = {
            'PaymentDiscount': { borderClass: 'task-shopping-1', iconClass: 'icon-shopping-1', faIcon: 'fa-shopping-bag' },
            'PaymentBill': { borderClass: 'task-shopping-2', iconClass: 'icon-shopping-2', faIcon: 'fa-bolt' },
            'TravelDiscount': { borderClass: 'task-shopping-3', iconClass: 'icon-shopping-3', faIcon: 'fa-plane-departure' }
        };

        // 语音 API
        const synth = window.speechSynthesis;
        let currentUtterance = null; 
        let speakingButton = null; 
        if (!synth) {
            console.error("【慧伴管家】: 您的浏览器不支持 Web Speech API 语音播放。");
        }
        
        // ----------------------------------------------------
        // 步骤 1: 页面加载主入口
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            try {
                if(synth && synth.getVoices().length === 0) {
                    synth.onvoiceschanged = () => { console.log("【慧伴管家】: 语音包已加载。"); };
                    synth.getVoices(); 
                }
            } catch(e) { console.error("【慧伴管家】: 预热语音引擎失败:", e); }
            
            loadAndFetchActivities();
            startCountdownUpdater();
        });

        async function loadAndFetchActivities() {
            try {
                const response = await fetch('./activities.json');
                if (!response.ok) { throw new Error('网络响应错误，无法加载 activities.json'); }
                const data = await response.json();
                
                // 过滤出 Shopping 相关活动
                ALL_ACTIVITIES = data.filter(act => 
                    act.category && (
                        act.category.includes('PaymentDiscount') || 
                        act.category.includes('PaymentBill') || 
                        act.category.includes('TravelDiscount')
                    )
                );

                initPlatformFilters();
                bindStatusFilters();
                renderActivities();
                
            } catch (error) {
                console.error("加载活动数据失败:", error);
                const lists = ['paymentdiscount-list', 'paymentbill-list', 'traveldiscount-list'];
                lists.forEach(id => {
                    const el = document.getElementById(id);
                    if(el) el.innerHTML = `<p class="text-red-400 p-4 text-center">加载活动数据失败。请检查网络或 activities.json 文件。</p>`;
                });
            }
        }

        // ----------------------------------------------------
        // 步骤 2: 绑定筛选器
        // ----------------------------------------------------
        function getPlatformIcon(platformName) {
            if (platformName.includes('淘宝') || platformName.includes('天猫')) return 'fab fa-taobao';
            if (platformName.includes('京东')) return 'fa-shield-dog';
            if (platformName.includes('拼多多')) return 'fa-users';
            if (platformName.includes('美团')) return 'fa-hamburger';
            if (platformName.includes('饿了么')) return 'fa-bowl-food';
            if (platformName.includes('微信')) return 'fab fa-weixin';
            if (platformName.includes('支付宝')) return 'fab fa-alipay';
            return 'fa-store'; 
        }

        function initPlatformFilters() {
            const container = document.getElementById('platform-filter-container');
            const platforms = new Set();
            ALL_ACTIVITIES.forEach(activity => activity.sourceApp && platforms.add(activity.sourceApp));

            container.innerHTML = `
                <button class="filter-button active" data-platform="All">
                    <i class="fas fa-layer-group"></i>
                    全部平台
                </button>`;
            
            platforms.forEach(platform => {
                const icon = getPlatformIcon(platform); 
                const button = document.createElement('button');
                button.className = 'filter-button';
                button.setAttribute('data-platform', platform);
                button.innerHTML = `<i class="fa-solid ${icon}"></i> ${platform}`;
                
                button.addEventListener('click', (e) => { handleFilterClick(e.currentTarget, platform); });
                container.appendChild(button);
            });
            
            container.querySelector('[data-platform="All"]').addEventListener('click', (e) => {
                handleFilterClick(e.currentTarget, 'All');
            });
        }
        
        function handleFilterClick(clickedButton, platformName) {
            if (window.umami) { umami.track('filter_platform', { platform: platformName }); }
            
            selectedPlatform = platformName;
            document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
            clickedButton.classList.add('active');
            
            stopSpeech();
            renderActivities();
        }

        function bindStatusFilters() {
            const container = document.getElementById('status-filter-container');
            container.querySelectorAll('.status-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    const status = btn.getAttribute('data-status');
                    
                    globalStatus = status;
                    
                    container.querySelectorAll('.status-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    stopSpeech();
                    renderActivities();
                });
            });
        }
        
        // ----------------------------------------------------
        // 步骤 3: 核心逻辑
        // ----------------------------------------------------
        function getActivityStatus(activity) {
            if (!activity.endDate) return 'Active'; 
            
            const now = new Date().getTime();
            // 健壮性：如果没有startDate，假设已经开始
            const startDate = activity.startDate ? new Date(activity.startDate).getTime() : now - 1000; 
            const endDate = new Date(activity.endDate).getTime();

            if (now < startDate) return 'Upcoming'; 
            if (now > endDate) return 'Expired'; 
            return 'Active'; 
        }

        function renderActivities() {
            // 1. 平台过滤
            const filteredActivities = ALL_ACTIVITIES.filter(activity => 
                selectedPlatform === 'All' || activity.sourceApp === selectedPlatform
            );
            
            const lists = {
                'PaymentDiscount': document.getElementById('paymentdiscount-list'),
                'PaymentBill': document.getElementById('paymentbill-list'),      
                'TravelDiscount': document.getElementById('traveldiscount-list')    
            };

            Object.keys(lists).forEach(category => {
                const listElement = lists[category];
                if (!listElement) return;

                listElement.innerHTML = ''; 
                let hasActivities = false;

                // 2. 分类过滤
                const categoryActivities = filteredActivities.filter(activity => 
                    activity.category && activity.category.includes(category)
                );
                
                // 3. 状态过滤
                categoryActivities.forEach(activity => {
                    const status = getActivityStatus(activity);
                    if (globalStatus === status) {
                        hasActivities = true;
                        const cardHtml = renderActivityCard(activity, category, status);
                        listElement.innerHTML += cardHtml;
                    }
                });
                
                if (!hasActivities) {
                    let message = '';
                    if (selectedPlatform !== 'All') message += `平台 ${selectedPlatform} 下，`;
                    const statusText = globalStatus === 'Active' ? '正在进行' : globalStatus === 'Upcoming' ? '即将开始' : '已结束';
                    message += `没有处于 [${statusText}] 状态的活动。`;
                    listElement.innerHTML = `<p class="text-gray-400 text-center p-4 text-sm">${message}</p>`;
                }
            });
            
            bindActionButtons();
            updateCountdowns(); // 立即更新一次时间
        }

        // ====================================================
// 任务活动列表脚本 - 瘦身优化版
// ====================================================

// 全局变量声明（假设这些变量在其他地方已初始化，如：synth, speakingButton, currentUtterance, ALL_ACTIVITIES, CATEGORY_MAP）
// 例如：
// const synth = window.speechSynthesis;
// let speakingButton = null;
// let currentUtterance = null;
// const ALL_ACTIVITIES = []; // 假设活动数据
// const CATEGORY_MAP = { /* ... 样式映射 ... */ }; 
// function renderActivities() { /* ... 重绘逻辑 ... */ }

// ----------------------------------------------------
// 步骤 4: 卡片渲染 (包含状态样式) - 【核心精简】
// ----------------------------------------------------
function renderActivityCard(activity, subCategory, status) {
    // 1. 解构赋值简化变量引用
    const { link, StepsText, specialNote, id, name, description, startDate, endDate } = activity;
    const styles = CATEGORY_MAP[subCategory] || CATEGORY_MAP['PaymentDiscount'];
    
    // 2. 统一管理状态 CSS 和徽章样式
    let cardClassModifier = '';
    let countdownBadgeStyle = ''; // 用于内联样式（Upcoming/Expired）
    let badgeText;
    let badgeData = '';
    
    const isExpired = status === 'Expired';
    const isDisabled = isExpired;
    const disabledClass = isDisabled ? 'opacity-50 cursor-not-allowed' : '';
    const disabledAttr = isDisabled ? 'disabled' : '';

    if (status === 'Upcoming') {
        // Upcoming 状态：卡片半透明，徽章使用特殊的 Upcoming 颜色
        cardClassModifier = 'opacity-80 upcoming-card'; 
        countdownBadgeStyle = `style="background-color: var(--color-upcoming-bg, #38BDF8); color: var(--color-upcoming-text, white);"`;
        badgeText = startDate ? `<span id="timer-${id}">计算中...</span>` : '即将开始';
    } else if (isExpired) {
        // Expired 状态：卡片灰度+半透明，徽章使用暗色
        cardClassModifier = 'opacity-50 grayscale expired-card';
        countdownBadgeStyle = `style="background-color: var(--color-expired-bg, #334155); color: var(--color-expired-text, #94A3B8);"`;
        badgeText = '已结束';
    } else { // Active 状态
        // Active 状态：由 updateCountdowns 动态添加 active-badge/urgent-badge
        badgeText = endDate ? '计算中...' : '长期有效';
        badgeData = `data-endtime="${endDate}"`;
    }
    
    // 3. 构建特殊注意徽章 (specialNoteBadge)
    const specialNoteBadge = specialNote ? `
        <span class="special-note-badge" data-umami-event="view_special_note" data-umami-event-name="${name}">
            <i class="fas fa-star"></i> ${specialNote}
        </span>` : '';

    // 4. 构建动作按钮 (actionButtonHtml)
    let actionButtonHtml;
    
    if (link && link !== '#') {
        const onclickAttr = isDisabled ? 'onclick="event.preventDefault()"' : '';
        actionButtonHtml = `
            <a href="${link}" target="_blank"
               class="action-button action-button-link ${disabledClass}"
               data-umami-event="click_deep_link"
               data-umami-event-name="${name}"
               ${onclickAttr}>
                 <i class="fas fa-rocket"></i> 去领取
            </a>`;
    } else if (StepsText) {
        // 使用 encodeURIComponent 确保步骤文本在 HTML 属性中安全
        const encodedSteps = encodeURIComponent(StepsText); 
        actionButtonHtml = `
            <button class="action-button action-button-voice ${disabledClass}"
                    data-activity-id="${id}"
                    data-steps="${encodedSteps}"
                    data-activity-name="${name}"
                    ${disabledAttr}>
                <i class="fas fa-volume-high"></i> 播放语音
            </button>`;
    } else {
        actionButtonHtml = `
            <button class="action-button opacity-50 cursor-not-allowed" disabled>
                <i class="fas fa-info-circle"></i> 暂无指引
            </button>`;
    }
    
    // 5. 返回最终卡片 HTML
    return `
        <div class="task-list-card ${styles.borderClass} ${specialNote ? 'has-special-note' : ''} ${cardClassModifier}">
            ${specialNoteBadge}
            <span class="countdown-badge" ${countdownBadgeStyle} ${badgeData} id="badge-timer-${id}">
                ${badgeText}
            </span>
            
            <div class="task-main-content">
                <div class="task-icon ${styles.iconClass}">
                    <i class="fa-solid ${styles.faIcon}"></i>
                </div>
                <div class="task-content">
                    <div class="task-title">${name || '活动名称缺失'}</div>
                    <div class="task-subtitle">${description || '暂无详细描述。'}</div>
                </div>
            </div>
            
            <div class="task-action-bar">
                <button class="share-button" data-activity-id="${id}" data-activity-name="${name}">
                    <i class="fas fa-share-alt"></i> 分享
                </button>
                ${actionButtonHtml}
            </div>
        </div>
    `;
}

// ----------------------------------------------------
// 步骤 5: 事件绑定 - 【语音步骤解码优化】
// ----------------------------------------------------
function bindActionButtons() {
    document.querySelectorAll('.action-button-voice').forEach(button => {
        button.addEventListener('click', (e) => {
            const btn = e.currentTarget;
            if(btn.disabled) return;
            // 语音步骤解码：使用 decodeURIComponent 还原 StepsText
            const steps = decodeURIComponent(btn.getAttribute('data-steps')); 
            const name = btn.getAttribute('data-activity-name');
            if (window.umami) { umami.track('play_voice_guide', { name: name }); }
            toggleSpeech(btn, steps, name);
        });
    });

    document.querySelectorAll('.share-button').forEach(button => {
        button.addEventListener('click', (e) => {
            const btn = e.currentTarget;
            const id = btn.getAttribute('data-activity-id');
            const name = btn.getAttribute('data-activity-name');
            if (window.umami) { umami.track('click_share', { name: name }); }
            shareActivity(id, btn);
        });
    });
}
// ... (步骤 6: 语音播放逻辑 stopSpeech, toggleSpeech 保持不变)

// ----------------------------------------------------
// 步骤 7: 辅助功能 (分享) - 【现代 Web Share API 兼容】
// ----------------------------------------------------

// 辅助函数：使用旧版 execCommand 复制
function manualCopy(textToCopy, buttonElement, originalText) {
    try {
        const tempInput = document.createElement('textarea');
        tempInput.value = textToCopy;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand('copy');
        document.body.removeChild(tempInput);
        
        buttonElement.innerHTML = `<i class="fas fa-check"></i> 已复制!`;
        setTimeout(() => { buttonElement.innerHTML = originalText; }, 2000);
    } catch (err) {
        console.error('复制失败:', err);
        alert(`请手动复制链接：\n${textToCopy}`);
    }
}

// 辅助函数：负责现代/回退的复制逻辑
function fallbackCopy(textToCopy, buttonElement, originalText) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                buttonElement.innerHTML = `<i class="fas fa-check"></i> 已复制!`;
                setTimeout(() => { buttonElement.innerHTML = originalText; }, 2000);
            })
            .catch(() => manualCopy(textToCopy, buttonElement, originalText)); // 失败则降级
    } else {
        manualCopy(textToCopy, buttonElement, originalText);
    }
}

function shareActivity(activityId, buttonElement) {
    const shareUrl = `${window.location.origin}${window.location.pathname.replace('shopping.html', 'go.html')}?id=${activityId}`;
    const shareText = `快来看看这个活动！\n${shareUrl}`;
    const originalText = buttonElement.innerHTML;

    if (navigator.share) {
        navigator.share({
            title: '活动分享',
            text: shareText,
            url: shareUrl, 
        }).catch((error) => {
            if(error.name !== 'AbortError') { 
                 fallbackCopy(shareText, buttonElement, originalText); // 失败回退
            }
        });
    } else {
        fallbackCopy(shareText, buttonElement, originalText); // 不支持回退
    }
}

// ----------------------------------------------------
// 步骤 7: 辅助功能 (倒计时) - 【高亮逻辑整合】
// ----------------------------------------------------
function formatTime(ms) {
    if (ms <= 0) return '已结束';
    const seconds = Math.floor(ms / 1000);
    const days = Math.floor(seconds / (3600 * 24));
    const hours = Math.floor((seconds % (3600 * 24)) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    // 如果大于一天，显示天和小时
    if (days > 0) return `${days}天${hours}时`;
    // 否则显示小时和分钟
    return `${hours}时${minutes}分`;
}

function updateCountdowns() {
    const timers = document.querySelectorAll('.countdown-badge');
    const now = new Date().getTime();
    const ONE_DAY = 24 * 3600 * 1000;
    const THREE_DAYS = 3 * ONE_DAY; // 将高亮触发时间改为 3 天

    timers.forEach(timer => {
        const card = timer.closest('.task-list-card');
        
        // 1. 处理 Upcoming 倒计时
        if (card.classList.contains('upcoming-card')) {
             const idMatch = timer.id.match(/badge-timer-(\d+)/);
             if (idMatch) {
                 const actId = idMatch[1];
                 const activity = window.ALL_ACTIVITIES?.find(a => a.id == actId);
                 if (activity && activity.startDate) {
                     const diff = new Date(activity.startDate).getTime() - now;
                     timer.innerHTML = diff > 0 ? `<span id="timer-${actId}">${formatTime(diff)} 后开始</span>` : "进行中";
                     // 检查是否应该重绘（活动开始）
                     if(diff <= 0 && window.renderActivities) window.renderActivities(); 
                 }
             }
             return;
        }

        // 2. Expired 状态不需要处理（已在 renderActivityCard 中设置好样式）
        if (card.classList.contains('expired-card')) return;

        // 3. 处理 Active 倒计时 (高亮逻辑)
        const endTimeString = timer.getAttribute('data-endtime');
        
        // 长期有效
        if (!endTimeString || endTimeString === 'null' || endTimeString === 'undefined') {
            timer.innerText = '长期有效';
            timer.classList.add('active-badge');
            return;
        }
        
        // 计时逻辑
        const diff = new Date(endTimeString).getTime() - now;
        
        // 先移除所有状态类，准备应用新的
        timer.classList.remove('active-badge', 'urgent-badge');

        if (diff <= 0) {
            timer.innerText = '已结束';
            // 检查是否应该重绘（活动过期）
            if(window.renderActivities) window.renderActivities(); 
        } else {
            timer.innerText = `剩余 ${formatTime(diff)}`;
            
            if (diff < ONE_DAY) {
                // 不足 24 小时：紧急高亮 (urgent-badge)
                timer.classList.add('urgent-badge');
            } else if (diff < THREE_DAYS) {
                 // 不足 3 天：次级活跃高亮 (active-badge)
                timer.classList.add('active-badge');
            }
        }
    });
}

function startCountdownUpdater() {
    // 首次执行，确保立即更新
    updateCountdowns();
    // 注册定时器，每秒更新
    setInterval(updateCountdowns, 1000);
}
    </script>

</body>
</html>
