name: Update Airtable Data and Deploy Pages

on:
  push:
    branches:
      - main # 1. 当您推送到 main 分支时触发
  workflow_dispatch: # 2. 允许您在 GitHub Actions 页面手动触发
  schedule:
    - cron: '0 0 * * *' # 3. 每天凌晨0点 (UTC时间) 自动运行

# 权限设置：允许读写代码和部署页面
permissions:
  contents: write # 允许 Action 修改仓库内容 (写入 activities.json)
  pages: write  
  id-token: write 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }} # 部署后输出 URL

    steps:
      # 步骤 1: 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: false # 我们将使用 GITHUB_TOKEN

      # 步骤 2: 设置 Node.js 环境
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' 
      
      # 步骤 3: 安装依赖 (package.json 中的 node-fetch)
      - name: Install dependencies
        run: npm install

      # ----------------------------------------------------
      # 步骤 4: 运行脚本从 Airtable 获取数据
      # ----------------------------------------------------
      - name: Fetch data from Airtable and save as JSON
        run: node fetch-data.js
        env:
          # 使用您在 GitHub Settings -> Secrets 中设置的密钥
          # 这会传递给 fetch-data.js 中的 process.env.AIRTABLE_PAT
          AIRTABLE_PAT: ${{ secrets.AIRTABLE_PAT }} 
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}

      # ----------------------------------------------------
      # 步骤 5: 提交更新后的 activities.json
      # ----------------------------------------------------
      - name: Commit and push if data changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 检查 activities.json 是否有变化
          if ! git diff --quiet activities.json; then
            echo "Data changed. Committing new activities.json..."
            git add activities.json
            git commit -m "chore: [CI] 自动更新 Airtable 活动数据"
            # 使用 GITHUB_TOKEN 推送
            git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref_name }}
          else
            echo "No data changes detected in activities.json."
          fi

      # ----------------------------------------------------
      # 步骤 6: 部署到 GitHub Pages
      # ----------------------------------------------------
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        # 上传当前目录下所有文件，包括新生成的 activities.json 和所有 HTML 页面
        uses: actions/upload-pages-artifact@v4
        with:
          path: . 

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
