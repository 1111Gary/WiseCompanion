# .github/workflows/deploy_with_secrets.yml
name: Inject Secrets and Deploy

on:
  push:
    branches:
      - main  # 确保这里是您的主分支名称
  workflow_dispatch: # 允许手动触发

# ----------------------------------------------------
# ✅ 权限声明 - 关键修正
# ----------------------------------------------------
permissions:
  contents: read
  pages: write    # 允许写入 Pages
  id-token: write # 允许写入 ID Token 

jobs:
  build-and-deploy:
    
    runs-on: ubuntu-latest
    
    # ✅ 部署环境声明 - 关键修正
    environment:
      name: github-pages
      # url: ${{ steps.deployment.outputs.page_url }} # 可以在步骤中获取，这里不是必须的

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # ⚠️ 注入 Secrets - 存在严重安全风险！
      # 您的 Airtable PAT 将被硬编码到 list.js 并公开在互联网上！
      # 建议使用 Serverless Function 或代理来保护您的 Secrets。
      # ----------------------------------------------------
      - name: Inject Airtable Secrets into list.js
        run: |
          # 替换 PAT
          sed -i "s|<AIRTABLE_PAT>|${{ secrets.AIRTABLE_PAT }}|g" list.js
          # 替换 BASE_ID
          sed -i "s|<AIRTABLE_BASE_ID>|${{ secrets.AIRTABLE_BASE_ID }}|g" list.js
          
        # 注意：这里的 env 块是多余的，Secrets 已经在 run 块中通过 ${{ secrets.NAME }} 访问了。
        # 移除多余的 env 块

      # ----------------------------------------------------
      # 📦 部署 Pages
      # ----------------------------------------------------
      
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          # 🚨 优化点：路径设置为 '.' 表示上传整个根目录。
          # 如果您有构建步骤，请将路径更改为构建输出目录，例如: 'dist' 或 'build'
          path: . 

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
