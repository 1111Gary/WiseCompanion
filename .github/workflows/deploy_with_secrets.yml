# .github/workflows/deploy_with_secrets.yml
name: Inject Secrets and Deploy

on:
  push:
    branches:
      - main  # ç¡®ä¿è¿™é‡Œæ˜¯æ‚¨çš„ä¸»åˆ†æ”¯åç§°
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

# ----------------------------------------------------
# âœ… æƒé™å£°æ˜ - å…³é”®ä¿®æ­£
# ----------------------------------------------------
permissions:
  contents: read
  pages: write    # å…è®¸å†™å…¥ Pages
  id-token: write # å…è®¸å†™å…¥ ID Token 

jobs:
  build-and-deploy:
    
    runs-on: ubuntu-latest
    
    # âœ… éƒ¨ç½²ç¯å¢ƒå£°æ˜ - å…³é”®ä¿®æ­£
    environment:
      name: github-pages
      # url: ${{ steps.deployment.outputs.page_url }} # å¯ä»¥åœ¨æ­¥éª¤ä¸­è·å–ï¼Œè¿™é‡Œä¸æ˜¯å¿…é¡»çš„

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # âš ï¸ æ³¨å…¥ Secrets - å­˜åœ¨ä¸¥é‡å®‰å…¨é£é™©ï¼
      # æ‚¨çš„ Airtable PAT å°†è¢«ç¡¬ç¼–ç åˆ° list.js å¹¶å…¬å¼€åœ¨äº’è”ç½‘ä¸Šï¼
      # å»ºè®®ä½¿ç”¨ Serverless Function æˆ–ä»£ç†æ¥ä¿æŠ¤æ‚¨çš„ Secretsã€‚
      # ----------------------------------------------------
      - name: Inject Airtable Secrets into list.js
        run: |
          # æ›¿æ¢ PAT
          sed -i "s|<AIRTABLE_PAT>|${{ secrets.AIRTABLE_PAT }}|g" list.js
          # æ›¿æ¢ BASE_ID
          sed -i "s|<AIRTABLE_BASE_ID>|${{ secrets.AIRTABLE_BASE_ID }}|g" list.js
          
        # æ³¨æ„ï¼šè¿™é‡Œçš„ env å—æ˜¯å¤šä½™çš„ï¼ŒSecrets å·²ç»åœ¨ run å—ä¸­é€šè¿‡ ${{ secrets.NAME }} è®¿é—®äº†ã€‚
        # ç§»é™¤å¤šä½™çš„ env å—

      # ----------------------------------------------------
      # ğŸ“¦ éƒ¨ç½² Pages
      # ----------------------------------------------------
      
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          # ğŸš¨ ä¼˜åŒ–ç‚¹ï¼šè·¯å¾„è®¾ç½®ä¸º '.' è¡¨ç¤ºä¸Šä¼ æ•´ä¸ªæ ¹ç›®å½•ã€‚
          # å¦‚æœæ‚¨æœ‰æ„å»ºæ­¥éª¤ï¼Œè¯·å°†è·¯å¾„æ›´æ”¹ä¸ºæ„å»ºè¾“å‡ºç›®å½•ï¼Œä¾‹å¦‚: 'dist' æˆ– 'build'
          path: . 

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
