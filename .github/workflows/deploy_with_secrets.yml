name: Deploy Static Pages

on:
  push:
    branches:
      - main  # ç¡®ä¿è¿™æ˜¯æ‚¨çš„ä¸»åˆ†æ”¯
  workflow_dispatch:

# ----------------------------------------------------
# âœ… æƒé™å£°æ˜ - ç¡®ä¿éƒ¨ç½²å’Œ OIDC ä»¤ç‰Œå†™å…¥æƒé™
# ----------------------------------------------------
permissions:
  contents: read
  pages: write    
  id-token: write 

jobs:
  build-and-deploy:
    
    runs-on: ubuntu-latest
    
    # ğŸš¨ éƒ¨ç½²ç¯å¢ƒå£°æ˜
    environment:
      name: github-pages
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. å¯†é’¥æ³¨å…¥ï¼ˆä¿ç•™æ‚¨çš„é€»è¾‘ï¼Œä½†è¯·æ³¨æ„å®‰å…¨é£é™©ï¼‰
      # ----------------------------------------------------
      - name: Inject Airtable Secrets into list.js
        # ä½¿ç”¨ cat å‘½ä»¤æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨åŠå†…å®¹ï¼Œä»¥ä¾¿è°ƒè¯•
        run: |
          if [ ! -f list.js ]; then
            echo "Error: list.js not found in the root directory!"
            exit 1
          fi
          
          # æ›¿æ¢ PAT
          sed -i "s|<AIRTABLE_PAT>|${{ secrets.AIRTABLE_PAT }}|g" list.js
          # æ›¿æ¢ BASE_ID
          sed -i "s|<AIRTABLE_BASE_ID>|${{ secrets.AIRTABLE_BASE_ID }}|g" list.js
          echo "Secrets injected into list.js successfully."

      # ----------------------------------------------------
      # 2. éƒ¨ç½² Pages æ­¥éª¤
      # ----------------------------------------------------
      - name: Setup Pages
        # å¿…é¡»å…ˆé…ç½®ç¯å¢ƒ
        uses: actions/configure-pages@v5

      - name: Upload artifact
        # ä¸Šä¼ æ•´ä¸ªæ ¹ç›®å½•ä½œä¸ºéƒ¨ç½²å†…å®¹
        uses: actions/upload-pages-artifact@v4
        with:
          # è·¯å¾„è®¾ç½®ä¸º '.' è¡¨ç¤ºä¸Šä¼  index.html, list.js ç­‰æ‰€æœ‰æ ¹ç›®å½•æ–‡ä»¶
          path: . 

      - name: Deploy to GitHub Pages
        id: deployment
        # æœ€åä¸€æ­¥ï¼Œéƒ¨ç½²ä¸Šä¼ çš„ artifact
        uses: actions/deploy-pages@v4
