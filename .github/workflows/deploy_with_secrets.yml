name: Deploy Static Pages

on:
  push:
    branches:
      - main  # ç¡®ä¿è¿™æ˜¯æ‚¨çš„ä¸»åˆ†æ”¯
  workflow_dispatch:

# ----------------------------------------------------
# æƒé™å£°æ˜
# ----------------------------------------------------
permissions:
  contents: read
  pages: write    
  id-token: write 

jobs:
  build-and-deploy:
    
    runs-on: ubuntu-latest
    
    # ğŸš¨ éƒ¨ç½²ç¯å¢ƒå£°æ˜
    environment:
      name: github-pages
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. éƒ¨ç½²å‰å‡†å¤‡ Node.js ç¯å¢ƒ
      # ----------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # æ¨èä½¿ç”¨ LTS ç‰ˆæœ¬
      
      # âš ï¸ å®‰è£… node-fetch åº“
      - name: Install dependencies (for node-fetch)
        run: npm install node-fetch

      # ----------------------------------------------------
      # 2. è¿è¡Œè„šæœ¬è·å–æ•°æ®
      # ----------------------------------------------------
      - name: Fetch data from Airtable and save as JSON
        run: node fetch-data.js
        env:
          # å°† Secrets ä½œä¸ºç¯å¢ƒå˜é‡å®‰å…¨åœ°ä¼ é€’ç»™ Node.js è„šæœ¬
          AIRTABLE_PAT: ${{ secrets.AIRTABLE_PAT }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}

      # ----------------------------------------------------
      # 3. éƒ¨ç½² Pages æ­¥éª¤
      # ----------------------------------------------------
      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        # ä¸Šä¼ æ•´ä¸ªæ ¹ç›®å½•ä½œä¸ºéƒ¨ç½²å†…å®¹ï¼Œç°åœ¨åŒ…å«äº† activities.json
        uses: actions/upload-pages-artifact@v4
        with:
          path: . 

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
